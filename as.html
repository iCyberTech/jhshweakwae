<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Assessment Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-color: rgba(108, 92, 231, 0.9);
            --secondary-color: rgba(162, 155, 254, 0.9);
            --text-color: rgba(45, 52, 54, 0.9);
            --light-text: rgba(99, 110, 114, 0.8);
            --glass-bg: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-blur: 16px;
            --success-color: rgba(0, 184, 148, 0.9);
            --danger-color: rgba(214, 48, 49, 0.9);
            --warning-color: rgba(253, 203, 110, 0.9);
            --info-color: rgba(9, 132, 227, 0.9);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .header-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .teacher-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 15px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .teacher-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .teacher-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            overflow-x: auto;
            padding: 10px 5px;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 12px 24px;
            background: var(--glass-bg);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            box-shadow: 0 6px 12px rgba(108, 92, 231, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(108, 92, 231, 0.15);
            transform: translateY(-2px);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-section.active {
            display: block;
        }

        .subjects-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .subject-card {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            transition: all var(--transition-speed) ease;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .subject-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.3);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .subject-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .subject-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 4px 8px rgba(108, 92, 231, 0.3);
        }

        .class-info {
            margin-top: 15px;
        }

        .class-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .schedule {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 12px;
        }

        .days {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap;
        }

        .day {
            background: rgba(108, 92, 231, 0.15);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(108, 92, 231, 0.2);
        }

        .time {
            font-weight: 600;
            color: var(--success-color);
            font-size: 0.9rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn {
            padding: 10px 18px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-speed) ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(108, 92, 231, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(90, 75, 209, 0.9) 0%, rgba(142, 134, 222, 0.9) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(108, 92, 231, 0.4);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .btn-outline:hover {
            background: rgba(108, 92, 231, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(108, 92, 231, 0.2);
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: var(--glass-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
        }

        .students-table th, 
        .students-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .students-table th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .students-table tr:hover {
            background: rgba(108, 92, 231, 0.08);
        }

        .students-table tr:last-child td {
            border-bottom: none;
        }

        .student-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            vertical-align: middle;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-grade {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            font-weight: 500;
            transition: all var(--transition-speed) ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .input-grade:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
        }

        .grade-form {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-top: 25px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            font-size: 1rem;
            transition: all var(--transition-speed) ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(108, 92, 231, 0.1);
            border-top: 6px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .loading-text {
            font-size: 1.3rem;
            color: var(--text-color);
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 50px;
            background: var(--glass-bg);
            border-radius: 16px;
            margin-top: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .no-data i {
            font-size: 2.5rem;
            color: var(--light-text);
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .no-data h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .no-data p {
            font-size: 1rem;
            color: var(--light-text);
        }

        .back-btn {
            margin-bottom: 25px;
            transition: all var(--transition-speed) ease;
        }

        .back-btn:hover {
            transform: translateX(-3px);
        }

        .grade-summary {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .grade-summary h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.4rem;
        }

        .grade-summary p {
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
        }

        .grade-summary strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .grade-weight {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .total-grade {
            font-weight: 700;
            color: var(--primary-color);
        }

        .letter-grade {
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Notification styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-width: 90%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            position: relative;
            padding: 16px 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transform: translateX(120%);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(120%);
            opacity: 0;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .notification.info {
            background-color: var(--info-color);
        }

        .notification-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            opacity: 0.9;
        }

        .notification-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            margin-left: 15px;
            font-size: 18px;
            opacity: 0.8;
        }

        /* Homework specific styles */
        .homework-item {
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .homework-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .homework-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .homework-description {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .homework-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85rem;
        }

        .file-upload-container {
            margin-top: 15px;
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .file-upload-container:hover {
            border-color: var(--primary-color);
            background: rgba(108, 92, 231, 0.05);
        }

        .file-upload-container i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .file-upload-container p {
            margin-bottom: 5px;
        }

        .file-upload-container small {
            color: var(--light-text);
        }

        #file-input {
            display: none;
        }

        .file-preview {
            margin-top: 15px;
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .file-preview i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-name {
            font-weight: 500;
        }

        .file-preview-size {
            font-size: 0.8rem;
            color: var(--light-text);
        }

        .remove-file {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
        }

        .submission-item {
            background: var(--glass-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--glass-border);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .submission-student {
            font-weight: 600;
        }

        .submission-date {
            color: var(--light-text);
            font-size: 0.85rem;
        }

        .submission-content {
            margin-bottom: 10px;
        }

        .submission-file {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 8px;
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(108, 92, 231, 0.2);
        }

        .submission-file i {
            margin-right: 5px;
        }

        .submission-grade {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .grade-form {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .grade-display {
            font-weight: 600;
            color: var(--success-color);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--glass-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Real-time notification */
        .real-time-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--glass-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .real-time-notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .real-time-notification.success i {
            color: var(--success-color);
        }

        .real-time-notification.error i {
            color: var(--danger-color);
        }

        /* Responsive styles */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .subjects-container {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 992px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px;
            }
            
            .teacher-info {
                width: 100%;
                justify-content: flex-end;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        @media (max-width: 768px) {
            .header-title {
                font-size: 1.5rem;
            }
            
            .subjects-container {
                grid-template-columns: 1fr;
            }
            
            .students-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .grade-form {
                padding: 20px;
            }
            
            .students-table th, 
            .students-table td {
                padding: 12px 15px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        @media (max-width: 576px) {
            :root {
                --glass-blur: 10px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header-title {
                font-size: 1.3rem;
            }
            
            .teacher-info {
                padding: 6px 12px;
            }
            
            .teacher-avatar {
                width: 38px;
                height: 38px;
            }
            
            .teacher-name {
                font-size: 0.9rem;
            }
            
            .tabs {
                gap: 8px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
            
            .subject-card {
                padding: 15px;
            }
            
            .subject-name {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 0.9rem;
            }
            
            .no-data {
                padding: 30px 20px;
            }
            
            .no-data i {
                font-size: 2rem;
            }
            
            .no-data h3 {
                font-size: 1.3rem;
            }

            .modal-content {
                padding: 15px;
            }

            .modal-footer {
                flex-direction: column;
            }

            .modal-footer .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 400px) {
            .header-title {
                font-size: 1.2rem;
            }
            
            .teacher-info {
                padding: 5px 10px;
            }
            
            .teacher-avatar {
                width: 35px;
                height: 35px;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .subject-icon {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .input-grade {
                width: 70px;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Teacher Portal...</div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Real-time Notification -->
    <div class="real-time-notification" id="real-time-notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message">Notification message</span>
    </div>

    <!-- Main Content -->
    <div class="container" id="main-content" style="display: none;">
        <!-- Header -->
        <header>
            <h1 class="header-title">Teacher Assessment Portal</h1>
            <div class="teacher-info">
                <img id="teacher-avatar" src="" alt="Teacher" class="teacher-avatar">
                <span class="teacher-name" id="teacher-name">Loading...</span>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="subjects">My Subjects</div>
            <div class="tab" data-tab="grades">Enter Grades</div>
            <div class="tab" data-tab="published">Published Grades</div>
            <div class="tab" data-tab="homework">Homework</div>
        </div>

        <!-- Subjects Tab -->
        <div class="content-section active" id="subjects-tab">
            <div class="subjects-container" id="subjects-container">
                <!-- Subjects will be dynamically inserted here -->
            </div>

            <div id="no-subjects" class="no-data" style="display: none;">
                <i class="fas fa-book-open"></i>
                <h3>No Subjects Assigned</h3>
                <p>You currently don't have any subjects assigned to you.</p>
            </div>
        </div>

        <!-- Grades Tab -->
        <div class="content-section" id="grades-tab">
            <div id="grade-selection">
                <div class="form-group">
                    <label for="subject-select">Select Subject</label>
                    <select id="subject-select" class="form-control">
                        <option value="">-- Select Subject --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="class-select">Select Class</label>
                    <select id="class-select" class="form-control">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="term-select">Select Term</label>
                    <select id="term-select" class="form-control">
                        <option value="Term 1">Term 1</option>
                        <option value="Term 2">Term 2</option>
                        <option value="Term 3">Term 3</option>
                    </select>
                </div>
                
                <button id="load-students-btn" class="btn btn-primary">
                    <i class="fas fa-users"></i> Load Students
                </button>
            </div>
            
            <div id="grade-form-container" style="display: none;">
                <button id="back-to-selection" class="btn btn-outline back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Selection
                </button>
                
                <div class="grade-summary">
                    <h3 id="grade-summary-title">Grade Summary</h3>
                    <p><strong>Subject:</strong> <span id="current-subject"></span></p>
                    <p><strong>Class:</strong> <span id="current-class"></span></p>
                    <p><strong>Term:</strong> <span id="current-term"></span></p>
                    <p class="grade-weight"><strong>Grading Weights:</strong> 
                        <span id="grade-weights">Loading weights...</span>
                    </p>
                </div>
                
                <div class="grade-form">
                    <h3>Enter Student Grades</h3>
                    <table class="students-table" id="students-grade-table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Assignments</th>
                                <th>Projects</th>
                                <th>Class Score</th>
                                <th>Final Exam</th>
                                <th>Total</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Student rows will be inserted here -->
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button id="save-grades-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Grades
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="no-grade-data" class="no-data" style="display: none;">
                <i class="fas fa-graduation-cap"></i>
                <h3>No Students Found</h3>
                <p>Please select a subject and class to view students.</p>
            </div>
        </div>

        <!-- Published Grades Tab -->
        <div class="content-section" id="published-tab">
            <div id="published-grades-container">
                <!-- Published grades will be inserted here -->
            </div>
            
            <div id="no-published-grades" class="no-data" style="display: none;">
                <i class="fas fa-chart-bar"></i>
                <h3>No Published Grades</h3>
                <p>You haven't published any grades yet.</p>
            </div>
        </div>

        <!-- Homework Tab -->
        <div class="content-section" id="homework-tab">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Create New Homework</div>
                </div>
                <div class="card-body">
                    <form id="homework-form">
                        <div class="form-group">
                            <label for="homework-subject" class="form-label">Subject</label>
                            <select id="homework-subject" class="form-control" required>
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="homework-class" class="form-label">Class</label>
                            <select id="homework-class" class="form-control" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="homework-title" class="form-label">Title</label>
                            <input type="text" id="homework-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="homework-description" class="form-label">Description</label>
                            <textarea id="homework-description" class="form-control" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="homework-due-date" class="form-label">Due Date</label>
                            <input type="date" id="homework-due-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Attachments (Optional)</label>
                            <div class="file-upload-container" id="file-upload-container">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload files</p>
                                <small>PDF, DOCX, PPTX, JPG, PNG (Max 10MB)</small>
                                <input type="file" id="file-input" multiple>
                            </div>
                            <div id="file-preview-container"></div>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Create Homework</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Assigned Homework</div>
                </div>
                <div class="card-body">
                    <div id="homework-list">
                        <!-- Homework items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Homework Detail Modal -->
    <div class="modal" id="homework-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="homework-modal-title">Homework Details</div>
                <button class="close-modal" id="close-homework-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <p id="modal-homework-subject"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Class</label>
                    <p id="modal-homework-class"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <p id="modal-homework-title"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p id="modal-homework-description"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <p id="modal-homework-due-date"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <p id="modal-homework-status"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Attachments</label>
                    <div id="modal-homework-files"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Submissions</label>
                    <div id="modal-homework-submissions"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="delete-homework-btn"><i class="fas fa-trash"></i> Delete</button>
                <button class="btn btn-primary" id="edit-homework-btn"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-secondary close-modal"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Homework Modal -->
    <div class="modal" id="edit-homework-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Homework</div>
                <button class="close-modal" id="close-edit-homework-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-homework-form">
                    <input type="hidden" id="edit-homework-id">
                    <div class="form-group">
                        <label for="edit-homework-title" class="form-label">Title</label>
                        <input type="text" id="edit-homework-title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-homework-description" class="form-label">Description</label>
                        <textarea id="edit-homework-description" class="form-control" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-homework-due-date" class="form-label">Due Date</label>
                        <input type="date" id="edit-homework-due-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Attachments</label>
                        <div id="edit-homework-files"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Add New Attachments</label>
                        <div class="file-upload-container" id="edit-file-upload-container">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload additional files</p>
                            <small>PDF, DOCX, PPTX, JPG, PNG (Max 10MB)</small>
                            <input type="file" id="edit-file-input" multiple>
                        </div>
                        <div id="edit-file-preview-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-homework-btn"><i class="fas fa-save"></i> Save Changes</button>
                <button class="btn btn-secondary close-modal"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkrHsyfCTijqKP7UJv0eSx0iNvl8S06U8",
            authDomain: "sms-single.firebaseapp.com",
            projectId: "sms-single",
            storageBucket: "sms-single.appspot.com",
            messagingSenderId: "140188895278",
            appId: "1:140188895278:web:1b56660a13e5b088ce77bf",
            measurementId: "G-7ER348P6VZ"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const teacherName = document.getElementById('teacher-name');
        const teacherAvatar = document.getElementById('teacher-avatar');
        const tabs = document.querySelectorAll('.tab');
        const contentSections = document.querySelectorAll('.content-section');
        const notificationContainer = document.getElementById('notification-container');
        
        // Subjects elements
        const subjectsContainer = document.getElementById('subjects-container');
        const noSubjects = document.getElementById('no-subjects');
        
        // Grades elements
        const subjectSelect = document.getElementById('subject-select');
        const classSelect = document.getElementById('class-select');
        const termSelect = document.getElementById('term-select');
        const loadStudentsBtn = document.getElementById('load-students-btn');
        const gradeFormContainer = document.getElementById('grade-form-container');
        const backToSelection = document.getElementById('back-to-selection');
        const currentSubject = document.getElementById('current-subject');
        const currentClass = document.getElementById('current-class');
        const currentTerm = document.getElementById('current-term');
        const gradeWeights = document.getElementById('grade-weights');
        const studentsGradeTable = document.getElementById('students-grade-table');
        const saveGradesBtn = document.getElementById('save-grades-btn');
        const noGradeData = document.getElementById('no-grade-data');
        
        // Published grades elements
        const publishedGradesContainer = document.getElementById('published-grades-container');
        const noPublishedGrades = document.getElementById('no-published-grades');
        
        // Homework elements
        const homeworkForm = document.getElementById('homework-form');
        const homeworkSubjectSelect = document.getElementById('homework-subject');
        const homeworkClassSelect = document.getElementById('homework-class');
        const homeworkTitleInput = document.getElementById('homework-title');
        const homeworkDescriptionInput = document.getElementById('homework-description');
        const homeworkDueDateInput = document.getElementById('homework-due-date');
        const homeworkList = document.getElementById('homework-list');
        const fileUploadContainer = document.getElementById('file-upload-container');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        
        // Modal elements
        const homeworkDetailModal = document.getElementById('homework-detail-modal');
        const homeworkModalTitle = document.getElementById('homework-modal-title');
        const modalHomeworkSubject = document.getElementById('modal-homework-subject');
        const modalHomeworkClass = document.getElementById('modal-homework-class');
        const modalHomeworkTitle = document.getElementById('modal-homework-title');
        const modalHomeworkDescription = document.getElementById('modal-homework-description');
        const modalHomeworkDueDate = document.getElementById('modal-homework-due-date');
        const modalHomeworkStatus = document.getElementById('modal-homework-status');
        const modalHomeworkFiles = document.getElementById('modal-homework-files');
        const modalHomeworkSubmissions = document.getElementById('modal-homework-submissions');
        const closeHomeworkModal = document.getElementById('close-homework-modal');
        const deleteHomeworkBtn = document.getElementById('delete-homework-btn');
        const editHomeworkBtn = document.getElementById('edit-homework-btn');
        
        const editHomeworkModal = document.getElementById('edit-homework-modal');
        const closeEditHomeworkModal = document.getElementById('close-edit-homework-modal');
        const editHomeworkForm = document.getElementById('edit-homework-form');
        const editHomeworkId = document.getElementById('edit-homework-id');
        const editHomeworkTitle = document.getElementById('edit-homework-title');
        const editHomeworkDescription = document.getElementById('edit-homework-description');
        const editHomeworkDueDate = document.getElementById('edit-homework-due-date');
        const editHomeworkFiles = document.getElementById('edit-homework-files');
        const editFileUploadContainer = document.getElementById('edit-file-upload-container');
        const editFileInput = document.getElementById('edit-file-input');
        const editFilePreviewContainer = document.getElementById('edit-file-preview-container');
        const saveHomeworkBtn = document.getElementById('save-homework-btn');
        
        // Global variables
        let currentTeacherId = null;
        let currentTeacherData = null;
        let teacherSubjects = [];
        let teacherClasses = [];
        let allClasses = {};
        let allStudents = {};
        let allSubjects = {};
        let currentHomeworkId = null;
        let currentGrades = {};
        let currentFiles = [];
        let newFilesToUpload = [];
        let currentGradingContext = {
            subjectId: null,
            classId: null,
            term: null
        };

        // Initialize Select2
        $(document).ready(function() {
            $('select').select2({
                width: '100%'
            });
        });

        // Event Listeners
        tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });
        
        loadStudentsBtn.addEventListener('click', loadStudentsForGrading);
        backToSelection.addEventListener('click', backToGradeSelection);
        saveGradesBtn.addEventListener('click', saveAllGrades);
        
        homeworkForm.addEventListener('submit', createHomework);
        
        // File upload events
        fileUploadContainer.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        editFileUploadContainer.addEventListener('click', () => editFileInput.click());
        editFileInput.addEventListener('change', handleEditFileSelect);
        
        // Modal events
        closeHomeworkModal.addEventListener('click', () => homeworkDetailModal.style.display = 'none');
        closeEditHomeworkModal.addEventListener('click', () => editHomeworkModal.style.display = 'none');
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        deleteHomeworkBtn.addEventListener('click', deleteHomework);
        editHomeworkBtn.addEventListener('click', openEditHomeworkModal);
        saveHomeworkBtn.addEventListener('click', saveHomeworkChanges);
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === homeworkDetailModal) {
                homeworkDetailModal.style.display = 'none';
            }
            if (e.target === editHomeworkModal) {
                editHomeworkModal.style.display = 'none';
            }
        });

        // Functions
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fa-info-circle';
            let title = 'Information';
            
            switch(type) {
                case 'success':
                    icon = 'fa-check-circle';
                    title = 'Success';
                    break;
                case 'error':
                    icon = 'fa-exclamation-circle';
                    title = 'Error';
                    break;
                case 'warning':
                    icon = 'fa-exclamation-triangle';
                    title = 'Warning';
                    break;
            }
            
            notification.innerHTML = `
                <i class="fas ${icon} notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Close button event
            notification.querySelector('.notification-close').addEventListener('click', () => {
                closeNotification(notification);
            });
            
            // Auto close after duration
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(notification);
                }, duration);
            }
            
            return notification;
        }
        
        function closeNotification(notification) {
            notification.classList.remove('show');
            notification.classList.add('hide');
            
            setTimeout(() => {
                notification.remove();
            }, 300);
        }

        function switchTab(tabId) {
            // Update active tab
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update active content
            contentSections.forEach(section => {
                if (section.id === `${tabId}-tab`) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
            
            // Load data for the tab if needed
            if (tabId === 'published') {
                loadPublishedGrades();
            } else if (tabId === 'homework') {
                loadHomework();
            }
        }

        async function identifyCurrentTeacher() {
            try {
                // First try to get from activeSessions
                const activeSessionSnapshot = await database.ref('activeSessions/teacher').once('value');
                if (activeSessionSnapshot.exists()) {
                    currentTeacherId = activeSessionSnapshot.val();
                    const teacherSnapshot = await database.ref(`teachers/${currentTeacherId}`).once('value');
                    
                    if (teacherSnapshot.exists()) {
                        currentTeacherData = teacherSnapshot.val();
                        return currentTeacherData;
                    }
                }
                
                // Fallback to device identification if active session not found
                const authUsersSnapshot = await database.ref('authUsers').once('value');
                if (!authUsersSnapshot.exists()) {
                    throw new Error('No auth users found');
                }
                
                const authUsers = authUsersSnapshot.val();
                const credentialsSnapshot = await database.ref('credentials').once('value');
                const credentials = credentialsSnapshot.exists() ? credentialsSnapshot.val() : {};
                
                // Get current device info from browser
                const userAgent = navigator.userAgent;
                const screenResolution = `${window.screen.width}x${window.screen.height}`;
                const language = navigator.language;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // Find matching teacher based on device info
                for (const [authId, authUser] of Object.entries(authUsers)) {
                    if (authUser.userType === 'teacher') {
                        const teacherCredential = credentials[authUser.userId];
                        if (teacherCredential && teacherCredential.deviceInfo) {
                            const deviceInfo = teacherCredential.deviceInfo;
                            
                            // Check for matching device characteristics
                            if (deviceInfo.userAgent === userAgent && 
                                deviceInfo.screenResolution === screenResolution &&
                                deviceInfo.language === language && 
                                deviceInfo.timezone === timezone) {
                                
                                // This is likely the current teacher
                                currentTeacherId = authUser.userId;
                                
                                // Get teacher details from teachers collection
                                const teacherSnapshot = await database.ref(`teachers/${currentTeacherId}`).once('value');
                                
                                if (teacherSnapshot.exists()) {
                                    currentTeacherData = teacherSnapshot.val();
                                    return currentTeacherData;
                                }
                            }
                        }
                    }
                }
                
                throw new Error('No matching teacher found');
            } catch (error) {
                console.error('Error identifying teacher:', error);
                showNotification('Failed to identify teacher: ' + error.message, 'error');
                return null;
            }
        }

        function checkAuthState() {
            auth.onAuthStateChanged(async user => {
                if (user) {
                    try {
                        const teacher = await identifyCurrentTeacher();
                        if (teacher) {
                            loadTeacherData(teacher);
                            loadTeacherSubjects();
                            loadClasses();
                            loadStudents();
                            
                            // Hide loading screen and show main content
                            loadingScreen.style.display = 'none';
                            mainContent.style.display = 'block';
                        } else {
                            // If teacher not found, redirect to login
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error('Error checking active session:', error);
                        window.location.href = 'login.html';
                    }
                } else {
                    // No user is signed in, redirect to login
                    window.location.href = 'login.html';
                }
            });
        }

        function loadTeacherData(teacher) {
            currentTeacherData = teacher;
            
            if (currentTeacherData) {
                // Update UI with teacher data
                teacherName.textContent = currentTeacherData.name;
                
                if (currentTeacherData.profileImage) {
                    teacherAvatar.src = currentTeacherData.profileImage;
                } else {
                    teacherAvatar.src = "https://randomuser.me/api/portraits/women/44.jpg";
                }
            }
        }

        function loadTeacherSubjects() {
            const subjectsRef = database.ref('subjects');
            
            subjectsRef.once('value').then(snapshot => {
                allSubjects = snapshot.val() || {};
                teacherSubjects = [];
                
                for (const subjectId in allSubjects) {
                    const subject = allSubjects[subjectId];
                    if (subject.teacher === currentTeacherId) {
                        teacherSubjects.push({
                            id: subjectId,
                            ...subject
                        });
                    }
                }
                
                // Display subjects
                displayTeacherSubjects();
                
                // Populate subject dropdowns
                populateSubjectDropdowns();
                
                // Load teacher's classes based on subjects
                loadTeacherClasses();
            });
        }

        function displayTeacherSubjects() {
            subjectsContainer.innerHTML = '';
            
            if (teacherSubjects.length === 0) {
                noSubjects.style.display = 'block';
                return;
            }
            
            noSubjects.style.display = 'none';
            
            // Group subjects by class
            const classesMap = {};
            
            teacherSubjects.forEach(subject => {
                if (!subject.class) return;
                
                if (!classesMap[subject.class]) {
                    classesMap[subject.class] = {
                        classId: subject.class,
                        className: allClasses[subject.class]?.name || `Class ${subject.class}`,
                        subjects: []
                    };
                }
                
                classesMap[subject.class].subjects.push({
                    id: subject.id,
                    name: subject.name,
                    schedule: subject.schedule
                });
            });
            
            // Create cards for each subject
            for (const classId in classesMap) {
                const classInfo = classesMap[classId];
                
                classInfo.subjects.forEach(subject => {
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'subject-card';
                    
                    const subjectIcon = document.createElement('div');
                    subjectIcon.className = 'subject-icon';
                    subjectIcon.innerHTML = '<i class="fas fa-book"></i>';
                    
                    const subjectHeader = document.createElement('div');
                    subjectHeader.className = 'subject-header';
                    subjectHeader.innerHTML = `
                        <h3 class="subject-name">${subject.name}</h3>
                    `;
                    subjectHeader.appendChild(subjectIcon);
                    
                    const classInfoDiv = document.createElement('div');
                    classInfoDiv.className = 'class-info';
                    classInfoDiv.innerHTML = `
                        <div class="class-name">${classInfo.className}</div>
                    `;
                    
                    if (subject.schedule) {
                        const scheduleDiv = document.createElement('div');
                        scheduleDiv.className = 'schedule';
                        
                        if (subject.schedule.days) {
                            const daysDiv = document.createElement('div');
                            daysDiv.className = 'days';
                            
                            subject.schedule.days.forEach(day => {
                                const daySpan = document.createElement('span');
                                daySpan.className = 'day';
                                daySpan.textContent = day;
                                daysDiv.appendChild(daySpan);
                            });
                            
                            scheduleDiv.appendChild(daysDiv);
                        }
                        
                        if (subject.schedule.time) {
                            const timeDiv = document.createElement('div');
                            timeDiv.className = 'time';
                            timeDiv.innerHTML = `<i class="fas fa-clock"></i> ${subject.schedule.time.from} - ${subject.schedule.time.to}`;
                            scheduleDiv.appendChild(timeDiv);
                        }
                        
                        classInfoDiv.appendChild(scheduleDiv);
                    }
                    
                    subjectCard.appendChild(subjectHeader);
                    subjectCard.appendChild(classInfoDiv);
                    
                    subjectsContainer.appendChild(subjectCard);
                });
            }
        }

        function populateSubjectDropdowns() {
            // Clear existing options
            subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
            homeworkSubjectSelect.innerHTML = '<option value="">Select Subject</option>';
            
            // Add subjects
            teacherSubjects.forEach(subject => {
                const option1 = document.createElement('option');
                option1.value = subject.id;
                option1.textContent = subject.name;
                subjectSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = subject.id;
                option2.textContent = subject.name;
                homeworkSubjectSelect.appendChild(option2);
            });
            
            // Refresh Select2
            $(subjectSelect).trigger('change');
            $(homeworkSubjectSelect).trigger('change');
        }

        function loadTeacherClasses() {
            teacherClasses = [];
            const classIds = new Set();
            
            teacherSubjects.forEach(subject => {
                if (subject.class && !classIds.has(subject.class)) {
                    classIds.add(subject.class);
                    teacherClasses.push({
                        classId: subject.class,
                        subjectId: subject.id
                    });
                }
            });
            
            // Populate class dropdowns based on selected subject
            subjectSelect.addEventListener('change', updateClassDropdown);
            homeworkSubjectSelect.addEventListener('change', updateHomeworkClassDropdown);
        }

        function updateClassDropdown() {
            const subjectId = subjectSelect.value;
            classSelect.innerHTML = '<option value="">-- Select Class --</option>';
            
            if (!subjectId) return;
            
            const subject = teacherSubjects.find(s => s.id === subjectId);
            if (subject && subject.class) {
                const option = document.createElement('option');
                option.value = subject.class;
                
                // Find class name from allClasses
                const className = allClasses[subject.class]?.name || `Class ${subject.class}`;
                option.textContent = className;
                
                classSelect.appendChild(option);
            }
            
            $(classSelect).trigger('change');
        }

        function updateHomeworkClassDropdown() {
            const subjectId = homeworkSubjectSelect.value;
            homeworkClassSelect.innerHTML = '<option value="">Select Class</option>';
            
            if (!subjectId) return;
            
            const subject = teacherSubjects.find(s => s.id === subjectId);
            if (subject && subject.class) {
                const option = document.createElement('option');
                option.value = subject.class;
                
                // Find class name from allClasses
                const className = allClasses[subject.class]?.name || `Class ${subject.class}`;
                option.textContent = className;
                
                homeworkClassSelect.appendChild(option);
            }
            
            $(homeworkClassSelect).trigger('change');
        }

        function loadClasses() {
            const classesRef = database.ref('classes');
            
            classesRef.once('value').then(snapshot => {
                allClasses = snapshot.val() || {};
                
                // Also load graduated classes
                const graduatedClassesRef = database.ref('graduatedClasses');
                graduatedClassesRef.once('value').then(gSnapshot => {
                    const graduatedClasses = gSnapshot.val() || {};
                    allClasses = { ...allClasses, ...graduatedClasses };
                    
                    // Update class dropdowns if needed
                    if (subjectSelect.value) {
                        updateClassDropdown();
                    }
                    if (homeworkSubjectSelect.value) {
                        updateHomeworkClassDropdown();
                    }
                });
            });
        }

        function loadStudents() {
            const studentsRef = database.ref('students');
            const oldStudentsRef = database.ref('oldStudents');
            
            Promise.all([
                studentsRef.once('value'),
                oldStudentsRef.once('value')
            ]).then(([studentsSnapshot, oldStudentsSnapshot]) => {
                const currentStudents = studentsSnapshot.val() || {};
                const oldStudents = oldStudentsSnapshot.val() || {};
                
                // Remove the 'classes' property from oldStudents if it exists
                if (oldStudents.classes) {
                    delete oldStudents.classes;
                }
                
                allStudents = { ...currentStudents, ...oldStudents };
            });
        }

        function loadStudentsForGrading() {
            const subjectId = subjectSelect.value;
            const classId = classSelect.value;
            const term = termSelect.value;
            
            if (!subjectId || !classId || !term) {
                showNotification('Please select a subject, class, and term', 'error');
                return;
            }
            
            // Save current grading context
            currentGradingContext = {
                subjectId,
                classId,
                term
            };
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            // Find class name
            const className = allClasses[classId]?.name || `Class ${classId}`;
            
            // Update UI
            currentSubject.textContent = subjectName;
            currentClass.textContent = className;
            currentTerm.textContent = term;
            
            // Get grading weights
            const weightsRef = database.ref('gradingWeights');
            weightsRef.once('value').then(snapshot => {
                const weights = snapshot.val() || {
                    assignments: 20,
                    projects: 20,
                    classScore: 30,
                    finalExam: 30
                };
                
                gradeWeights.textContent = `Assignments: ${weights.assignments}%, Projects: ${weights.projects}%, Class Score: ${weights.classScore}%, Final Exam: ${weights.finalExam}%`;
            });
            
            // First, find all students in this class
            const classInfo = allClasses[classId];
            if (!classInfo || !classInfo.students || classInfo.students.length === 0) {
                studentsGradeTable.querySelector('tbody').innerHTML = '<tr><td colspan="7">No students found in this class.</td></tr>';
                gradeFormContainer.style.display = 'block';
                noGradeData.style.display = 'none';
                return;
            }
            
            // Get existing grades for this subject, class, and term
            const gradesRef = database.ref('grades');
            
            gradesRef.orderByChild('class').equalTo(className).once('value').then(snapshot => {
                const allGrades = snapshot.val() || {};
                currentGrades = {};
                
                // Filter grades for this subject and term
                for (const gradeId in allGrades) {
                    const grade = allGrades[gradeId];
                    if (grade.subject === subjectId && grade.term === term) {
                        currentGrades[grade.studentId] = {
                            gradeId,
                            ...grade
                        };
                    }
                }
                
                // Display students with their grades
                displayStudentsForGrading(classInfo.students, subjectId, term);
                
                // Show the grade form
                gradeFormContainer.style.display = 'block';
                noGradeData.style.display = 'none';
            });
        }

        function displayStudentsForGrading(studentIds, subjectId, term) {
            const tbody = studentsGradeTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (studentIds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No students found in this class.</td></tr>';
                return;
            }
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            studentIds.forEach(studentId => {
                const student = allStudents[studentId];
                if (!student) return;
                
                // Get existing grade if it exists
                const existingGrade = currentGrades[studentId] || {
                    assignments: '',
                    projects: '',
                    classScore: '',
                    finalExam: '',
                    totalScore: '',
                    letterGrade: ''
                };
                
                const row = document.createElement('tr');
                row.dataset.studentId = studentId;
                
                row.innerHTML = `
                    <td>
                        <img src="${student.profileImage || 'https://randomuser.me/api/portraits/lego/1.jpg'}" alt="${student.name}" class="student-avatar">
                        ${student.name}
                    </td>
                    <td><input type="number" class="input-grade" id="assignments-${studentId}" 
                        value="${existingGrade.assignments || ''}" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="input-grade" id="projects-${studentId}" 
                        value="${existingGrade.projects || ''}" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="input-grade" id="classScore-${studentId}" 
                        value="${existingGrade.classScore || ''}" min="0" max="100" step="0.1"></td>
                    <td><input type="number" class="input-grade" id="finalExam-${studentId}" 
                        value="${existingGrade.finalExam || ''}" min="0" max="100" step="0.1"></td>
                    <td id="totalScore-${studentId}">${existingGrade.totalScore || ''}</td>
                    <td id="letterGrade-${studentId}">${existingGrade.letterGrade || ''}</td>
                `;
                
                tbody.appendChild(row);
                
                // Add event listeners to grade inputs for auto-calculation
                document.getElementById(`assignments-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
                document.getElementById(`projects-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
                document.getElementById(`classScore-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
                document.getElementById(`finalExam-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
            });
        }

        function calculateTotalGrade(studentId) {
            const assignments = parseFloat(document.getElementById(`assignments-${studentId}`).value) || 0;
            const projects = parseFloat(document.getElementById(`projects-${studentId}`).value) || 0;
            const classScore = parseFloat(document.getElementById(`classScore-${studentId}`).value) || 0;
            const finalExam = parseFloat(document.getElementById(`finalExam-${studentId}`).value) || 0;
            
            // Get grading weights from settings (default values if not set)
            const weightsRef = database.ref('gradingWeights');
            weightsRef.once('value').then(snapshot => {
                const weights = snapshot.val() || {
                    assignments: 20,
                    projects: 20,
                    classScore: 30,
                    finalExam: 30
                };
                
                // Calculate total score
                const totalScore = (assignments * weights.assignments/100) + 
                                  (projects * weights.projects/100) + 
                                  (classScore * weights.classScore/100) + 
                                  (finalExam * weights.finalExam/100);
                
                // Round to 1 decimal place
                const roundedScore = Math.round(totalScore * 10) / 10;
                
                // Calculate letter grade
                const letterGrade = calculateLetterGrade(roundedScore);
                
                // Update display
                document.getElementById(`totalScore-${studentId}`).textContent = roundedScore;
                document.getElementById(`letterGrade-${studentId}`).textContent = letterGrade;
            });
        }

        function calculateLetterGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        function saveAllGrades() {
            if (!currentGradingContext.classId || !currentGradingContext.subjectId || !currentGradingContext.term) {
                showNotification('Please filter students first', 'error');
                return;
            }
            
            // Get all student rows
            const studentRows = studentsGradeTable.querySelectorAll('tbody tr');
            
            if (studentRows.length === 0) {
                showNotification('No students to save', 'error');
                return;
            }
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === currentGradingContext.subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            // Find class name
            const className = allClasses[currentGradingContext.classId]?.name || `Class ${currentGradingContext.classId}`;
            
            // Save each student's grade
            let saveCount = 0;
            const totalStudents = studentRows.length;
            
            studentRows.forEach(row => {
                const studentId = row.dataset.studentId;
                const student = allStudents[studentId];
                
                if (!student) return;
                
                const assignments = parseFloat(document.getElementById(`assignments-${studentId}`).value) || 0;
                const projects = parseFloat(document.getElementById(`projects-${studentId}`).value) || 0;
                const classScore = parseFloat(document.getElementById(`classScore-${studentId}`).value) || 0;
                const finalExam = parseFloat(document.getElementById(`finalExam-${studentId}`).value) || 0;
                const totalScore = parseFloat(document.getElementById(`totalScore-${studentId}`).textContent) || 0;
                const letterGrade = document.getElementById(`letterGrade-${studentId}`).textContent;
                
                // Prepare grade object
                const grade = {
                    studentId,
                    studentName: student.name,
                    class: className,
                    subject: currentGradingContext.subjectId,
                    subjectName,
                    term: currentGradingContext.term,
                    assignments,
                    projects,
                    classScore,
                    finalExam,
                    totalScore,
                    letterGrade,
                    status: 'draft',
                    lastUpdated: new Date().toISOString()
                };
                
                // Check if this student already has a grade record
                const existingGrade = currentGrades[studentId];
                
                let savePromise;
                
                if (existingGrade && existingGrade.gradeId) {
                    // Update existing grade
                    const gradeRef = database.ref(`grades/${existingGrade.gradeId}`);
                    savePromise = gradeRef.update(grade);
                } else {
                    // Create new grade
                    const gradeRef = database.ref('grades').push();
                    savePromise = gradeRef.set(grade);
                }
                
                savePromise
                    .then(() => {
                        saveCount++;
                        
                        if (saveCount === totalStudents) {
                            showNotification(`All ${saveCount} grades saved successfully!`, 'success');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving grade:', error);
                        showNotification(`Failed to save grade for ${student.name}. Please try again.`, 'error');
                    });
            });
            
            if (saveCount > 0) {
                showNotification(`Saving grades for ${saveCount} students...`, 'info');
            }
        }

        function backToGradeSelection() {
            gradeFormContainer.style.display = 'none';
        }

        function loadPublishedGrades() {
            publishedGradesContainer.innerHTML = '';
            
            if (teacherSubjects.length === 0) {
                noPublishedGrades.style.display = 'block';
                return;
            }
            
            // Get published grades for this teacher's subjects
            const gradesRef = database.ref('grades');
            
            gradesRef.once('value').then(snapshot => {
                const allGrades = snapshot.val() || {};
                const publishedGrades = [];
                
                // Filter grades for this teacher's subjects and published status
                for (const gradeId in allGrades) {
                    const grade = allGrades[gradeId];
                    
                    // Check if this grade is for one of the teacher's subjects
                    const isTeacherSubject = teacherSubjects.some(subject => subject.id === grade.subject);
                    
                    if (isTeacherSubject && grade.status === 'published') {
                        publishedGrades.push({
                            gradeId,
                            ...grade
                        });
                    }
                }
                
                if (publishedGrades.length === 0) {
                    noPublishedGrades.style.display = 'block';
                    return;
                }
                
                noPublishedGrades.style.display = 'none';
                
                // Group grades by class and term
                const gradesByClassTerm = {};
                
                publishedGrades.forEach(grade => {
                    const key = `${grade.class}-${grade.term}`;
                    
                    if (!gradesByClassTerm[key]) {
                        gradesByClassTerm[key] = {
                            class: grade.class,
                            term: grade.term,
                            grades: []
                        };
                    }
                    
                    gradesByClassTerm[key].grades.push(grade);
                });
                
                // Display published grades
                for (const key in gradesByClassTerm) {
                    const classTerm = gradesByClassTerm[key];
                    
                    const gradeCard = document.createElement('div');
                    gradeCard.className = 'subject-card';
                    
                    gradeCard.innerHTML = `
                        <div class="subject-header">
                            <h3 class="subject-name">${classTerm.class} - ${classTerm.term}</h3>
                            <div class="subject-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                        <div class="class-info">
                            <table class="students-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Total Score</th>
                                        <th>Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${classTerm.grades.map(grade => `
                                        <tr>
                                            <td>${grade.studentName}</td>
                                            <td>${grade.totalScore}</td>
                                            <td>${grade.letterGrade}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    publishedGradesContainer.appendChild(gradeCard);
                }
            });
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            currentFiles = [];
            filePreviewContainer.innerHTML = '';
            
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`File ${file.name} is too large (max 10MB)`, 'error');
                    continue;
                }
                
                // Check file type
                const validTypes = ['application/pdf', 'application/msword', 
                                   'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                   'application/vnd.ms-powerpoint',
                                   'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                   'image/jpeg', 'image/png'];
                
                if (!validTypes.includes(file.type)) {
                    showNotification(`File type not supported for ${file.name}`, 'error');
                    continue;
                }
                
                currentFiles.push(file);
                
                // Create preview
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                filePreviewContainer.appendChild(filePreview);
            }
        }

        function handleEditFileSelect(e) {
            const files = e.target.files;
            newFilesToUpload = [];
            editFilePreviewContainer.innerHTML = '';
            
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`File ${file.name} is too large (max 10MB)`, 'error');
                    continue;
                }
                
                // Check file type
                const validTypes = ['application/pdf', 'application/msword', 
                                   'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                   'application/vnd.ms-powerpoint',
                                   'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                   'image/jpeg', 'image/png'];
                
                if (!validTypes.includes(file.type)) {
                    showNotification(`File type not supported for ${file.name}`, 'error');
                    continue;
                }
                
                newFilesToUpload.push(file);
                
                // Create preview
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeEditFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                editFilePreviewContainer.appendChild(filePreview);
            }
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') return 'fas fa-file-pdf';
            if (fileType.includes('word')) return 'fas fa-file-word';
            if (fileType.includes('powerpoint')) return 'fas fa-file-powerpoint';
            if (fileType.includes('image')) return 'fas fa-file-image';
            return 'fas fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile(index) {
            currentFiles.splice(index, 1);
            filePreviewContainer.innerHTML = '';
            
            currentFiles.forEach((file, i) => {
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                filePreviewContainer.appendChild(filePreview);
            });
        }

        function removeEditFile(index) {
            newFilesToUpload.splice(index, 1);
            editFilePreviewContainer.innerHTML = '';
            
            newFilesToUpload.forEach((file, i) => {
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeEditFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                editFilePreviewContainer.appendChild(filePreview);
            });
        }

        async function uploadFiles(files, homeworkId) {
            const uploadPromises = [];
            const fileReferences = [];
            
            for (const file of files) {
                const filePath = `homework/${homeworkId}/${file.name}`;
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);
                
                uploadPromises.push(
                    uploadTask.then(snapshot => snapshot.ref.getDownloadURL())
                );
                
                fileReferences.push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    path: filePath
                });
            }
            
            try {
                const downloadURLs = await Promise.all(uploadPromises);
                
                // Add download URLs to file references
                fileReferences.forEach((ref, index) => {
                    ref.url = downloadURLs[index];
                });
                
                return fileReferences;
            } catch (error) {
                console.error('Error uploading files:', error);
                throw error;
            }
        }

        async function createHomework(e) {
            e.preventDefault();
            
            const subjectId = homeworkSubjectSelect.value;
            const classId = homeworkClassSelect.value;
            const title = homeworkTitleInput.value.trim();
            const description = homeworkDescriptionInput.value.trim();
            const dueDate = homeworkDueDateInput.value;
            
            if (!subjectId || !classId || !title || !description || !dueDate) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            // Find class name
            const className = allClasses[classId]?.name || `Class ${classId}`;
            
            // Create homework object
            const homework = {
                subjectId,
                subjectName,
                classId,
                className,
                title,
                description,
                dueDate,
                assignedDate: new Date().toISOString(),
                assignedBy: currentTeacherId,
                status: 'active',
                files: [],
                submissions: {}
            };
            
            try {
                // Upload files if any
                if (currentFiles.length > 0) {
                    const homeworkRef = database.ref('homework').push();
                    homework.id = homeworkRef.key;
                    
                    const uploadedFiles = await uploadFiles(currentFiles, homeworkRef.key);
                    homework.files = uploadedFiles;
                    
                    // Save homework with file references
                    await homeworkRef.set(homework);
                } else {
                    // Save homework without files
                    const homeworkRef = database.ref('homework').push();
                    await homeworkRef.set(homework);
                }
                
                showNotification('Homework created successfully!', 'success');
                homeworkForm.reset();
                $(homeworkSubjectSelect).val('').trigger('change');
                $(homeworkClassSelect).val('').trigger('change');
                filePreviewContainer.innerHTML = '';
                currentFiles = [];
                
                loadHomework();
            } catch (error) {
                console.error('Error creating homework:', error);
                showNotification('Failed to create homework. Please try again.', 'error');
            }
        }

        function loadHomework() {
            const homeworkRef = database.ref('homework');
            
            homeworkRef.orderByChild('assignedBy').equalTo(currentTeacherId).once('value').then(snapshot => {
                const homeworkData = snapshot.val() || {};
                homeworkList.innerHTML = '';
                
                if (Object.keys(homeworkData).length === 0) {
                    homeworkList.innerHTML = '<p>No homework assignments found.</p>';
                    return;
                }
                
                // Convert to array and sort by due date (newest first)
                const homeworkArray = Object.entries(homeworkData).map(([id, hw]) => ({ id, ...hw }));
                homeworkArray.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                
                // Display homework items
                homeworkArray.forEach(hw => {
                    const homeworkItem = document.createElement('div');
                    homeworkItem.className = 'homework-item';
                    homeworkItem.dataset.id = hw.id;
                    
                    const dueDate = new Date(hw.dueDate).toLocaleDateString();
                    const assignedDate = new Date(hw.assignedDate).toLocaleDateString();
                    
                    // Count submissions
                    const submissionCount = hw.submissions ? Object.keys(hw.submissions).length : 0;
                    
                    homeworkItem.innerHTML = `
                        <div class="homework-title">${hw.title}</div>
                        <div class="homework-meta">
                            <span>${hw.className} - ${hw.subjectName}</span>
                            <span>Due: ${dueDate}</span>
                        </div>
                        <div class="homework-description">${hw.description}</div>
                        <div class="homework-meta">
                            <span>${hw.files?.length || 0} attachments</span>
                            <span>${submissionCount} submissions</span>
                        </div>
                        <div class="homework-actions">
                            <button class="btn btn-primary btn-sm view-homework-btn" data-id="${hw.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                    
                    homeworkList.appendChild(homeworkItem);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-homework-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewHomeworkDetails(btn.dataset.id));
                });
            });
        }

        function viewHomeworkDetails(homeworkId) {
            const homeworkRef = database.ref(`homework/${homeworkId}`);
            
            homeworkRef.once('value').then(snapshot => {
                const homework = snapshot.val();
                
                if (!homework) {
                    showNotification('Homework not found', 'error');
                    return;
                }
                
                currentHomeworkId = homeworkId;
                
                // Display homework details in modal
                homeworkModalTitle.textContent = homework.title;
                modalHomeworkSubject.textContent = homework.subjectName;
                modalHomeworkClass.textContent = homework.className;
                modalHomeworkTitle.textContent = homework.title;
                modalHomeworkDescription.textContent = homework.description;
                
                const dueDate = new Date(homework.dueDate).toLocaleDateString();
                const assignedDate = new Date(homework.assignedDate).toLocaleDateString();
                
                modalHomeworkDueDate.textContent = dueDate;
                modalHomeworkStatus.textContent = homework.status === 'active' ? 'Active' : 'Inactive';
                
                // Display files
                modalHomeworkFiles.innerHTML = '';
                if (homework.files && homework.files.length > 0) {
                    homework.files.forEach(file => {
                        const fileLink = document.createElement('a');
                        fileLink.href = file.url;
                        fileLink.target = '_blank';
                        fileLink.className = 'submission-file';
                        fileLink.innerHTML = `<i class="${getFileIcon(file.type)}"></i> ${file.name}`;
                        modalHomeworkFiles.appendChild(fileLink);
                    });
                } else {
                    modalHomeworkFiles.innerHTML = '<p>No attachments</p>';
                }
                
                // Display submissions
                modalHomeworkSubmissions.innerHTML = '';
                if (homework.submissions && Object.keys(homework.submissions).length > 0) {
                    Object.entries(homework.submissions).forEach(([studentId, submission]) => {
                        const student = allStudents[studentId];
                        if (!student) return;
                        
                        const submissionDate = new Date(submission.submittedAt).toLocaleString();
                        
                        const submissionItem = document.createElement('div');
                        submissionItem.className = 'submission-item';
                        
                        submissionItem.innerHTML = `
                            <div class="submission-header">
                                <div class="submission-student">${student.name}</div>
                                <div class="submission-date">Submitted: ${submissionDate}</div>
                            </div>
                            <div class="submission-content">${submission.comment || 'No comment'}</div>
                            <div id="submission-files-${studentId}"></div>
                            <div class="submission-grade" id="submission-grade-${studentId}"></div>
                        `;
                        
                        modalHomeworkSubmissions.appendChild(submissionItem);
                        
                        // Display submission files
                        const submissionFilesContainer = document.getElementById(`submission-files-${studentId}`);
                        if (submission.files && submission.files.length > 0) {
                            submission.files.forEach(file => {
                                const fileLink = document.createElement('a');
                                fileLink.href = file.url;
                                fileLink.target = '_blank';
                                fileLink.className = 'submission-file';
                                fileLink.innerHTML = `<i class="${getFileIcon(file.type)}"></i> ${file.name}`;
                                submissionFilesContainer.appendChild(fileLink);
                            });
                        }
                        
                        // Display or add grade
                        const gradeContainer = document.getElementById(`submission-grade-${studentId}`);
                        if (submission.grade) {
                            gradeContainer.innerHTML = `
                                <div>Grade: <span class="grade-display">${submission.grade.score} (${submission.grade.letter})</span></div>
                                <div>Feedback: ${submission.grade.feedback || 'No feedback'}</div>
                            `;
                        } else {
                            gradeContainer.innerHTML = `
                                <div>No grade yet</div>
                                <div class="grade-form">
                                    <input type="number" class="grade-input" id="grade-score-${studentId}" min="0" max="100" placeholder="Score">
                                    <input type="text" class="form-control" id="grade-feedback-${studentId}" placeholder="Feedback">
                                    <button class="btn btn-primary btn-sm" id="save-grade-${studentId}">Save Grade</button>
                                </div>
                            `;
                            
                            document.getElementById(`save-grade-${studentId}`).addEventListener('click', () => {
                                saveHomeworkGrade(homeworkId, studentId);
                            });
                        }
                    });
                } else {
                    modalHomeworkSubmissions.innerHTML = '<p>No submissions yet</p>';
                }
                
                // Show modal
                homeworkDetailModal.style.display = 'flex';
            });
        }

        function saveHomeworkGrade(homeworkId, studentId) {
            const scoreInput = document.getElementById(`grade-score-${studentId}`);
            const feedbackInput = document.getElementById(`grade-feedback-${studentId}`);
            
            const score = parseFloat(scoreInput.value);
            const feedback = feedbackInput.value.trim();
            
            if (isNaN(score)) {
                showNotification('Please enter a valid score', 'error');
                return;
            }
            
            const letterGrade = calculateLetterGrade(score);
            
            const grade = {
                score,
                letter: letterGrade,
                feedback,
                gradedBy: currentTeacherId,
                gradedAt: new Date().toISOString()
            };
            
            const update = {};
            update[`homework/${homeworkId}/submissions/${studentId}/grade`] = grade;
            
            database.ref().update(update)
                .then(() => {
                    showNotification('Grade saved successfully', 'success');
                    viewHomeworkDetails(homeworkId); // Refresh the view
                })
                .catch(error => {
                    console.error('Error saving grade:', error);
                    showNotification('Failed to save grade', 'error');
                });
        }

        function deleteHomework() {
            if (!currentHomeworkId) return;
            
            if (confirm('Are you sure you want to delete this homework assignment?')) {
                const homeworkRef = database.ref(`homework/${currentHomeworkId}`);
                
                // First delete any associated files
                deleteHomeworkFiles(currentHomeworkId)
                    .then(() => {
                        return homeworkRef.remove();
                    })
                    .then(() => {
                        showNotification('Homework deleted successfully!', 'success');
                        homeworkDetailModal.style.display = 'none';
                        loadHomework();
                    })
                    .catch(error => {
                        console.error('Error deleting homework:', error);
                        showNotification('Failed to delete homework. Please try again.', 'error');
                    });
            }
        }

        async function deleteHomeworkFiles(homeworkId) {
            const homeworkRef = database.ref(`homework/${homeworkId}`);
            const snapshot = await homeworkRef.once('value');
            const homework = snapshot.val();
            
            if (!homework || !homework.files || homework.files.length === 0) {
                return Promise.resolve();
            }
            
            const deletePromises = homework.files.map(file => {
                const fileRef = storage.ref(file.path);
                return fileRef.delete().catch(error => {
                    console.error('Error deleting file:', error);
                });
            });
            
            return Promise.all(deletePromises);
        }

        function openEditHomeworkModal() {
            if (!currentHomeworkId) return;
            
            const homeworkRef = database.ref(`homework/${currentHomeworkId}`);
            
            homeworkRef.once('value').then(snapshot => {
                const homework = snapshot.val();
                
                if (!homework) {
                    showNotification('Homework not found', 'error');
                    return;
                }
                
                // Populate edit form
                editHomeworkId.value = currentHomeworkId;
                editHomeworkTitle.value = homework.title;
                editHomeworkDescription.value = homework.description;
                editHomeworkDueDate.value = homework.dueDate.split('T')[0];
                
                // Display current files
                editHomeworkFiles.innerHTML = '';
                if (homework.files && homework.files.length > 0) {
                    homework.files.forEach(file => {
                        const filePreview = document.createElement('div');
                        filePreview.className = 'file-preview';
                        
                        const icon = document.createElement('i');
                        icon.className = getFileIcon(file.type);
                        
                        const fileInfo = document.createElement('div');
                        fileInfo.className = 'file-preview-info';
                        
                        const fileName = document.createElement('div');
                        fileName.className = 'file-preview-name';
                        fileName.textContent = file.name;
                        
                        const fileSize = document.createElement('div');
                        fileSize.className = 'file-preview-size';
                        fileSize.textContent = formatFileSize(file.size);
                        
                        fileInfo.appendChild(fileName);
                        fileInfo.appendChild(fileSize);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-file';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.addEventListener('click', () => {
                            if (confirm('Are you sure you want to remove this file?')) {
                                removeHomeworkFile(currentHomeworkId, file);
                            }
                        });
                        
                        filePreview.appendChild(icon);
                        filePreview.appendChild(fileInfo);
                        filePreview.appendChild(removeBtn);
                        
                        editHomeworkFiles.appendChild(filePreview);
                    });
                } else {
                    editHomeworkFiles.innerHTML = '<p>No attachments</p>';
                }
                
                // Clear any new files
                editFilePreviewContainer.innerHTML = '';
                newFilesToUpload = [];
                
                // Hide detail modal and show edit modal
                homeworkDetailModal.style.display = 'none';
                editHomeworkModal.style.display = 'flex';
            });
        }

        async function removeHomeworkFile(homeworkId, file) {
            try {
                // Delete file from storage
                const fileRef = storage.ref(file.path);
                await fileRef.delete();
                
                // Remove file reference from homework
                const homeworkRef = database.ref(`homework/${homeworkId}/files`);
                const snapshot = await homeworkRef.once('value');
                const files = snapshot.val() || [];
                
                const updatedFiles = files.filter(f => f.path !== file.path);
                await homeworkRef.set(updatedFiles);
                
                showNotification('File removed successfully', 'success');
                openEditHomeworkModal(); // Refresh the edit modal
            } catch (error) {
                console.error('Error removing file:', error);
                showNotification('Failed to remove file', 'error');
            }
        }

        async function saveHomeworkChanges() {
            const homeworkId = editHomeworkId.value;
            const title = editHomeworkTitle.value.trim();
            const description = editHomeworkDescription.value.trim();
            const dueDate = editHomeworkDueDate.value;
            
            if (!homeworkId || !title || !description || !dueDate) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            try {
                // Upload any new files
                let uploadedFiles = [];
                if (newFilesToUpload.length > 0) {
                    uploadedFiles = await uploadFiles(newFilesToUpload, homeworkId);
                }
                
                // Get current files
                const homeworkRef = database.ref(`homework/${homeworkId}/files`);
                const snapshot = await homeworkRef.once('value');
                const currentFiles = snapshot.val() || [];
                
                // Combine current files with new ones
                const allFiles = [...currentFiles, ...uploadedFiles];
                
                // Prepare updates
                const updates = {
                    title,
                    description,
                    dueDate,
                    files: allFiles
                };
                
                // Save updates
                await database.ref(`homework/${homeworkId}`).update(updates);
                
                showNotification('Homework updated successfully!', 'success');
                editHomeworkModal.style.display = 'none';
                loadHomework();
            } catch (error) {
                console.error('Error updating homework:', error);
                showNotification('Failed to update homework. Please try again.', 'error');
            }
        }

        // Initialize the app
        loadingScreen.style.display = 'flex';
        mainContent.style.display = 'none';
        checkAuthState();
    </script>
</body>
</html>
