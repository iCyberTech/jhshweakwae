<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Homework & Grading</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --text-color: #2d3436;
            --light-text: #636e72;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --success-color: #00b894;
            --danger-color: #d63031;
            --warning-color: #fdcb6e;
            --info-color: #0984e3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            transition: all 0.3s;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-profile span {
            font-weight: 500;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #5a4bc9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #00a884;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background: #fdbb4a;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .select2-container .select2-selection--single {
            height: 40px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.7);
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 40px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .table th {
            background: rgba(108, 92, 231, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }

        .table tr:hover {
            background: rgba(108, 92, 231, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background: rgba(108, 92, 231, 0.1);
            color: var(--primary-color);
        }

        .badge-success {
            background: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
        }

        .badge-warning {
            background: rgba(253, 203, 110, 0.1);
            color: #e17055;
        }

        .badge-danger {
            background: rgba(214, 48, 49, 0.1);
            color: var(--danger-color);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--text-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            position: relative;
            font-weight: 500;
            color: var(--light-text);
        }

        .tab.active {
            color: var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .homework-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .homework-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .homework-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--light-text);
            margin-bottom: 10px;
        }

        .homework-description {
            margin-bottom: 10px;
        }

        .homework-actions {
            display: flex;
            gap: 10px;
        }

        .grade-input {
            width: 70px;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .grade-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .file-upload-container {
            margin-top: 15px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-container:hover {
            border-color: var(--primary-color);
            background: rgba(108, 92, 231, 0.05);
        }

        .file-upload-container i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .file-upload-container p {
            margin-bottom: 5px;
        }

        .file-upload-container small {
            color: var(--light-text);
        }

        #file-input {
            display: none;
        }

        .file-preview {
            margin-top: 15px;
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        .file-preview i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-name {
            font-weight: 500;
        }

        .file-preview-size {
            font-size: 0.8rem;
            color: var(--light-text);
        }

        .remove-file {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
        }

        .submission-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .submission-student {
            font-weight: 600;
        }

        .submission-date {
            color: var(--light-text);
            font-size: 0.85rem;
        }

        .submission-content {
            margin-bottom: 10px;
        }

        .submission-file {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 8px;
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .submission-file i {
            margin-right: 5px;
        }

        .submission-grade {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .grade-form {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .grade-display {
            font-weight: 600;
            color: var(--success-color);
        }

        .real-time-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .real-time-notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .real-time-notification.success i {
            color: var(--success-color);
        }

        .real-time-notification.error i {
            color: var(--danger-color);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.4rem;
            }

            .user-profile span {
                display: none;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(108, 92, 231, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(108, 92, 231, 0.7);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Teacher Dashboard...</div>
    </div>

    <!-- Real-time Notification -->
    <div class="real-time-notification" id="real-time-notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message">Notification message</span>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content" id="main-content">
            <div class="header">
                <h1 id="page-title">Homework Management</h1>
                <div class="user-profile">
                    <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Teacher" id="header-teacher-avatar">
                    <span id="header-teacher-name">Loading...</span>
                </div>
            </div>

            <!-- Tab Container -->
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="homework">Homework</div>
                    <div class="tab" data-tab="grading">Grading</div>
                    <div class="tab" data-tab="classes">My Classes</div>
                </div>

                <!-- Homework Tab Content -->
                <div class="tab-content active" id="homework-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Create New Homework</div>
                        </div>
                        <div class="card-body">
                            <form id="homework-form">
                                <div class="form-group">
                                    <label for="homework-subject" class="form-label">Subject</label>
                                    <select id="homework-subject" class="form-control" required>
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="homework-class" class="form-label">Class</label>
                                    <select id="homework-class" class="form-control" required>
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="homework-title" class="form-label">Title</label>
                                    <input type="text" id="homework-title" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="homework-description" class="form-label">Description</label>
                                    <textarea id="homework-description" class="form-control" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="homework-due-date" class="form-label">Due Date</label>
                                    <input type="date" id="homework-due-date" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Attachments (Optional)</label>
                                    <div class="file-upload-container" id="file-upload-container">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Click to upload files</p>
                                        <small>PDF, DOCX, PPTX, JPG, PNG (Max 10MB)</small>
                                        <input type="file" id="file-input" multiple>
                                    </div>
                                    <div id="file-preview-container"></div>
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Create Homework</button>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Assigned Homework</div>
                        </div>
                        <div class="card-body">
                            <div id="homework-list">
                                <!-- Homework items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grading Tab Content -->
                <div class="tab-content" id="grading-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Grade Students</div>
                        </div>
                        <div class="card-body">
                            <form id="grade-filter-form">
                                <div class="form-group">
                                    <label for="grade-subject" class="form-label">Subject</label>
                                    <select id="grade-subject" class="form-control" required>
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="grade-class" class="form-label">Class</label>
                                    <select id="grade-class" class="form-control" required>
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="grade-term" class="form-label">Term</label>
                                    <select id="grade-term" class="form-control" required>
                                        <option value="Term 1">Term 1</option>
                                        <option value="Term 2">Term 2</option>
                                        <option value="Term 3">Term 3</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-filter"></i> Filter Students</button>
                            </form>

                            <div id="students-to-grade" style="margin-top: 20px; display: none;">
                                <h3>Students in <span id="selected-class-name"></span> - <span id="selected-subject-name"></span></h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Assignments</th>
                                            <th>Projects</th>
                                            <th>Class Score</th>
                                            <th>Final Exam</th>
                                            <th>Total</th>
                                            <th>Grade</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="grade-students-table">
                                        <!-- Students will be loaded here -->
                                    </tbody>
                                </table>
                                <button id="save-grades-btn" class="btn btn-success" style="margin-top: 15px;"><i class="fas fa-save"></i> Save All Grades</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classes Tab Content -->
                <div class="tab-content" id="classes-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">My Classes & Subjects</div>
                        </div>
                        <div class="card-body">
                            <div id="teacher-classes-list">
                                <!-- Classes and subjects will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Homework Detail Modal -->
    <div class="modal" id="homework-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="homework-modal-title">Homework Details</div>
                <button class="close-modal" id="close-homework-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <p id="modal-homework-subject"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Class</label>
                    <p id="modal-homework-class"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <p id="modal-homework-title"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p id="modal-homework-description"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <p id="modal-homework-due-date"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <p id="modal-homework-status"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Attachments</label>
                    <div id="modal-homework-files"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Submissions</label>
                    <div id="modal-homework-submissions"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="delete-homework-btn"><i class="fas fa-trash"></i> Delete</button>
                <button class="btn btn-primary" id="edit-homework-btn"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-secondary close-modal"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Homework Modal -->
    <div class="modal" id="edit-homework-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Homework</div>
                <button class="close-modal" id="close-edit-homework-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-homework-form">
                    <input type="hidden" id="edit-homework-id">
                    <div class="form-group">
                        <label for="edit-homework-title" class="form-label">Title</label>
                        <input type="text" id="edit-homework-title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-homework-description" class="form-label">Description</label>
                        <textarea id="edit-homework-description" class="form-control" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-homework-due-date" class="form-label">Due Date</label>
                        <input type="date" id="edit-homework-due-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Attachments</label>
                        <div id="edit-homework-files"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Add New Attachments</label>
                        <div class="file-upload-container" id="edit-file-upload-container">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Click to upload additional files</p>
                            <small>PDF, DOCX, PPTX, JPG, PNG (Max 10MB)</small>
                            <input type="file" id="edit-file-input" multiple>
                        </div>
                        <div id="edit-file-preview-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-homework-btn"><i class="fas fa-save"></i> Save Changes</button>
                <button class="btn btn-secondary close-modal"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkrHsyfCTijqKP7UJv0eSx0iNvl8S06U8",
            authDomain: "sms-single.firebaseapp.com",
            projectId: "sms-single",
            storageBucket: "sms-single.appspot.com",
            messagingSenderId: "140188895278",
            appId: "1:140188895278:web:1b56660a13e5b088ce77bf",
            measurementId: "G-7ER348P6VZ"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const headerTeacherName = document.getElementById('header-teacher-name');
        const headerTeacherAvatar = document.getElementById('header-teacher-avatar');
        const pageTitle = document.getElementById('page-title');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const notification = document.getElementById('real-time-notification');
        const notificationMessage = document.getElementById('notification-message');
        
        // Homework elements
        const homeworkForm = document.getElementById('homework-form');
        const homeworkSubjectSelect = document.getElementById('homework-subject');
        const homeworkClassSelect = document.getElementById('homework-class');
        const homeworkTitleInput = document.getElementById('homework-title');
        const homeworkDescriptionInput = document.getElementById('homework-description');
        const homeworkDueDateInput = document.getElementById('homework-due-date');
        const homeworkList = document.getElementById('homework-list');
        const fileUploadContainer = document.getElementById('file-upload-container');
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        
        // Grading elements
        const gradeFilterForm = document.getElementById('grade-filter-form');
        const gradeSubjectSelect = document.getElementById('grade-subject');
        const gradeClassSelect = document.getElementById('grade-class');
        const gradeTermSelect = document.getElementById('grade-term');
        const studentsToGradeSection = document.getElementById('students-to-grade');
        const gradeStudentsTable = document.getElementById('grade-students-table');
        const saveGradesBtn = document.getElementById('save-grades-btn');
        const selectedClassName = document.getElementById('selected-class-name');
        const selectedSubjectName = document.getElementById('selected-subject-name');
        
        // Classes elements
        const teacherClassesList = document.getElementById('teacher-classes-list');
        
        // Modal elements
        const homeworkDetailModal = document.getElementById('homework-detail-modal');
        const homeworkModalTitle = document.getElementById('homework-modal-title');
        const modalHomeworkSubject = document.getElementById('modal-homework-subject');
        const modalHomeworkClass = document.getElementById('modal-homework-class');
        const modalHomeworkTitle = document.getElementById('modal-homework-title');
        const modalHomeworkDescription = document.getElementById('modal-homework-description');
        const modalHomeworkDueDate = document.getElementById('modal-homework-due-date');
        const modalHomeworkStatus = document.getElementById('modal-homework-status');
        const modalHomeworkFiles = document.getElementById('modal-homework-files');
        const modalHomeworkSubmissions = document.getElementById('modal-homework-submissions');
        const closeHomeworkModal = document.getElementById('close-homework-modal');
        const deleteHomeworkBtn = document.getElementById('delete-homework-btn');
        const editHomeworkBtn = document.getElementById('edit-homework-btn');
        
        const editHomeworkModal = document.getElementById('edit-homework-modal');
        const closeEditHomeworkModal = document.getElementById('close-edit-homework-modal');
        const editHomeworkForm = document.getElementById('edit-homework-form');
        const editHomeworkId = document.getElementById('edit-homework-id');
        const editHomeworkTitle = document.getElementById('edit-homework-title');
        const editHomeworkDescription = document.getElementById('edit-homework-description');
        const editHomeworkDueDate = document.getElementById('edit-homework-due-date');
        const editHomeworkFiles = document.getElementById('edit-homework-files');
        const editFileUploadContainer = document.getElementById('edit-file-upload-container');
        const editFileInput = document.getElementById('edit-file-input');
        const editFilePreviewContainer = document.getElementById('edit-file-preview-container');
        const saveHomeworkBtn = document.getElementById('save-homework-btn');
        
        // Global variables
        let currentTeacherId = null;
        let currentTeacherData = null;
        let teacherSubjects = [];
        let teacherClasses = [];
        let allClasses = {};
        let allStudents = {};
        let allSubjects = {};
        let currentHomeworkId = null;
        let currentGrades = {};
        let currentFiles = [];
        let newFilesToUpload = [];
        let currentGradingContext = {
            subjectId: null,
            classId: null,
            term: null
        };

        // Initialize Select2
        $(document).ready(function() {
            $('select').select2({
                width: '100%'
            });
        });

        // Event Listeners
        tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });
        
        homeworkForm.addEventListener('submit', createHomework);
        gradeFilterForm.addEventListener('submit', filterStudentsForGrading);
        saveGradesBtn.addEventListener('click', saveAllGrades);
        
        // File upload events
        fileUploadContainer.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        editFileUploadContainer.addEventListener('click', () => editFileInput.click());
        editFileInput.addEventListener('change', handleEditFileSelect);
        
        // Modal events
        closeHomeworkModal.addEventListener('click', () => homeworkDetailModal.style.display = 'none');
        closeEditHomeworkModal.addEventListener('click', () => editHomeworkModal.style.display = 'none');
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        deleteHomeworkBtn.addEventListener('click', deleteHomework);
        editHomeworkBtn.addEventListener('click', openEditHomeworkModal);
        saveHomeworkBtn.addEventListener('click', saveHomeworkChanges);
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === homeworkDetailModal) {
                homeworkDetailModal.style.display = 'none';
            }
            if (e.target === editHomeworkModal) {
                editHomeworkModal.style.display = 'none';
            }
        });

        // Functions
        function showNotification(message, isSuccess = true) {
            notificationMessage.textContent = message;
            notification.className = 'real-time-notification';
            notification.classList.add(isSuccess ? 'success' : 'error');
            notification.querySelector('i').className = isSuccess ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function switchTab(tabId) {
            // Update active tab
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update active content
            tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Update page title
            switch(tabId) {
                case 'homework':
                    pageTitle.textContent = 'Homework Management';
                    break;
                case 'grading':
                    pageTitle.textContent = 'Student Grading';
                    break;
                case 'classes':
                    pageTitle.textContent = 'My Classes & Subjects';
                    break;
                default:
                    pageTitle.textContent = 'Teacher Dashboard';
            }
        }

        async function identifyCurrentTeacher() {
            try {
                // First try to get from activeSessions
                const activeSessionSnapshot = await database.ref('activeSessions/teacher').once('value');
                if (activeSessionSnapshot.exists()) {
                    currentTeacherId = activeSessionSnapshot.val();
                    const teacherSnapshot = await database.ref(`teachers/${currentTeacherId}`).once('value');
                    
                    if (teacherSnapshot.exists()) {
                        currentTeacherData = teacherSnapshot.val();
                        return currentTeacherData;
                    }
                }
                
                // Fallback to device identification if active session not found
                const authUsersSnapshot = await database.ref('authUsers').once('value');
                if (!authUsersSnapshot.exists()) {
                    throw new Error('No auth users found');
                }
                
                const authUsers = authUsersSnapshot.val();
                const credentialsSnapshot = await database.ref('credentials').once('value');
                const credentials = credentialsSnapshot.exists() ? credentialsSnapshot.val() : {};
                
                // Get current device info from browser
                const userAgent = navigator.userAgent;
                const screenResolution = `${window.screen.width}x${window.screen.height}`;
                const language = navigator.language;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // Find matching teacher based on device info
                for (const [authId, authUser] of Object.entries(authUsers)) {
                    if (authUser.userType === 'teacher') {
                        const teacherCredential = credentials[authUser.userId];
                        if (teacherCredential && teacherCredential.deviceInfo) {
                            const deviceInfo = teacherCredential.deviceInfo;
                            
                            // Check for matching device characteristics
                            if (deviceInfo.userAgent === userAgent && 
                                deviceInfo.screenResolution === screenResolution &&
                                deviceInfo.language === language && 
                                deviceInfo.timezone === timezone) {
                                
                                // This is likely the current teacher
                                currentTeacherId = authUser.userId;
                                
                                // Get teacher details from teachers collection
                                const teacherSnapshot = await database.ref(`teachers/${currentTeacherId}`).once('value');
                                
                                if (teacherSnapshot.exists()) {
                                    currentTeacherData = teacherSnapshot.val();
                                    return currentTeacherData;
                                }
                            }
                        }
                    }
                }
                
                throw new Error('No matching teacher found');
            } catch (error) {
                console.error('Error identifying teacher:', error);
                showNotification('Failed to identify teacher: ' + error.message, false);
                return null;
            }
        }

        function checkAuthState() {
            auth.onAuthStateChanged(async user => {
                if (user) {
                    try {
                        const teacher = await identifyCurrentTeacher();
                        if (teacher) {
                            loadTeacherData(teacher);
                            loadTeacherSubjects();
                            loadClasses();
                            loadStudents();
                            loadHomework();
                            
                            // Set up real-time listener for homework submissions
                            setupHomeworkSubmissionsListener();
                            
                            // Hide loading screen and show main content
                            loadingScreen.style.display = 'none';
                            mainContent.style.display = 'block';
                        } else {
                            // If teacher not found, redirect to login
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error('Error checking active session:', error);
                        window.location.href = 'login.html';
                    }
                } else {
                    // No user is signed in, redirect to login
                    window.location.href = 'login.html';
                }
            });
        }

        function loadTeacherData(teacher) {
            currentTeacherData = teacher;
            
            if (currentTeacherData) {
                // Update UI with teacher data
                headerTeacherName.textContent = currentTeacherData.name;
                
                if (currentTeacherData.profileImage) {
                    headerTeacherAvatar.src = currentTeacherData.profileImage;
                }
            }
        }

        function loadTeacherSubjects() {
            const subjectsRef = database.ref('subjects');
            
            subjectsRef.once('value').then(snapshot => {
                allSubjects = snapshot.val() || {};
                teacherSubjects = [];
                
                for (const subjectId in allSubjects) {
                    const subject = allSubjects[subjectId];
                    if (subject.teacher === currentTeacherId) {
                        teacherSubjects.push({
                            id: subjectId,
                            ...subject
                        });
                    }
                }
                
                // Populate subject dropdowns
                populateSubjectDropdowns();
                
                // Load teacher's classes based on subjects
                loadTeacherClasses();
            });
        }

        function populateSubjectDropdowns() {
            // Clear existing options
            homeworkSubjectSelect.innerHTML = '<option value="">Select Subject</option>';
            gradeSubjectSelect.innerHTML = '<option value="">Select Subject</option>';
            
            // Add subjects
            teacherSubjects.forEach(subject => {
                const option1 = document.createElement('option');
                option1.value = subject.id;
                option1.textContent = subject.name;
                homeworkSubjectSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = subject.id;
                option2.textContent = subject.name;
                gradeSubjectSelect.appendChild(option2);
            });
            
            // Refresh Select2
            $(homeworkSubjectSelect).trigger('change');
            $(gradeSubjectSelect).trigger('change');
        }

        function loadTeacherClasses() {
            teacherClasses = [];
            const classIds = new Set();
            
            teacherSubjects.forEach(subject => {
                if (subject.class && !classIds.has(subject.class)) {
                    classIds.add(subject.class);
                    teacherClasses.push({
                        classId: subject.class,
                        subjectId: subject.id
                    });
                }
            });
            
            // Populate class dropdowns based on selected subject
            homeworkSubjectSelect.addEventListener('change', updateHomeworkClassDropdown);
            gradeSubjectSelect.addEventListener('change', updateGradeClassDropdown);
        }

        function updateHomeworkClassDropdown() {
            const subjectId = homeworkSubjectSelect.value;
            homeworkClassSelect.innerHTML = '<option value="">Select Class</option>';
            
            if (!subjectId) return;
            
            const subject = teacherSubjects.find(s => s.id === subjectId);
            if (subject && subject.class) {
                const option = document.createElement('option');
                option.value = subject.class;
                
                // Find class name from allClasses
                const className = allClasses[subject.class]?.name || `Class ${subject.class}`;
                option.textContent = className;
                
                homeworkClassSelect.appendChild(option);
            }
            
            $(homeworkClassSelect).trigger('change');
        }

        function updateGradeClassDropdown() {
            const subjectId = gradeSubjectSelect.value;
            gradeClassSelect.innerHTML = '<option value="">Select Class</option>';
            
            if (!subjectId) return;
            
            const subject = teacherSubjects.find(s => s.id === subjectId);
            if (subject && subject.class) {
                const option = document.createElement('option');
                option.value = subject.class;
                
                // Find class name from allClasses
                const className = allClasses[subject.class]?.name || `Class ${subject.class}`;
                option.textContent = className;
                
                gradeClassSelect.appendChild(option);
            }
            
            $(gradeClassSelect).trigger('change');
        }

        function loadClasses() {
            const classesRef = database.ref('classes');
            
            classesRef.once('value').then(snapshot => {
                allClasses = snapshot.val() || {};
                
                // Also load graduated classes
                const graduatedClassesRef = database.ref('graduatedClasses');
                graduatedClassesRef.once('value').then(gSnapshot => {
                    const graduatedClasses = gSnapshot.val() || {};
                    allClasses = { ...allClasses, ...graduatedClasses };
                    
                    // Update class dropdowns if needed
                    if (homeworkSubjectSelect.value) {
                        updateHomeworkClassDropdown();
                    }
                    if (gradeSubjectSelect.value) {
                        updateGradeClassDropdown();
                    }
                    
                    // Load teacher's classes for display
                    displayTeacherClasses();
                });
            });
        }

        function loadStudents() {
            const studentsRef = database.ref('students');
            const oldStudentsRef = database.ref('oldStudents');
            
            Promise.all([
                studentsRef.once('value'),
                oldStudentsRef.once('value')
            ]).then(([studentsSnapshot, oldStudentsSnapshot]) => {
                const currentStudents = studentsSnapshot.val() || {};
                const oldStudents = oldStudentsSnapshot.val() || {};
                
                // Remove the 'classes' property from oldStudents if it exists
                if (oldStudents.classes) {
                    delete oldStudents.classes;
                }
                
                allStudents = { ...currentStudents, ...oldStudents };
            });
        }

        function displayTeacherClasses() {
            teacherClassesList.innerHTML = '';
            
            if (teacherSubjects.length === 0) {
                teacherClassesList.innerHTML = '<p>No classes assigned to you.</p>';
                return;
            }
            
            // Group subjects by class
            const classesMap = {};
            
            teacherSubjects.forEach(subject => {
                if (!subject.class) return;
                
                if (!classesMap[subject.class]) {
                    classesMap[subject.class] = {
                        classId: subject.class,
                        className: allClasses[subject.class]?.name || `Class ${subject.class}`,
                        subjects: []
                    };
                }
                
                classesMap[subject.class].subjects.push({
                    id: subject.id,
                    name: subject.name,
                    schedule: subject.schedule ? formatSchedule(subject.schedule) : 'No schedule set'
                });
            });
            
            // Create cards for each class
            for (const classId in classesMap) {
                const classInfo = classesMap[classId];
                
                const classCard = document.createElement('div');
                classCard.className = 'card';
                classCard.style.marginBottom = '20px';
                
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header';
                cardHeader.innerHTML = `<div class="card-title">${classInfo.className}</div>`;
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                const subjectsList = document.createElement('div');
                subjectsList.style.marginTop = '15px';
                
                classInfo.subjects.forEach(subject => {
                    const subjectItem = document.createElement('div');
                    subjectItem.style.marginBottom = '15px';
                    subjectItem.style.paddingBottom = '15px';
                    subjectItem.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
                    
                    subjectItem.innerHTML = `
                        <h4 style="margin-bottom: 5px;">${subject.name}</h4>
                        <p style="color: var(--light-text); font-size: 0.9rem;">${subject.schedule}</p>
                    `;
                    
                    subjectsList.appendChild(subjectItem);
                });
                
                cardBody.appendChild(subjectsList);
                classCard.appendChild(cardHeader);
                classCard.appendChild(cardBody);
                teacherClassesList.appendChild(classCard);
            }
        }

        function formatSchedule(schedule) {
            if (!schedule || !schedule.days || !schedule.time) return 'No schedule set';
            
            const days = schedule.days.join(', ');
            const time = `${schedule.time.from} - ${schedule.time.to}`;
            
            return `${days} at ${time}`;
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            currentFiles = [];
            filePreviewContainer.innerHTML = '';
            
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`File ${file.name} is too large (max 10MB)`, false);
                    continue;
                }
                
                // Check file type
                const validTypes = ['application/pdf', 'application/msword', 
                                   'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                   'application/vnd.ms-powerpoint',
                                   'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                   'image/jpeg', 'image/png'];
                
                if (!validTypes.includes(file.type)) {
                    showNotification(`File type not supported for ${file.name}`, false);
                    continue;
                }
                
                currentFiles.push(file);
                
                // Create preview
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                filePreviewContainer.appendChild(filePreview);
            }
        }

        function handleEditFileSelect(e) {
            const files = e.target.files;
            newFilesToUpload = [];
            editFilePreviewContainer.innerHTML = '';
            
            if (files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`File ${file.name} is too large (max 10MB)`, false);
                    continue;
                }
                
                // Check file type
                const validTypes = ['application/pdf', 'application/msword', 
                                   'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                   'application/vnd.ms-powerpoint',
                                   'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                   'image/jpeg', 'image/png'];
                
                if (!validTypes.includes(file.type)) {
                    showNotification(`File type not supported for ${file.name}`, false);
                    continue;
                }
                
                newFilesToUpload.push(file);
                
                // Create preview
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeEditFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                editFilePreviewContainer.appendChild(filePreview);
            }
        }

        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') return 'fas fa-file-pdf';
            if (fileType.includes('word')) return 'fas fa-file-word';
            if (fileType.includes('powerpoint')) return 'fas fa-file-powerpoint';
            if (fileType.includes('image')) return 'fas fa-file-image';
            return 'fas fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile(index) {
            currentFiles.splice(index, 1);
            filePreviewContainer.innerHTML = '';
            
            currentFiles.forEach((file, i) => {
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                filePreviewContainer.appendChild(filePreview);
            });
        }

        function removeEditFile(index) {
            newFilesToUpload.splice(index, 1);
            editFilePreviewContainer.innerHTML = '';
            
            newFilesToUpload.forEach((file, i) => {
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                
                const icon = document.createElement('i');
                icon.className = getFileIcon(file.type);
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-preview-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-preview-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', () => removeEditFile(i));
                
                filePreview.appendChild(icon);
                filePreview.appendChild(fileInfo);
                filePreview.appendChild(removeBtn);
                
                editFilePreviewContainer.appendChild(filePreview);
            });
        }

        async function uploadFiles(files, homeworkId) {
            const uploadPromises = [];
            const fileReferences = [];
            
            for (const file of files) {
                const filePath = `homework/${homeworkId}/${file.name}`;
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);
                
                uploadPromises.push(
                    uploadTask.then(snapshot => snapshot.ref.getDownloadURL())
                );
                
                fileReferences.push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    path: filePath
                });
            }
            
            try {
                const downloadURLs = await Promise.all(uploadPromises);
                
                // Add download URLs to file references
                fileReferences.forEach((ref, index) => {
                    ref.url = downloadURLs[index];
                });
                
                return fileReferences;
            } catch (error) {
                console.error('Error uploading files:', error);
                throw error;
            }
        }

        async function createHomework(e) {
            e.preventDefault();
            
            const subjectId = homeworkSubjectSelect.value;
            const classId = homeworkClassSelect.value;
            const title = homeworkTitleInput.value.trim();
            const description = homeworkDescriptionInput.value.trim();
            const dueDate = homeworkDueDateInput.value;
            
            if (!subjectId || !classId || !title || !description || !dueDate) {
                showNotification('Please fill in all fields', false);
                return;
            }
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            // Find class name
            const className = allClasses[classId]?.name || `Class ${classId}`;
            
            // Create homework object
            const homework = {
                subjectId,
                subjectName,
                classId,
                className,
                title,
                description,
                dueDate,
                assignedDate: new Date().toISOString(),
                assignedBy: currentTeacherId,
                status: 'active',
                files: [],
                submissions: {}
            };
            
            try {
                // Upload files if any
                if (currentFiles.length > 0) {
                    const homeworkRef = database.ref('homework').push();
                    homework.id = homeworkRef.key;
                    
                    const uploadedFiles = await uploadFiles(currentFiles, homeworkRef.key);
                    homework.files = uploadedFiles;
                    
                    // Save homework with file references
                    await homeworkRef.set(homework);
                } else {
                    // Save homework without files
                    const homeworkRef = database.ref('homework').push();
                    await homeworkRef.set(homework);
                }
                
                showNotification('Homework created successfully!');
                homeworkForm.reset();
                $(homeworkSubjectSelect).val('').trigger('change');
                $(homeworkClassSelect).val('').trigger('change');
                filePreviewContainer.innerHTML = '';
                currentFiles = [];
                
                loadHomework();
            } catch (error) {
                console.error('Error creating homework:', error);
                showNotification('Failed to create homework. Please try again.', false);
            }
        }

        function loadHomework() {
            const homeworkRef = database.ref('homework');
            
            homeworkRef.orderByChild('assignedBy').equalTo(currentTeacherId).once('value').then(snapshot => {
                const homeworkData = snapshot.val() || {};
                homeworkList.innerHTML = '';
                
                if (Object.keys(homeworkData).length === 0) {
                    homeworkList.innerHTML = '<p>No homework assignments found.</p>';
                    return;
                }
                
                // Convert to array and sort by due date (newest first)
                const homeworkArray = Object.entries(homeworkData).map(([id, hw]) => ({ id, ...hw }));
                homeworkArray.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                
                // Display homework items
                homeworkArray.forEach(hw => {
                    const homeworkItem = document.createElement('div');
                    homeworkItem.className = 'homework-item';
                    homeworkItem.dataset.id = hw.id;
                    
                    const dueDate = new Date(hw.dueDate).toLocaleDateString();
                    const assignedDate = new Date(hw.assignedDate).toLocaleDateString();
                    
                    // Count submissions
                    const submissionCount = hw.submissions ? Object.keys(hw.submissions).length : 0;
                    
                    homeworkItem.innerHTML = `
                        <div class="homework-title">${hw.title}</div>
                        <div class="homework-meta">
                            <span>${hw.className} - ${hw.subjectName}</span>
                            <span>Due: ${dueDate}</span>
                        </div>
                        <div class="homework-description">${hw.description}</div>
                        <div class="homework-meta">
                            <span>${hw.files?.length || 0} attachments</span>
                            <span>${submissionCount} submissions</span>
                        </div>
                        <div class="homework-actions">
                            <button class="btn btn-primary btn-sm view-homework-btn" data-id="${hw.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                    
                    homeworkList.appendChild(homeworkItem);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-homework-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewHomeworkDetails(btn.dataset.id));
                });
            });
        }

        function viewHomeworkDetails(homeworkId) {
            const homeworkRef = database.ref(`homework/${homeworkId}`);
            
            homeworkRef.once('value').then(snapshot => {
                const homework = snapshot.val();
                
                if (!homework) {
                    showNotification('Homework not found', false);
                    return;
                }
                
                currentHomeworkId = homeworkId;
                
                // Display homework details in modal
                homeworkModalTitle.textContent = homework.title;
                modalHomeworkSubject.textContent = homework.subjectName;
                modalHomeworkClass.textContent = homework.className;
                modalHomeworkTitle.textContent = homework.title;
                modalHomeworkDescription.textContent = homework.description;
                
                const dueDate = new Date(homework.dueDate).toLocaleDateString();
                const assignedDate = new Date(homework.assignedDate).toLocaleDateString();
                
                modalHomeworkDueDate.textContent = dueDate;
                modalHomeworkStatus.textContent = homework.status === 'active' ? 'Active' : 'Inactive';
                
                // Display files
                modalHomeworkFiles.innerHTML = '';
                if (homework.files && homework.files.length > 0) {
                    homework.files.forEach(file => {
                        const fileLink = document.createElement('a');
                        fileLink.href = file.url;
                        fileLink.target = '_blank';
                        fileLink.className = 'submission-file';
                        fileLink.innerHTML = `<i class="${getFileIcon(file.type)}"></i> ${file.name}`;
                        modalHomeworkFiles.appendChild(fileLink);
                    });
                } else {
                    modalHomeworkFiles.innerHTML = '<p>No attachments</p>';
                }
                
                // Display submissions
                modalHomeworkSubmissions.innerHTML = '';
                if (homework.submissions && Object.keys(homework.submissions).length > 0) {
                    Object.entries(homework.submissions).forEach(([studentId, submission]) => {
                        const student = allStudents[studentId];
                        if (!student) return;
                        
                        const submissionDate = new Date(submission.submittedAt).toLocaleString();
                        
                        const submissionItem = document.createElement('div');
                        submissionItem.className = 'submission-item';
                        
                        submissionItem.innerHTML = `
                            <div class="submission-header">
                                <div class="submission-student">${student.name}</div>
                                <div class="submission-date">Submitted: ${submissionDate}</div>
                            </div>
                            <div class="submission-content">${submission.comment || 'No comment'}</div>
                            <div id="submission-files-${studentId}"></div>
                            <div class="submission-grade" id="submission-grade-${studentId}"></div>
                        `;
                        
                        modalHomeworkSubmissions.appendChild(submissionItem);
                        
                        // Display submission files
                        const submissionFilesContainer = document.getElementById(`submission-files-${studentId}`);
                        if (submission.files && submission.files.length > 0) {
                            submission.files.forEach(file => {
                                const fileLink = document.createElement('a');
                                fileLink.href = file.url;
                                fileLink.target = '_blank';
                                fileLink.className = 'submission-file';
                                fileLink.innerHTML = `<i class="${getFileIcon(file.type)}"></i> ${file.name}`;
                                submissionFilesContainer.appendChild(fileLink);
                            });
                        }
                        
                        // Display or add grade
                        const gradeContainer = document.getElementById(`submission-grade-${studentId}`);
                        if (submission.grade) {
                            gradeContainer.innerHTML = `
                                <div>Grade: <span class="grade-display">${submission.grade.score} (${submission.grade.letter})</span></div>
                                <div>Feedback: ${submission.grade.feedback || 'No feedback'}</div>
                            `;
                        } else {
                            gradeContainer.innerHTML = `
                                <div>No grade yet</div>
                                <div class="grade-form">
                                    <input type="number" class="grade-input" id="grade-score-${studentId}" min="0" max="100" placeholder="Score">
                                    <input type="text" class="form-control" id="grade-feedback-${studentId}" placeholder="Feedback">
                                    <button class="btn btn-primary btn-sm" id="save-grade-${studentId}">Save Grade</button>
                                </div>
                            `;
                            
                            document.getElementById(`save-grade-${studentId}`).addEventListener('click', () => {
                                saveHomeworkGrade(homeworkId, studentId);
                            });
                        }
                    });
                } else {
                    modalHomeworkSubmissions.innerHTML = '<p>No submissions yet</p>';
                }
                
                // Show modal
                homeworkDetailModal.style.display = 'flex';
            });
        }

        function saveHomeworkGrade(homeworkId, studentId) {
            const scoreInput = document.getElementById(`grade-score-${studentId}`);
            const feedbackInput = document.getElementById(`grade-feedback-${studentId}`);
            
            const score = parseFloat(scoreInput.value);
            const feedback = feedbackInput.value.trim();
            
            if (isNaN(score)) {
                showNotification('Please enter a valid score', false);
                return;
            }
            
            const letterGrade = calculateLetterGrade(score);
            
            const grade = {
                score,
                letter: letterGrade,
                feedback,
                gradedBy: currentTeacherId,
                gradedAt: new Date().toISOString()
            };
            
            const update = {};
            update[`homework/${homeworkId}/submissions/${studentId}/grade`] = grade;
            
            database.ref().update(update)
                .then(() => {
                    showNotification('Grade saved successfully');
                    viewHomeworkDetails(homeworkId); // Refresh the view
                })
                .catch(error => {
                    console.error('Error saving grade:', error);
                    showNotification('Failed to save grade', false);
                });
        }

        function setupHomeworkSubmissionsListener() {
            const homeworkRef = database.ref('homework');
            
            homeworkRef.orderByChild('assignedBy').equalTo(currentTeacherId).on('child_changed', snapshot => {
                const homework = snapshot.val();
                const notificationMessage = `New submission for ${homework.title} from ${homework.className}`;
                showNotification(notificationMessage);
                
                // Update the homework list if we're on that tab
                if (document.getElementById('homework-tab').classList.contains('active')) {
                    loadHomework();
                }
            });
        }

        function deleteHomework() {
            if (!currentHomeworkId) return;
            
            if (confirm('Are you sure you want to delete this homework assignment?')) {
                const homeworkRef = database.ref(`homework/${currentHomeworkId}`);
                
                // First delete any associated files
                deleteHomeworkFiles(currentHomeworkId)
                    .then(() => {
                        return homeworkRef.remove();
                    })
                    .then(() => {
                        showNotification('Homework deleted successfully!');
                        homeworkDetailModal.style.display = 'none';
                        loadHomework();
                    })
                    .catch(error => {
                        console.error('Error deleting homework:', error);
                        showNotification('Failed to delete homework. Please try again.', false);
                    });
            }
        }

        async function deleteHomeworkFiles(homeworkId) {
            const homeworkRef = database.ref(`homework/${homeworkId}`);
            const snapshot = await homeworkRef.once('value');
            const homework = snapshot.val();
            
            if (!homework || !homework.files || homework.files.length === 0) {
                return Promise.resolve();
            }
            
            const deletePromises = homework.files.map(file => {
                const fileRef = storage.ref(file.path);
                return fileRef.delete().catch(error => {
                    console.error('Error deleting file:', error);
                });
            });
            
            return Promise.all(deletePromises);
        }

        function openEditHomeworkModal() {
            if (!currentHomeworkId) return;
            
            const homeworkRef = database.ref(`homework/${currentHomeworkId}`);
            
            homeworkRef.once('value').then(snapshot => {
                const homework = snapshot.val();
                
                if (!homework) {
                    showNotification('Homework not found', false);
                    return;
                }
                
                // Populate edit form
                editHomeworkId.value = currentHomeworkId;
                editHomeworkTitle.value = homework.title;
                editHomeworkDescription.value = homework.description;
                editHomeworkDueDate.value = homework.dueDate.split('T')[0];
                
                // Display current files
                editHomeworkFiles.innerHTML = '';
                if (homework.files && homework.files.length > 0) {
                    homework.files.forEach(file => {
                        const filePreview = document.createElement('div');
                        filePreview.className = 'file-preview';
                        
                        const icon = document.createElement('i');
                        icon.className = getFileIcon(file.type);
                        
                        const fileInfo = document.createElement('div');
                        fileInfo.className = 'file-preview-info';
                        
                        const fileName = document.createElement('div');
                        fileName.className = 'file-preview-name';
                        fileName.textContent = file.name;
                        
                        const fileSize = document.createElement('div');
                        fileSize.className = 'file-preview-size';
                        fileSize.textContent = formatFileSize(file.size);
                        
                        fileInfo.appendChild(fileName);
                        fileInfo.appendChild(fileSize);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-file';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.addEventListener('click', () => {
                            if (confirm('Are you sure you want to remove this file?')) {
                                removeHomeworkFile(currentHomeworkId, file);
                            }
                        });
                        
                        filePreview.appendChild(icon);
                        filePreview.appendChild(fileInfo);
                        filePreview.appendChild(removeBtn);
                        
                        editHomeworkFiles.appendChild(filePreview);
                    });
                } else {
                    editHomeworkFiles.innerHTML = '<p>No attachments</p>';
                }
                
                // Clear any new files
                editFilePreviewContainer.innerHTML = '';
                newFilesToUpload = [];
                
                // Hide detail modal and show edit modal
                homeworkDetailModal.style.display = 'none';
                editHomeworkModal.style.display = 'flex';
            });
        }

        async function removeHomeworkFile(homeworkId, file) {
            try {
                // Delete file from storage
                const fileRef = storage.ref(file.path);
                await fileRef.delete();
                
                // Remove file reference from homework
                const homeworkRef = database.ref(`homework/${homeworkId}/files`);
                const snapshot = await homeworkRef.once('value');
                const files = snapshot.val() || [];
                
                const updatedFiles = files.filter(f => f.path !== file.path);
                await homeworkRef.set(updatedFiles);
                
                showNotification('File removed successfully');
                openEditHomeworkModal(); // Refresh the edit modal
            } catch (error) {
                console.error('Error removing file:', error);
                showNotification('Failed to remove file', false);
            }
        }

        async function saveHomeworkChanges() {
            const homeworkId = editHomeworkId.value;
            const title = editHomeworkTitle.value.trim();
            const description = editHomeworkDescription.value.trim();
            const dueDate = editHomeworkDueDate.value;
            
            if (!homeworkId || !title || !description || !dueDate) {
                showNotification('Please fill in all fields', false);
                return;
            }
            
            try {
                // Upload any new files
                let uploadedFiles = [];
                if (newFilesToUpload.length > 0) {
                    uploadedFiles = await uploadFiles(newFilesToUpload, homeworkId);
                }
                
                // Get current files
                const homeworkRef = database.ref(`homework/${homeworkId}/files`);
                const snapshot = await homeworkRef.once('value');
                const currentFiles = snapshot.val() || [];
                
                // Combine current files with new ones
                const allFiles = [...currentFiles, ...uploadedFiles];
                
                // Prepare updates
                const updates = {
                    title,
                    description,
                    dueDate,
                    files: allFiles
                };
                
                // Save updates
                await database.ref(`homework/${homeworkId}`).update(updates);
                
                showNotification('Homework updated successfully!');
                editHomeworkModal.style.display = 'none';
                loadHomework();
            } catch (error) {
                console.error('Error updating homework:', error);
                showNotification('Failed to update homework. Please try again.', false);
            }
        }

        function filterStudentsForGrading(e) {
            e.preventDefault();
            
            const subjectId = gradeSubjectSelect.value;
            const classId = gradeClassSelect.value;
            const term = gradeTermSelect.value;
            
            if (!subjectId || !classId || !term) {
                showNotification('Please select a subject, class, and term', false);
                return;
            }
            
            // Save current grading context
            currentGradingContext = {
                subjectId,
                classId,
                term
            };
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            // Find class name
            const className = allClasses[classId]?.name || `Class ${classId}`;
            
            // Update UI
            selectedClassName.textContent = className;
            selectedSubjectName.textContent = subjectName;
            
            // Load students for this class
            loadStudentsForGrading(classId, subjectId, term);
        }

        function loadStudentsForGrading(classId, subjectId, term) {
            // First, find all students in this class
            const classInfo = allClasses[classId];
            if (!classInfo || !classInfo.students || classInfo.students.length === 0) {
                gradeStudentsTable.innerHTML = '<tr><td colspan="8">No students found in this class.</td></tr>';
                studentsToGradeSection.style.display = 'block';
                return;
            }
            
            // Get existing grades for this subject, class, and term
            const gradesRef = database.ref('grades');
            
            gradesRef.orderByChild('class').equalTo(classInfo.name).once('value').then(snapshot => {
                const allGrades = snapshot.val() || {};
                currentGrades = {};
                
                // Filter grades for this subject and term
                for (const gradeId in allGrades) {
                    const grade = allGrades[gradeId];
                    if (grade.subject === subjectId && grade.term === term) {
                        currentGrades[grade.studentId] = {
                            gradeId,
                            ...grade
                        };
                    }
                }
                
                // Display students with their grades
                displayStudentsForGrading(classInfo.students, subjectId, term);
            });
        }

        function displayStudentsForGrading(studentIds, subjectId, term) {
            gradeStudentsTable.innerHTML = '';
            
            if (studentIds.length === 0) {
                gradeStudentsTable.innerHTML = '<tr><td colspan="8">No students found in this class.</td></tr>';
                studentsToGradeSection.style.display = 'block';
                return;
            }
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            studentIds.forEach(studentId => {
                const student = allStudents[studentId];
                if (!student) return;
                
                // Get existing grade if it exists
                const existingGrade = currentGrades[studentId] || {
                    assignments: '',
                    projects: '',
                    classScore: '',
                    finalExam: '',
                    totalScore: '',
                    letterGrade: ''
                };
                
                const row = document.createElement('tr');
                row.dataset.studentId = studentId;
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td><input type="number" class="grade-input" id="assignments-${studentId}" 
                        value="${existingGrade.assignments || ''}" min="0" max="100"></td>
                    <td><input type="number" class="grade-input" id="projects-${studentId}" 
                        value="${existingGrade.projects || ''}" min="0" max="100"></td>
                    <td><input type="number" class="grade-input" id="classScore-${studentId}" 
                        value="${existingGrade.classScore || ''}" min="0" max="100"></td>
                    <td><input type="number" class="grade-input" id="finalExam-${studentId}" 
                        value="${existingGrade.finalExam || ''}" min="0" max="100"></td>
                    <td id="totalScore-${studentId}">${existingGrade.totalScore || ''}</td>
                    <td id="letterGrade-${studentId}">${existingGrade.letterGrade || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm save-grade-btn" data-student-id="${studentId}">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </td>
                `;
                
                gradeStudentsTable.appendChild(row);
                
                // Add event listeners to grade inputs for auto-calculation
                document.getElementById(`assignments-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
                document.getElementById(`projects-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
                document.getElementById(`classScore-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
                document.getElementById(`finalExam-${studentId}`).addEventListener('input', () => calculateTotalGrade(studentId));
                
                // Add event listener to save button
                document.querySelector(`.save-grade-btn[data-student-id="${studentId}"]`).addEventListener('click', () => saveStudentGrade(studentId));
            });
            
            studentsToGradeSection.style.display = 'block';
        }

        function calculateTotalGrade(studentId) {
            const assignments = parseFloat(document.getElementById(`assignments-${studentId}`).value) || 0;
            const projects = parseFloat(document.getElementById(`projects-${studentId}`).value) || 0;
            const classScore = parseFloat(document.getElementById(`classScore-${studentId}`).value) || 0;
            const finalExam = parseFloat(document.getElementById(`finalExam-${studentId}`).value) || 0;
            
            // Get grading weights from settings (default values if not set)
            const assignmentsWeight = 0.2; // 20%
            const projectsWeight = 0.2;    // 20%
            const classScoreWeight = 0.3; // 30%
            const finalExamWeight = 0.3;   // 30%
            
            // Calculate total score
            const totalScore = (assignments * assignmentsWeight) + 
                              (projects * projectsWeight) + 
                              (classScore * classScoreWeight) + 
                              (finalExam * finalExamWeight);
            
            // Round to 1 decimal place
            const roundedScore = Math.round(totalScore * 10) / 10;
            
            // Calculate letter grade
            const letterGrade = calculateLetterGrade(roundedScore);
            
            // Update display
            document.getElementById(`totalScore-${studentId}`).textContent = roundedScore;
            document.getElementById(`letterGrade-${studentId}`).textContent = letterGrade;
        }

        function calculateLetterGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        function saveStudentGrade(studentId) {
            const student = allStudents[studentId];
            if (!student) return;
            
            const assignments = parseFloat(document.getElementById(`assignments-${studentId}`).value) || 0;
            const projects = parseFloat(document.getElementById(`projects-${studentId}`).value) || 0;
            const classScore = parseFloat(document.getElementById(`classScore-${studentId}`).value) || 0;
            const finalExam = parseFloat(document.getElementById(`finalExam-${studentId}`).value) || 0;
            const totalScore = parseFloat(document.getElementById(`totalScore-${studentId}`).textContent) || 0;
            const letterGrade = document.getElementById(`letterGrade-${studentId}`).textContent;
            
            // Find subject name
            const subject = teacherSubjects.find(s => s.id === currentGradingContext.subjectId);
            const subjectName = subject ? subject.name : 'Unknown Subject';
            
            // Find class name
            const className = allClasses[currentGradingContext.classId]?.name || `Class ${currentGradingContext.classId}`;
            
            // Prepare grade object
            const grade = {
                studentId,
                studentName: student.name,
                class: className,
                subject: currentGradingContext.subjectId,
                subjectName,
                term: currentGradingContext.term,
                assignments,
                projects,
                classScore,
                finalExam,
                totalScore,
                letterGrade,
                status: 'draft',
                lastUpdated: new Date().toISOString()
            };
            
            // Check if this student already has a grade record
            const existingGrade = currentGrades[studentId];
            
            let savePromise;
            
            if (existingGrade && existingGrade.gradeId) {
                // Update existing grade
                const gradeRef = database.ref(`grades/${existingGrade.gradeId}`);
                savePromise = gradeRef.update(grade);
            } else {
                // Create new grade
                const gradeRef = database.ref('grades').push();
                savePromise = gradeRef.set(grade);
            }
            
            savePromise
                .then(() => {
                    showNotification(`Grade saved for ${student.name}`);
                    // Reload grades to update currentGrades
                    loadStudentsForGrading(currentGradingContext.classId, currentGradingContext.subjectId, currentGradingContext.term);
                })
                .catch(error => {
                    console.error('Error saving grade:', error);
                    showNotification(`Failed to save grade for ${student.name}. Please try again.`, false);
                });
        }

        function saveAllGrades() {
            if (!currentGradingContext.classId || !currentGradingContext.subjectId || !currentGradingContext.term) {
                showNotification('Please filter students first', false);
                return;
            }
            
            // Get all student rows
            const studentRows = gradeStudentsTable.querySelectorAll('tr[data-student-id]');
            
            if (studentRows.length === 0) {
                showNotification('No students to save', false);
                return;
            }
            
            // Save each student's grade
            let saveCount = 0;
            const totalStudents = studentRows.length;
            
            studentRows.forEach(row => {
                const studentId = row.dataset.studentId;
                saveStudentGrade(studentId);
                saveCount++;
            });
            
            showNotification(`Grades for ${saveCount} students are being saved.`);
        }

        // Initialize the app
        loadingScreen.style.display = 'flex';
        mainContent.style.display = 'none';
        checkAuthState();
    </script>
</body>
</html>
