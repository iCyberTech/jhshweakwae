<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --info-color: #4895ef;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main Container */
        #main-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Sidebar */
        #sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid var(--light-gray);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
        }

        .user-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-student {
            background-color: var(--success-color);
            color: white;
        }

        .badge-teacher {
            background-color: var(--primary-color);
            color: white;
        }

        .badge-alumni {
            background-color: var(--accent-color);
            color: white;
        }

        .search-container {
            padding: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .tab:hover {
            background-color: var(--light-gray);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab i {
            width: 20px;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .note-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .note-item:hover {
            background-color: var(--light-gray);
        }

        .note-item.active {
            background-color: rgba(67, 97, 238, 0.1);
            border-left: 3px solid var(--primary-color);
        }

        .note-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-item-title {
            font-weight: 600;
            font-size: 16px;
        }

        .note-item-date {
            font-size: 12px;
            color: var(--gray-color);
        }

        .note-item-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-item-content {
            font-size: 14px;
            color: var(--gray-color);
        }

        .new-note-btn {
            margin: 15px;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }

        .new-note-btn:hover {
            background-color: var(--secondary-color);
        }

        /* Main Content */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: white;
        }

        .content-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            display: none;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-right: 15px;
        }

        .header-title {
            font-weight: 600;
            font-size: 18px;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--gray-color);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 12px;
            background: none;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .header-btn:hover {
            background-color: var(--light-gray);
        }

        .btn-delete {
            color: var(--warning-color);
        }

        .btn-delete:hover {
            background-color: rgba(247, 37, 133, 0.1);
        }

        .btn-share {
            color: var(--info-color);
        }

        .btn-share:hover {
            background-color: rgba(72, 149, 239, 0.1);
        }

        /* Empty State */
        #empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .empty-icon {
            font-size: 60px;
            color: var(--light-gray);
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-message {
            color: var(--gray-color);
            margin-bottom: 20px;
            max-width: 300px;
        }

        /* Note Editor */
        #note-editor-container {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .editor-section {
            margin-bottom: 20px;
        }

        .editor-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .editor-input, .editor-select, .editor-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .editor-textarea {
            min-height: 200px;
            resize: vertical;
        }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .week-nav-btn {
            background: none;
            border: 1px solid var(--light-gray);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .week-nav-btn:hover {
            background-color: var(--light-gray);
        }

        .week-display {
            font-weight: 600;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .week-day {
            text-align: center;
            padding: 10px 5px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .week-day:hover {
            background-color: var(--light-gray);
        }

        .week-day.active {
            background-color: var(--primary-color);
            color: white;
        }

        .week-day.has-notes::after {
            content: "";
            display: block;
            width: 5px;
            height: 5px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin: 5px auto 0;
        }

        .week-day-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .week-day-number {
            font-size: 14px;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .editor-btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-cancel {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }

        .btn-cancel:hover {
            background-color: #dcdde1;
        }

        .btn-save {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-save:hover {
            background-color: var(--secondary-color);
        }

        /* Notifications */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 350px;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.hide {
            opacity: 0;
            transform: translateX(100%);
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.success .notification-icon {
            color: var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--warning-color);
        }

        .notification.error .notification-icon {
            color: var(--warning-color);
        }

        .notification.warning {
            border-left: 4px solid orange;
        }

        .notification.warning .notification-icon {
            color: orange;
        }

        .notification.info {
            border-left: 4px solid var(--info-color);
        }

        .notification.info .notification-icon {
            color: var(--info-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--gray-color);
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--gray-color);
            flex-shrink: 0;
        }

        /* Share Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-title {
            font-weight: 600;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .share-group {
            margin-bottom: 20px;
        }

        .members-list {
            margin-top: 15px;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
        }

        .member-role {
            font-size: 12px;
            color: var(--gray-color);
        }

        .member-status {
            margin-left: 10px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel {
            background-color: var(--light-gray);
        }

        .btn-confirm {
            background-color: var(--primary-color);
            color: white;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 100%;
                max-width: 300px;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }
            
            #sidebar:not(.hidden) {
                transform: translateX(0);
            }
            
            .back-btn {
                display: block;
            }
            
            #main-content.active {
                width: 100%;
            }
            
            .content-header {
                padding: 12px 15px;
            }
            
            #note-editor-container {
                padding: 15px;
            }
            
            .week-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 3px;
            }
            
            .week-day {
                padding: 8px 3px;
            }
            
            .week-day-name {
                font-size: 10px;
            }
            
            .week-day-number {
                font-size: 12px;
            }
            
            .notification {
                max-width: calc(100% - 40px);
            }
        }

        @media (max-width: 480px) {
            .header-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .header-btn {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .editor-actions {
                flex-direction: column;
            }
            
            .editor-btn {
                width: 100%;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Loading your notes...</p>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Main Container -->
    <div id="main-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <img src="" alt="User Avatar" class="user-avatar" id="user-avatar">
                <div class="user-info">
                    <div class="user-name" id="user-name">User Name</div>
                    <div class="user-badge" id="user-badge">Role</div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Search notes...">
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="my-notes">
                    <i class="fas fa-sticky-note"></i>
                    <span>My Notes</span>
                </div>
                <div class="tab" data-tab="shared">
                    <i class="fas fa-share-alt"></i>
                    <span>Shared With Me</span>
                </div>
                <div class="tab" data-tab="class-notes">
                    <i class="fas fa-users"></i>
                    <span>Class Notes</span>
                </div>
            </div>

            <div class="notes-list" id="notes-list">
                <!-- Notes will be populated here -->
            </div>

            <button class="new-note-btn" id="new-note-sidebar-btn">
                <i class="fas fa-plus"></i>
                <span>New Note</span>
            </button>
        </aside>

        <!-- Main Content -->
        <main id="main-content">
            <div class="content-header">
                <button class="back-btn" id="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="header-info">
                    <div class="header-title" id="content-header-title">Notes</div>
                    <div class="header-subtitle" id="content-header-subtitle">Your personal notes</div>
                </div>
                <div class="header-actions">
                    <button class="header-btn btn-share" id="share-btn">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </button>
                    <button class="header-btn btn-delete" id="delete-btn">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state">
                <i class="fas fa-sticky-note empty-icon"></i>
                <h3 class="empty-title">No Note Selected</h3>
                <p class="empty-message">Select a note from the list or create a new one to get started.</p>
                <button class="new-note-btn" id="new-note-btn">
                    <i class="fas fa-plus"></i>
                    <span>Create New Note</span>
                </button>
            </div>

            <!-- Note Editor -->
            <div id="note-editor-container">
                <div class="editor-section">
                    <label class="editor-label" for="note-title">Title</label>
                    <input type="text" class="editor-input" id="note-title" placeholder="Note title">
                </div>

                <div class="editor-section">
                    <label class="editor-label" for="note-subject">Subject</label>
                    <select class="editor-select" id="note-subject">
                        <option value="">Select Subject</option>
                    </select>
                </div>

                <div class="editor-section">
                    <label class="editor-label" for="note-class">Class</label>
                    <select class="editor-select" id="note-class">
                        <option value="">Select Class</option>
                    </select>
                </div>

                <div class="editor-section">
                    <label class="editor-label">Week</label>
                    <div class="week-selector">
                        <button class="week-nav-btn" id="prev-week-btn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="week-display" id="current-week-display">Week 1</div>
                        <button class="week-nav-btn" id="next-week-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <select class="editor-select" id="note-week">
                            <option value="1">Week 1</option>
                            <option value="2">Week 2</option>
                            <option value="3">Week 3</option>
                            <option value="4">Week 4</option>
                            <option value="5">Week 5</option>
                            <option value="6">Week 6</option>
                            <option value="7">Week 7</option>
                            <option value="8">Week 8</option>
                            <option value="9">Week 9</option>
                            <option value="10">Week 10</option>
                            <option value="11">Week 11</option>
                            <option value="12">Week 12</option>
                        </select>
                    </div>
                    
                    <div class="week-grid" id="week-grid">
                        <!-- Week days will be populated here -->
                    </div>
                </div>

                <div class="editor-section">
                    <label class="editor-label" for="note-content">Content</label>
                    <textarea class="editor-textarea" id="note-content" placeholder="Write your note here..."></textarea>
                </div>

                <div class="editor-actions">
                    <button class="editor-btn btn-cancel" id="cancel-btn">Cancel</button>
                    <button class="editor-btn btn-save" id="save-btn">Save Note</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Share Note</h3>
                <button class="modal-close" id="close-share-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="share-group">
                    <label class="editor-label">Share with Group</label>
                    <select class="editor-select" id="share-group">
                        <option value="">Select Group</option>
                    </select>
                </div>
                
                <div class="members-list" id="share-members-list">
                    <!-- Members will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="cancel-share-btn">Cancel</button>
                <button class="modal-btn btn-confirm" id="confirm-share-btn">Share</button>
            </div>
        </div>
    </div>

    <script type="module">
        // The full JavaScript code from your original message goes here
        // I've included the complete JS code in the script tag below
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, push, update, onValue, onChildAdded, onChildChanged, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Firebase configuration (same as connect.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAkrHsyfCTijqKP7UJv0eSx0iNvl8S06U8",
            authDomain: "sms-single.firebaseapp.com",
            projectId: "sms-single",
            storageBucket: "sms-single.appspot.com",
            messagingSenderId: "140188895278",
            appId: "1:140188895278:web:1b56660a13e5b088ce77bf",
            measurementId: "G-7ER348P6VZ"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContainer = document.getElementById('main-container');
        const notificationContainer = document.getElementById('notification-container');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const emptyState = document.getElementById('empty-state');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userBadge = document.getElementById('user-badge');
        const searchInput = document.getElementById('search-input');
        const tabs = document.querySelectorAll('.tab');
        const notesList = document.getElementById('notes-list');
        const backBtn = document.getElementById('back-btn');
        const contentHeaderTitle = document.getElementById('content-header-title');
        const contentHeaderSubtitle = document.getElementById('content-header-subtitle');
        const shareBtn = document.getElementById('share-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const noteEditorContainer = document.getElementById('note-editor-container');
        const noteSubject = document.getElementById('note-subject');
        const noteClass = document.getElementById('note-class');
        const noteWeekDropdown = document.getElementById('note-week');
        const noteTitle = document.getElementById('note-title');
        const noteContent = document.getElementById('note-content');
        const cancelBtn = document.getElementById('cancel-btn');
        const saveBtn = document.getElementById('save-btn');
        const newNoteBtn = document.getElementById('new-note-btn');
        const newNoteSidebarBtn = document.getElementById('new-note-sidebar-btn');
        
        // Week selector elements
        const currentWeekDisplay = document.getElementById('current-week-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const weekGrid = document.getElementById('week-grid');
        
        // Modal elements
        const shareModal = document.getElementById('share-modal');
        const closeShareModal = document.getElementById('close-share-modal');
        const cancelShareBtn = document.getElementById('cancel-share-btn');
        const confirmShareBtn = document.getElementById('confirm-share-btn');
        const shareMembersList = document.getElementById('share-members-list');
        const shareGroup = document.getElementById('share-group');
        
        // Firebase references
        const authUsersRef = ref(db, 'authUsers');
        const teachersRef = ref(db, 'teachers');
        const studentsRef = ref(db, 'students');
        const alumniRef = ref(db, 'alumni');
        const credentialsRef = ref(db, 'credentials');
        const classesRef = ref(db, 'classes');
        const subjectsRef = ref(db, 'subjects');
        const notesRef = ref(db, 'notes');
        const sharedNotesRef = ref(db, 'sharedNotes');
        const activeSessionsRef = ref(db, 'activeSessions');
        
        // Global variables
        let currentUserId = null;
        let currentUserData = null;
        let userType = null; // 'student', 'teacher', or 'alumni'
        let allTeachers = {};
        let allStudents = {};
        let allAlumni = {};
        let allClasses = {};
        let allSubjects = {};
        let currentNote = null;
        let userClasses = [];
        let userSubjects = [];
        let isNewNote = false;
        let currentWeek = 1;
        let notesByWeek = {};
        
        // Show notification function (same as connect.html)
        function showNotification({ title, message, type = 'info', duration = 5000 }) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas fa-${iconMap[type]} notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Trigger reflow to enable animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto-dismiss after duration
            let timeoutId;
            if (duration > 0) {
                timeoutId = setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.add('hide');
                    
                    // Remove after animation completes
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
            
            // Close button handler
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                clearTimeout(timeoutId);
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
            
            return notification;
        }
        
        // Identify the current user based on device info (same as connect.html)
        async function identifyCurrentUser() {
            try {
                // Get all auth users
                const authUsersSnapshot = await get(authUsersRef);
                if (!authUsersSnapshot.exists()) {
                    throw new Error('No auth users found');
                }
                
                const authUsers = authUsersSnapshot.val();
                const credentialsSnapshot = await get(credentialsRef);
                const credentials = credentialsSnapshot.exists() ? credentialsSnapshot.val() : {};
                
                // Get current device info from browser
                const userAgent = navigator.userAgent;
                const screenResolution = `${window.screen.width}x${window.screen.height}`;
                const language = navigator.language;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // Find matching user based on device info
                for (const [authId, authUser] of Object.entries(authUsers)) {
                    const userCredential = credentials[authUser.userId];
                    if (userCredential && userCredential.deviceInfo) {
                        const deviceInfo = userCredential.deviceInfo;
                        
                        // Check for matching device characteristics
                        if (deviceInfo.userAgent === userAgent && 
                            deviceInfo.screenResolution === screenResolution &&
                            deviceInfo.language === language && 
                            deviceInfo.timezone === timezone) {
                            
                            // This is likely the current user
                            currentUserId = authUser.userId;
                            userType = authUser.userType; // 'student', 'teacher', or 'alumni'
                            
                            // Get user details from appropriate collection
                            let userRef;
                            if (userType === 'teacher') {
                                userRef = ref(db, `teachers/${currentUserId}`);
                            } else if (userType === 'student') {
                                userRef = ref(db, `students/${currentUserId}`);
                            } else if (userType === 'alumni') {
                                userRef = ref(db, `alumni/${currentUserId}`);
                            } else {
                                throw new Error('Unknown user type');
                            }
                            
                            const userSnapshot = await get(userRef);
                            
                            if (userSnapshot.exists()) {
                                currentUserData = userSnapshot.val();
                                return currentUserData;
                            }
                        }
                    }
                }
                
                // If no match found, try to get from activeSessions as fallback
                const activeSessionSnapshot = await get(activeSessionsRef);
                if (activeSessionSnapshot.exists()) {
                    const activeSessions = activeSessionSnapshot.val();
                    
                    if (activeSessions.student) {
                        currentUserId = activeSessions.student;
                        userType = 'student';
                    } else if (activeSessions.teacher) {
                        currentUserId = activeSessions.teacher;
                        userType = 'teacher';
                    } else if (activeSessions.alumni) {
                        currentUserId = activeSessions.alumni;
                        userType = 'alumni';
                    }
                    
                    if (currentUserId) {
                        let userRef;
                        if (userType === 'teacher') {
                            userRef = ref(db, `teachers/${currentUserId}`);
                        } else if (userType === 'student') {
                            userRef = ref(db, `students/${currentUserId}`);
                        } else if (userType === 'alumni') {
                            userRef = ref(db, `alumni/${currentUserId}`);
                        }
                        
                        const userSnapshot = await get(userRef);
                        
                        if (userSnapshot.exists()) {
                            currentUserData = userSnapshot.val();
                            return currentUserData;
                        }
                    }
                }
                
                throw new Error('No matching user found');
            } catch (error) {
                console.error('Error identifying user:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to identify user: ' + error.message,
                    type: 'error'
                });
                return null;
            }
        }
        
        // Initialize the app
        async function initApp() {
            try {
                // First try to identify the user based on device info
                const user = await identifyCurrentUser();
                
                if (user) {
                    // Update UI with user info
                    userName.textContent = user.name || 'User';
                    
                    // Set user badge
                    if (userType === 'student') {
                        userBadge.textContent = 'Student';
                        userBadge.className = 'user-badge badge-student';
                    } else if (userType === 'teacher') {
                        userBadge.textContent = 'Teacher';
                        userBadge.className = 'user-badge badge-teacher';
                    } else if (userType === 'alumni') {
                        userBadge.textContent = 'Alumni';
                        userBadge.className = 'user-badge badge-alumni';
                    }
                    
                    // Set avatar - use profileImage if available, otherwise use dicebear
                    const avatarUrl = user.profileImage || user.avatar || 
                        `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUserId}`;
                    userAvatar.src = avatarUrl;
                    
                    // Load all teachers, students, and alumni
                    await loadAllUsers();
                    
                    // Load all classes and subjects
                    await loadAllClasses();
                    await loadAllSubjects();
                    
                    // Determine user's classes and subjects
                    await determineUserClassesAndSubjects();
                    
                    // Populate subject and class dropdowns
                    populateDropdowns();
                    
                    // Initialize week selector
                    initializeWeekSelector();
                    
                    // Set up event listeners
                    setupEventListeners();
                    
                    // Load notes
                    await loadNotes();
                    
                    // Hide loading screen and show main content
                    loadingScreen.style.display = 'none';
                    mainContainer.style.display = 'flex';
                    
                    showNotification({
                        title: 'Welcome Back',
                        message: `You're logged in as ${user.name || 'User'}`,
                        type: 'success',
                        duration: 3000
                    });
                    
                    return;
                }
                
                // If no user identified
                showNotification({
                    title: 'Session Expired',
                    message: 'Please sign in again',
                    type: 'error',
                    duration: 0
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to load user information',
                    type: 'error'
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        // Load all users (teachers, students, alumni)
        async function loadAllUsers() {
            // Load teachers
            const teachersSnapshot = await get(teachersRef);
            allTeachers = teachersSnapshot.exists() ? teachersSnapshot.val() : {};
            
            // Load students
            const studentsSnapshot = await get(studentsRef);
            allStudents = studentsSnapshot.exists() ? studentsSnapshot.val() : {};
            
            // Load alumni
            const alumniSnapshot = await get(alumniRef);
            allAlumni = alumniSnapshot.exists() ? alumniSnapshot.val() : {};
        }
        
        // Load all classes
        async function loadAllClasses() {
            const snapshot = await get(classesRef);
            allClasses = snapshot.exists() ? snapshot.val() : {};
        }
        
        // Load all subjects
        async function loadAllSubjects() {
            const snapshot = await get(subjectsRef);
            allSubjects = snapshot.exists() ? snapshot.val() : {};
        }
        
        // Determine which classes and subjects the user is associated with
        async function determineUserClassesAndSubjects() {
            userClasses = [];
            userSubjects = [];
            
            if (userType === 'student') {
                // For students, get their class from student data
                if (currentUserData.class) {
                    userClasses.push(currentUserData.class);
                    
                    // Find subjects taught in this class
                    for (const subjectId in allSubjects) {
                        const subject = allSubjects[subjectId];
                        if (subject.class === currentUserData.class) {
                            userSubjects.push({
                                id: subjectId,
                                ...subject
                            });
                        }
                    }
                }
            } else if (userType === 'teacher') {
                // For teachers, get classes and subjects they teach
                for (const subjectId in allSubjects) {
                    const subject = allSubjects[subjectId];
                    if (subject.teacher === currentUserId) {
                        userSubjects.push({
                            id: subjectId,
                            ...subject
                        });
                        
                        if (subject.class && !userClasses.includes(subject.class)) {
                            userClasses.push(subject.class);
                        }
                    }
                }
            } else if (userType === 'alumni') {
                // For alumni, we might want to show notes from their previous classes
                if (currentUserData.previousClass) {
                    userClasses.push(currentUserData.previousClass);
                    
                    // Find subjects from their previous class
                    for (const subjectId in allSubjects) {
                        const subject = allSubjects[subjectId];
                        if (subject.class === currentUserData.previousClass) {
                            userSubjects.push({
                                id: subjectId,
                                ...subject
                            });
                        }
                    }
                }
            }
        }
        
        // Populate subject and class dropdowns
        function populateDropdowns() {
            // Clear existing options
            noteSubject.innerHTML = '<option value="">Select Subject</option>';
            noteClass.innerHTML = '<option value="">Select Class</option>';
            
            // Add subjects based on user type
            if (userType === 'teacher') {
                // Teachers can select any subject they teach
                userSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    noteSubject.appendChild(option);
                });
            } else if (userType === 'student') {
                // Students can only see subjects from their class
                userSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    noteSubject.appendChild(option);
                });
            }
            
            // Add classes based on user type
            if (userType === 'teacher') {
                // Teachers can select any class they teach
                userClasses.forEach(classId => {
                    const classData = allClasses[classId];
                    if (classData) {
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = classData.name;
                        noteClass.appendChild(option);
                    }
                });
            } else if (userType === 'student') {
                // Students can only see their own class
                if (currentUserData.class) {
                    const classData = allClasses[currentUserData.class];
                    if (classData) {
                        const option = document.createElement('option');
                        option.value = currentUserData.class;
                        option.textContent = classData.name;
                        noteClass.appendChild(option);
                    }
                }
            }
        }
        
        // Initialize the week selector
        function initializeWeekSelector() {
            // Create day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            // Generate week grid
            weekGrid.innerHTML = '';
            days.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'week-day';
                dayElement.innerHTML = `
                    <div class="week-day-name">${day}</div>
                    <div class="week-day-number"></div>
                `;
                weekGrid.appendChild(dayElement);
            });
            
            // Set initial week
            setWeek(1);
            
            // Event listeners for week navigation
            prevWeekBtn.addEventListener('click', () => {
                if (currentWeek > 1) {
                    setWeek(currentWeek - 1);
                    noteWeekDropdown.value = currentWeek;
                }
            });
            
            nextWeekBtn.addEventListener('click', () => {
                if (currentWeek < 12) {
                    setWeek(currentWeek + 1);
                    noteWeekDropdown.value = currentWeek;
                }
            });
            
            // Event listener for dropdown
            noteWeekDropdown.addEventListener('change', (e) => {
                const week = parseInt(e.target.value);
                if (week >= 1 && week <= 12) {
                    setWeek(week);
                }
            });
            
            // Click handler for day cells
            weekGrid.addEventListener('click', (e) => {
                const dayElement = e.target.closest('.week-day');
                if (dayElement) {
                    // For now, just highlight the clicked day
                    document.querySelectorAll('.week-day').forEach(day => {
                        day.classList.remove('active');
                    });
                    dayElement.classList.add('active');
                    
                    // In a future enhancement, we could load notes for this specific day
                }
            });
        }
        
        // Set the current week and update the display
        function setWeek(week) {
            currentWeek = week;
            currentWeekDisplay.textContent = `Week ${week}`;
            
            // Calculate dates for this week (assuming a 12-week semester starting from current date)
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay() + (week - 1) * 7); // Start of week
            
            // Update day numbers
            const dayNumbers = weekGrid.querySelectorAll('.week-day-number');
            dayNumbers.forEach((dayNumber, index) => {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + index);
                dayNumber.textContent = dayDate.getDate();
                
                // Check if this day has notes (for indicator dots)
                const dayKey = `${dayDate.getFullYear()}-${dayDate.getMonth() + 1}-${dayDate.getDate()}`;
                const dayElement = dayNumber.closest('.week-day');
                
                if (notesByWeek[week] && notesByWeek[week][dayKey]) {
                    dayElement.classList.add('has-notes');
                } else {
                    dayElement.classList.remove('has-notes');
                }
                
                // Highlight today if it's in this week
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('active');
                } else {
                    dayElement.classList.remove('active');
                }
            });
            
            // Update dropdown to match
            noteWeekDropdown.value = week;
            
            // If we're editing a note and it's for this week, highlight it
            if (currentNote && currentNote.week == week) {
                highlightActiveNote();
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Reload notes based on selected tab
                    loadNotes();
                });
            });
            
            // Back button (for mobile)
            backBtn.addEventListener('click', () => {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('active');
                emptyState.style.display = 'flex';
                noteEditorContainer.style.display = 'none';
                currentNote = null;
            });
            
            // New note buttons
            newNoteBtn.addEventListener('click', createNewNote);
            newNoteSidebarBtn.addEventListener('click', createNewNote);
            
            // Save note button
            saveBtn.addEventListener('click', saveNote);
            
            // Cancel button
            cancelBtn.addEventListener('click', () => {
                if (isNewNote) {
                    // If it's a new note, go back to empty state
                    emptyState.style.display = 'flex';
                    noteEditorContainer.style.display = 'none';
                    currentNote = null;
                    isNewNote = false;
                } else if (currentNote) {
                    // If editing existing note, reload it to discard changes
                    loadNote(currentNote.id);
                }
            });
            
            // Share button
            shareBtn.addEventListener('click', showShareModal);
            
            // Delete button
            deleteBtn.addEventListener('click', deleteNote);
            
            // Search input
            searchInput.addEventListener('input', (e) => {
                filterNotes(e.target.value);
            });
            
            // Window resize handler
            window.addEventListener('resize', handleResize);
            
            // Modal event listeners
            closeShareModal.addEventListener('click', () => {
                shareModal.style.display = 'none';
            });
            
            cancelShareBtn.addEventListener('click', () => {
                shareModal.style.display = 'none';
            });
            
            confirmShareBtn.addEventListener('click', shareNote);
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    shareModal.style.display = 'none';
                }
            });
        }
        
        // Handle window resize
        function handleResize() {
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('hidden');
                mainContent.classList.add('active');
                
                if (currentNote) {
                    emptyState.style.display = 'none';
                } else {
                    emptyState.style.display = 'flex';
                }
            }
        }
        
        // Load notes based on selected tab
        async function loadNotes() {
            notesList.innerHTML = '';
            notesByWeek = {}; // Reset notes by week cache
            
            const selectedTab = document.querySelector('.tab.active').getAttribute('data-tab');
            
            if (selectedTab === 'my-notes') {
                await loadMyNotes();
            } else if (selectedTab === 'shared') {
                await loadSharedNotes();
            } else if (selectedTab === 'class-notes') {
                await loadClassNotes();
            }
            
            // Update week indicators
            setWeek(currentWeek);
        }
        
        // Load user's own notes
        async function loadMyNotes() {
            const notesSnapshot = await get(ref(db, `notes/${currentUserId}`));
            const notes = notesSnapshot.exists() ? notesSnapshot.val() : {};
            
            const notesArray = [];
            
            for (const noteId in notes) {
                const note = {
                    id: noteId,
                    ...notes[noteId]
                };
                notesArray.push(note);
                
                // Organize notes by week for the calendar view
                const week = note.week || 1;
                if (!notesByWeek[week]) notesByWeek[week] = {};
                
                // For calendar indicators, we'll use the creation date
                const noteDate = new Date(note.createdAt || new Date().toISOString());
                const dateKey = `${noteDate.getFullYear()}-${noteDate.getMonth() + 1}-${noteDate.getDate()}`;
                
                if (!notesByWeek[week][dateKey]) {
                    notesByWeek[week][dateKey] = true;
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Notes Found</h3>
                    <p>You haven't created any notes yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Load notes shared with the user
        async function loadSharedNotes() {
            const sharedSnapshot = await get(ref(db, `sharedNotes/${currentUserId}`));
            const sharedNotes = sharedSnapshot.exists() ? sharedSnapshot.val() : {};
            
            const notesArray = [];
            
            for (const noteId in sharedNotes) {
                // Get the actual note
                const noteOwner = sharedNotes[noteId].ownerId;
                const noteSnapshot = await get(ref(db, `notes/${noteOwner}/${noteId}`));
                
                if (noteSnapshot.exists()) {
                    const note = {
                        id: noteId,
                        ownerId: noteOwner,
                        ...noteSnapshot.val()
                    };
                    notesArray.push(note);
                    
                    // Organize notes by week for the calendar view
                    const week = note.week || 1;
                    if (!notesByWeek[week]) notesByWeek[week] = {};
                    
                    const noteDate = new Date(note.createdAt || new Date().toISOString());
                    const dateKey = `${noteDate.getFullYear()}-${noteDate.getMonth() + 1}-${noteDate.getDate()}`;
                    
                    if (!notesByWeek[week][dateKey]) {
                        notesByWeek[week][dateKey] = true;
                    }
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note, true);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Shared Notes</h3>
                    <p>No one has shared any notes with you yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Load class notes (for students)
        async function loadClassNotes() {
            if (userType !== 'student') {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>Class Notes</h3>
                    <p>This section is only available to students.</p>
                `;
                notesList.appendChild(emptyItem);
                return;
            }
            
            // Get all notes from teachers of this student's subjects
            const notesArray = [];
            
            for (const subject of userSubjects) {
                if (subject.teacher) {
                    const teacherNotesSnapshot = await get(ref(db, `notes/${subject.teacher}`));
                    const teacherNotes = teacherNotesSnapshot.exists() ? teacherNotesSnapshot.val() : {};
                    
                    for (const noteId in teacherNotes) {
                        const note = teacherNotes[noteId];
                        
                        // Check if note is for this student's class and subject
                        if (note.classId === currentUserData.class && note.subjectId === subject.id) {
                            const fullNote = {
                                id: noteId,
                                ownerId: subject.teacher,
                                ...note
                            };
                            notesArray.push(fullNote);
                            
                            // Organize notes by week for the calendar view
                            const week = note.week || 1;
                            if (!notesByWeek[week]) notesByWeek[week] = {};
                            
                            const noteDate = new Date(note.createdAt || new Date().toISOString());
                            const dateKey = `${noteDate.getFullYear()}-${noteDate.getMonth() + 1}-${noteDate.getDate()}`;
                            
                            if (!notesByWeek[week][dateKey]) {
                                notesByWeek[week][dateKey] = true;
                            }
                        }
                    }
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note, true);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Class Notes</h3>
                    <p>Your teachers haven't shared any notes for your class yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Create a note list item
        function createNoteItem(note, isShared = false) {
            const noteItem = document.createElement('div');
            noteItem.className = 'note-item';
            noteItem.setAttribute('data-note-id', note.id);
            
            // Get subject and class names
            const subjectName = allSubjects[note.subjectId]?.name || 'Unknown Subject';
            const className = allClasses[note.classId]?.name || 'Unknown Class';
            
            noteItem.innerHTML = `
                <div class="note-item-header">
                    <div class="note-item-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-item-date">${formatDate(note.updatedAt || note.createdAt)}</div>
                </div>
                <div class="note-item-preview">
                    <div class="note-item-content">
                        ${subjectName} • ${className} • Week ${note.week || 'N/A'}
                    </div>
                    ${isShared ? '<div class="user-badge" style="background-color: var(--secondary-color); color: white;">Shared</div>' : ''}
                </div>
            `;
            
            // Add click handler to open note
            noteItem.addEventListener('click', () => openNote(note));
            
            return noteItem;
        }
        
        // Filter notes based on search input
        function filterNotes(searchTerm) {
            const term = searchTerm.toLowerCase();
            const items = notesList.querySelectorAll('.note-item');
            
            items.forEach(item => {
                const title = item.querySelector('.note-item-title').textContent.toLowerCase();
                const content = item.querySelector('.note-item-content').textContent.toLowerCase();
                
                if (title.includes(term) || content.includes(term)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Create a new note
        function createNewNote() {
            currentNote = null;
            isNewNote = true;
            
            // Reset form
            noteTitle.value = '';
            noteContent.value = '';
            noteSubject.value = '';
            noteClass.value = '';
            setWeek(1); // Default to week 1
            
            // Update UI
            contentHeaderTitle.textContent = 'New Note';
            contentHeaderSubtitle.textContent = 'Create a new lesson note';
            
            // For teachers, allow selecting subject and class
            if (userType === 'teacher') {
                noteSubject.disabled = false;
                noteClass.disabled = false;
            } else {
                // For students, set to their class and first subject (can be changed)
                if (currentUserData.class) {
                    noteClass.value = currentUserData.class;
                    noteClass.disabled = true;
                    
                    if (userSubjects.length > 0) {
                        noteSubject.value = userSubjects[0].id;
                    }
                }
            }
            
            // Show editor and hide empty state
            emptyState.style.display = 'none';
            noteEditorContainer.style.display = 'flex';
            
            // For mobile, hide sidebar and show main content
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden');
                mainContent.classList.add('active');
            }
            
            // Focus on title
            noteTitle.focus();
        }
        
        // Open a note for viewing/editing
        async function openNote(note) {
            currentNote = note;
            isNewNote = false;
            
            // Load note details
            loadNote(note.id);
            
            // Update UI
            contentHeaderTitle.textContent = note.title || 'Untitled Note';
            contentHeaderSubtitle.textContent = `Last updated: ${formatDate(note.updatedAt || note.createdAt)}`;
            
            // Show editor and hide empty state
            emptyState.style.display = 'none';
            noteEditorContainer.style.display = 'flex';
            
            // For mobile, hide sidebar and show main content
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden');
                mainContent.classList.add('active');
            }
            
            // Set the week for this note
            if (note.week) {
                setWeek(parseInt(note.week));
                noteWeekDropdown.value = note.week;
            }
            
            // Highlight active note in list
            highlightActiveNote();
        }
        
        // Load note details
        async function loadNote(noteId) {
            let note;
            
            if (currentNote.ownerId && currentNote.ownerId !== currentUserId) {
                // This is a shared note, get from owner's notes
                const noteSnapshot = await get(ref(db, `notes/${currentNote.ownerId}/${noteId}`));
                note = noteSnapshot.exists() ? noteSnapshot.val() : null;
            } else {
                // This is the user's own note
                const noteSnapshot = await get(ref(db, `notes/${currentUserId}/${noteId}`));
                note = noteSnapshot.exists() ? noteSnapshot.val() : null;
            }
            
            if (!note) {
                showNotification({
                    title: 'Error',
                    message: 'Note not found',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            // Update form fields
            noteTitle.value = note.title || '';
            noteContent.value = note.content || '';
            noteSubject.value = note.subjectId || '';
            noteClass.value = note.classId || '';
            setWeek(note.week || 1);
            noteWeekDropdown.value = note.week || '';
            
            // Disable editing if this is a shared note and user is not the owner
            if (currentNote.ownerId && currentNote.ownerId !== currentUserId) {
                noteTitle.readOnly = true;
                noteContent.readOnly = true;
                noteSubject.disabled = true;
                noteClass.disabled = true;
                noteWeekDropdown.disabled = true;
                saveBtn.style.display = 'none';
            } else {
                noteTitle.readOnly = false;
                noteContent.readOnly = false;
                noteSubject.disabled = false;
                noteClass.disabled = false;
                noteWeekDropdown.disabled = false;
                saveBtn.style.display = 'block';
            }
        }
        
        // Save note
        async function saveNote() {
            const title = noteTitle.value.trim();
            const content = noteContent.value.trim();
            const subjectId = noteSubject.value;
            const classId = noteClass.value;
            const week = currentWeek;
            
            if (!title) {
                showNotification({
                    title: 'Error',
                    message: 'Please enter a title for your note',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            if (!subjectId || !classId || !week) {
                showNotification({
                    title: 'Error',
                    message: 'Please select subject, class, and week',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            try {
                const now = new Date().toISOString();
                const noteData = {
                    title: title,
                    content: content,
                    subjectId: subjectId,
                    classId: classId,
                    week: week,
                    updatedAt: now,
                    ownerName: currentUserData.name
                };
                
                if (isNewNote) {
                    // Create new note
                    noteData.createdAt = now;
                    const newNoteRef = push(ref(db, `notes/${currentUserId}`));
                    await set(newNoteRef, noteData);
                    
                    currentNote = {
                        id: newNoteRef.key,
                        ...noteData
                    };
                    
                    showNotification({
                        title: 'Success',
                        message: 'Note created successfully',
                        type: 'success',
                        duration: 3000
                    });
                } else {
                    // Update existing note
                    noteData.createdAt = currentNote.createdAt;
                    await set(ref(db, `notes/${currentUserId}/${currentNote.id}`), noteData);
                    
                    currentNote = {
                        ...currentNote,
                        ...noteData
                    };
                    
                    showNotification({
                        title: 'Success',
                        message: 'Note updated successfully',
                        type: 'success',
                        duration: 3000
                    });
                }
                
                // Update UI
                contentHeaderTitle.textContent = title;
                contentHeaderSubtitle.textContent = `Last updated: ${formatDate(now)}`;
                
                // Reload notes list
                await loadNotes();
                
                // Highlight the updated/created note
                highlightActiveNote();
                
                isNewNote = false;
                
            } catch (error) {
                console.error('Error saving note:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to save note',
                    type: 'error',
                    duration: 3000
                });
            }
        }
        
        // Delete note
        async function deleteNote() {
            if (!currentNote || isNewNote) return;
            
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            try {
                // Delete the note
                await remove(ref(db, `notes/${currentUserId}/${currentNote.id}`));
                
                // Also delete any shared references
                const sharedSnapshot = await get(ref(db, 'sharedNotes'));
                if (sharedSnapshot.exists()) {
                    const sharedNotes = sharedSnapshot.val();
                    const updates = {};
                    
                    // Find all shared references to this note
                    for (const userId in sharedNotes) {
                        if (sharedNotes[userId][currentNote.id]) {
                            updates[`sharedNotes/${userId}/${currentNote.id}`] = null;
                        }
                    }
                    
                    if (Object.keys(updates).length > 0) {
                        await update(ref(db), updates);
                    }
                }
                
                showNotification({
                    title: 'Success',
                    message: 'Note deleted successfully',
                    type: 'success',
                    duration: 3000
                });
                
                // Reset UI
                currentNote = null;
                emptyState.style.display = 'flex';
                noteEditorContainer.style.display = 'none';
                
                // Reload notes list
                await loadNotes();
                
            } catch (error) {
                console.error('Error deleting note:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to delete note',
                    type: 'error',
                    duration: 3000
                });
            }
        }
        
        // Show share modal
        async function showShareModal() {
            if (!currentNote || isNewNote) return;
            
            // Reset modal
            shareMembersList.innerHTML = '';
            shareGroup.innerHTML = '<option value="">Select Group</option>';
            
            // Add current user's name at the top (disabled)
            const ownerItem = document.createElement('div');
            ownerItem.className = 'member-item';
            ownerItem.innerHTML = `
                <div class="member-info">
                    <div class="member-name">${currentUserData.name} (You - Owner)</div>
                </div>
                <div class="member-status">
                    <input type="checkbox" checked disabled>
                </div>
            `;
            shareMembersList.appendChild(ownerItem);
            
            // Add potential members based on note's class and subject
            if (userType === 'teacher') {
                // For teachers, show students in the note's class
                const classData = allClasses[currentNote.classId];
                if (classData && classData.students) {
                    classData.students.forEach(studentId => {
                        if (studentId !== currentUserId) {
                            const student = allStudents[studentId];
                            if (student) {
                                addMemberToShareList(student);
                            }
                        }
                    });
                }
                
                // Also show other teachers teaching the same subject
                for (const subjectId in allSubjects) {
                    if (subjectId === currentNote.subjectId) {
                        const teacherId = allSubjects[subjectId].teacher;
                        if (teacherId && teacherId !== currentUserId) {
                            const teacher = allTeachers[teacherId];
                            if (teacher) {
                                addMemberToShareList(teacher);
                            }
                        }
                    }
                }
            } else if (userType === 'student') {
                // For students, show teacher of the note's subject
                const subject = allSubjects[currentNote.subjectId];
                if (subject && subject.teacher && subject.teacher !== currentUserId) {
                    const teacher = allTeachers[subject.teacher];
                    if (teacher) {
                        addMemberToShareList(teacher);
                    }
                }
                
                // Also show classmates
                const classData = allClasses[currentNote.classId];
                if (classData && classData.students) {
                    classData.students.forEach(studentId => {
                        if (studentId !== currentUserId) {
                            const student = allStudents[studentId];
                            if (student) {
                                addMemberToShareList(student);
                            }
                        }
                    });
                }
            }
            
            // Add subject group to share options
            if (currentNote.subjectId && currentNote.classId) {
                const subject = allSubjects[currentNote.subjectId];
                const classData = allClasses[currentNote.classId];
                
                if (subject && classData) {
                    const option = document.createElement('option');
                    option.value = `subject_${currentNote.subjectId}_class_${currentNote.classId}`;
                    option.textContent = `${subject.name} - ${classData.name} Group`;
                    shareGroup.appendChild(option);
                }
            }
            
            // Show modal
            shareModal.style.display = 'flex';
        }
        
        // Add member to share list
        function addMemberToShareList(user) {
            const memberItem = document.createElement('div');
            memberItem.className = 'member-item';
            
            const avatarUrl = user.profileImage || user.avatar || 
                `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;
            
            memberItem.innerHTML = `
                <img src="${avatarUrl}" alt="${user.name}" class="member-avatar">
                <div class="member-info">
                    <div class="member-name">${user.name}</div>
                    <div class="member-role">${getUserType(user.id)}</div>
                </div>
                <div class="member-status">
                    <input type="checkbox" data-user-id="${user.id}" class="member-checkbox">
                </div>
            `;
            
            shareMembersList.appendChild(memberItem);
        }
        
        // Share note with selected users or group
        async function shareNote() {
            if (!currentNote) return;
            
            try {
                // Get selected members
                const checkboxes = shareMembersList.querySelectorAll('.member-checkbox');
                const selectedMembers = [];
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked && checkbox.dataset.userId) {
                        selectedMembers.push(checkbox.dataset.userId);
                    }
                });
                
                // Get selected group
                const selectedGroup = shareGroup.value;
                
                if (selectedMembers.length === 0 && !selectedGroup) {
                    showNotification({
                        title: 'Error',
                        message: 'Please select at least one member or group to share with',
                        type: 'error',
                        duration: 3000
                    });
                    return;
                }
                
                // Share with individual members
                for (const userId of selectedMembers) {
                    await set(ref(db, `sharedNotes/${userId}/${currentNote.id}`), {
                        ownerId: currentUserId,
                        sharedAt: new Date().toISOString()
                    });
                }
                
                // Share with group if selected
                if (selectedGroup) {
                    // Get group members
                    const groupSnapshot = await get(ref(db, `groupChats/${selectedGroup}`));
                    if (groupSnapshot.exists()) {
                        const group = groupSnapshot.val();
                        
                        // Share with all group members except current user
                        for (const memberId of group.members) {
                            if (memberId !== currentUserId) {
                                await set(ref(db, `sharedNotes/${memberId}/${currentNote.id}`), {
                                    ownerId: currentUserId,
                                    sharedAt: new Date().toISOString(),
                                    sharedViaGroup: selectedGroup
                                });
                            }
                        }
                    }
                }
                
                // Close modal
                shareModal.style.display = 'none';
                
                showNotification({
                    title: 'Success',
                    message: 'Note shared successfully',
                    type: 'success',
                    duration: 3000
                });
                
            } catch (error) {
                console.error('Error sharing note:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to share note',
                    type: 'error',
                    duration: 3000
                });
            }
        }
        
        // Highlight active note in list
        function highlightActiveNote() {
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
                
                if (currentNote && item.getAttribute('data-note-id') === currentNote.id) {
                    item.classList.add('active');
                }
            });
        }
        
        // Get user type
        function getUserType(userId) {
            if (allTeachers[userId]) return 'Teacher';
            if (allStudents[userId]) return 'Student';
            if (allAlumni[userId]) return 'Alumni';
            return 'User';
        }
        
        // Format date for display
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            
            const date = new Date(timestamp);
            return date.toLocaleDateString([], { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Initialize the app
        loadingScreen.style.display = 'flex';
        mainContainer.style.display = 'none';
        
        // Start the app
        initApp();
    </script>
</body>
</html>
