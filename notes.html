<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>School Notes Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* School Notes Portal CSS */
:root {
    --primary-color: #6c5ce7;
    --secondary-color: #a29bfe;
    --success-color: #00b894;
    --danger-color: #d63031;
    --warning-color: #fdcb6e;
    --info-color: #0984e3;
    --text-color: #2d3436;
    --light-text: #636e72;
    --glass-bg: rgba(255, 255, 255, 0.25);
    --glass-border: rgba(255, 255, 255, 0.18);
    --border-color: rgba(0, 0, 0, 0.1);
    --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    -webkit-tap-highlight-color: transparent;
}

body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: var(--text-color);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
}

/* Loading Screen */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.loading-logo {
    font-size: 3rem;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 20px;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.loading-text {
    font-size: 1.2rem;
    color: var(--text-color);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Main Container */
.container {
    display: flex;
    min-height: 100vh;
    position: relative;
}

/* Sidebar */
.sidebar {
    width: 350px;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-right: 1px solid var(--glass-border);
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
    position: relative;
    z-index: 100;
    height: 100vh;
    overflow-y: auto;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--glass-border);
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.7);
    z-index: 10;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: var(--card-shadow);
}

.user-name {
    font-weight: 600;
    font-size: 1.1rem;
}

.user-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
}

.badge-student {
    background-color: var(--info-color);
    color: white;
}

.badge-teacher {
    background-color: var(--success-color);
    color: white;
}

.badge-alumni {
    background-color: var(--warning-color);
    color: var(--text-color);
}

.sidebar-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
}

.sidebar-actions i {
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--text-color);
    transition: color 0.2s ease;
    padding: 8px;
}

.sidebar-actions i:hover {
    color: var(--primary-color);
}

.search-bar {
    padding: 15px 20px;
    border-bottom: 1px solid var(--glass-border);
    position: sticky;
    top: 107px;
    background: rgba(255, 255, 255, 0.7);
    z-index: 10;
}

.search-container {
    position: relative;
    display: flex;
    align-items: center;
}

.search-container i {
    position: absolute;
    left: 12px;
    color: var(--light-text);
}

.search-container input {
    width: 100%;
    padding: 12px 15px 12px 40px;
    border-radius: 20px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.3);
    font-size: 1rem;
}

.search-container input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.tab-bar {
    display: flex;
    border-bottom: 1px solid var(--glass-border);
    position: sticky;
    top: 163px;
    background: rgba(255, 255, 255, 0.7);
    z-index: 10;
}

.tab {
    flex: 1;
    text-align: center;
    padding: 15px 12px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
    font-size: 0.95rem;
}

.tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.notes-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.note-item {
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.3);
    border: 1px solid var(--glass-border);
    cursor: pointer;
    transition: all 0.2s ease;
}

.note-item:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: var(--card-shadow);
}

.note-item.active {
    background: rgba(108, 92, 231, 0.1);
    border-color: var(--primary-color);
}

.note-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.note-item-title {
    font-weight: 600;
    font-size: 1rem;
    flex: 1;
    margin-right: 10px;
}

.note-item-date {
    font-size: 0.8rem;
    color: var(--light-text);
    white-space: nowrap;
}

.note-item-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.note-item-content {
    font-size: 0.85rem;
    color: var(--light-text);
}

/* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    height: 100vh;
    overflow-y: auto;
}

.content-header {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--glass-border);
    position: sticky;
    top: 0;
    z-index: 10;
}

.content-header-back {
    margin-right: 15px;
    cursor: pointer;
    display: none;
    padding: 8px;
}

.content-header-back i {
    font-size: 1.2rem;
}

.content-header-info {
    flex: 1;
}

.content-header-title {
    font-weight: 600;
    font-size: 1.2rem;
    margin-bottom: 4px;
}

.content-header-subtitle {
    font-size: 0.9rem;
    color: var(--light-text);
}

.content-header-actions {
    display: flex;
    gap: 15px;
}

.content-header-actions i {
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--text-color);
    transition: color 0.2s ease;
    padding: 8px;
}

.content-header-actions i:hover {
    color: var(--primary-color);
}

/* Note Editor */
.note-editor {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: none;
}

/* Week Selector */
.week-selector-container {
    margin-bottom: 20px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid var(--glass-border);
}

.week-selector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.current-week-display {
    font-weight: 600;
    font-size: 1.1rem;
}

.week-navigation {
    display: flex;
    gap: 8px;
}

.week-nav-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.week-nav-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.week-day {
    text-align: center;
    padding: 10px 5px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.3);
    border: 1px solid var(--glass-border);
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.week-day:hover {
    background: rgba(255, 255, 255, 0.5);
}

.week-day.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.week-day.has-notes::after {
    content: "";
    display: block;
    width: 6px;
    height: 6px;
    background-color: var(--success-color);
    border-radius: 50%;
    margin: 5px auto 0;
}

.week-day-name {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 4px;
}

.week-day-number {
    font-size: 1rem;
    font-weight: 600;
}

.week-selector-dropdown {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.5);
    font-size: 1rem;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
}

.week-selector-dropdown:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* Note Meta */
.note-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-color);
}

.form-select {
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.5);
    font-size: 1rem;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
}

.form-select:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* Note Content */
.note-content {
    margin-bottom: 20px;
}

#note-title {
    width: 100%;
    padding: 15px;
    font-size: 1.5rem;
    font-weight: 600;
    border: none;
    border-bottom: 1px solid var(--glass-border);
    background: transparent;
    margin-bottom: 15px;
}

#note-title:focus {
    outline: none;
    border-bottom-color: var(--primary-color);
}

#note-content {
    width: 100%;
    min-height: 300px;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.3);
    font-size: 1rem;
    line-height: 1.6;
    resize: vertical;
}

#note-content:focus {
    outline: none;
    border-color: var(--primary-color);
    background: rgba(255, 255, 255, 0.5);
}

/* Note Actions */
.note-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 15px 0;
    position: sticky;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    margin: 0 -20px;
    padding: 15px 20px;
}

.btn {
    padding: 12px 24px;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1rem;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid var(--glass-border);
    color: var(--text-color);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.7);
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
}

.btn-primary:hover {
    background: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
}

/* Empty State */
.empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 20px;
}

.empty-state i {
    font-size: 4rem;
    color: var(--light-text);
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: var(--text-color);
}

.empty-state p {
    color: var(--light-text);
    margin-bottom: 20px;
    max-width: 400px;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: 15px;
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    font-weight: 600;
    font-size: 1.2rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--light-text);
    padding: 5px;
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
}

.modal-btn {
    padding: 12px 20px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.modal-btn-secondary {
    background: rgba(0, 0, 0, 0.1);
    color: var(--text-color);
}

.modal-btn-secondary:hover {
    background: rgba(0, 0, 0, 0.2);
}

.modal-btn-primary {
    background: var(--primary-color);
    color: white;
}

.modal-btn-primary:hover {
    background: var(--secondary-color);
}

/* Share Modal Specific Styles */
.member-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: rgba(0, 0, 0, 0.03);
}

.member-item:last-child {
    margin-bottom: 0;
}

.member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 12px;
}

.member-info {
    flex: 1;
}

.member-name {
    font-weight: 600;
    margin-bottom: 4px;
}

.member-role {
    font-size: 0.8rem;
    color: var(--light-text);
}

.member-status {
    margin-left: 10px;
}

.member-checkbox {
    width: 22px;
    height: 22px;
    cursor: pointer;
}

/* Notification Styles */
.notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 350px;
    max-width: 90%;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.notification {
    position: relative;
    padding: 16px 20px;
    border-radius: 10px;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    transform: translateX(120%);
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    opacity: 0;
}

.notification.show {
    transform: translateX(0);
    opacity: 1;
}

.notification.hide {
    transform: translateX(120%);
    opacity: 0;
}

.notification.success {
    background-color: var(--success-color);
}

.notification.error {
    background-color: var(--danger-color);
}

.notification.warning {
    background-color: var(--warning-color);
    color: var(--text-color);
}

.notification.info {
    background-color: var(--info-color);
}

.notification-icon {
    margin-right: 12px;
    font-size: 20px;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    margin-bottom: 4px;
}

.notification-message {
    font-size: 14px;
    opacity: 0.9;
}

.notification-close {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    margin-left: 15px;
    font-size: 18px;
    opacity: 0.8;
    padding: 5px;
}

.notification-close:hover {
    opacity: 1;
}

/* Mobile Menu Button */
.mobile-menu-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 101;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: none;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .sidebar {
        width: 300px;
    }
}

@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 100;
        transform: translateX(-100%);
    }
    
    .sidebar.active {
        transform: translateX(0);
    }
    
    .mobile-menu-btn {
        display: flex;
    }
    
    .main-content.active {
        margin-left: 0;
    }
    
    .content-header-back {
        display: block;
    }
    
    .note-meta {
        grid-template-columns: 1fr;
    }
    
    .week-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }
    
    .week-day {
        padding: 8px 2px;
        min-height: 50px;
    }
    
    .week-day-name {
        font-size: 0.7rem;
    }
    
    .week-day-number {
        font-size: 0.9rem;
    }
    
    .modal {
        padding: 10px;
    }
    
    .modal-content {
        width: 100%;
    }
    
    .note-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .sidebar-header {
        padding: 15px;
    }
    
    .search-bar {
        padding: 10px 15px;
    }
    
    .tab {
        padding: 12px 8px;
        font-size: 0.85rem;
    }
    
    .content-header {
        padding: 12px 15px;
    }
    
    .content-header-title {
        font-size: 1.1rem;
    }
    
    .content-header-subtitle {
        font-size: 0.8rem;
    }
    
    .current-week-display {
        font-size: 1rem;
    }
    
    #note-title {
        font-size: 1.3rem;
        padding: 12px;
    }
    
    .note-editor {
        padding: 15px;
    }
    
    .week-selector-container {
        padding: 12px;
    }
    
    .week-nav-btn {
        width: 36px;
        height: 36px;
    }
    
    .modal-content {
        border-radius: 12px;
    }
    
    .modal-header,
    .modal-body,
    .modal-footer {
        padding: 15px;
    }
    
    .member-item {
        padding: 10px;
    }
    
    .empty-state i {
        font-size: 3rem;
    }
    
    .empty-state h3 {
        font-size: 1.3rem;
    }
    
    .empty-state p {
        font-size: 0.9rem;
    }
}

/* Touch device improvements */
@media (hover: none) and (pointer: coarse) {
    .note-item:hover {
        transform: none;
    }
    
    .week-nav-btn:hover {
        background: rgba(255, 255, 255, 0.5);
        color: inherit;
        border-color: var(--glass-border);
    }
    
    .week-nav-btn:active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .sidebar-actions i:hover,
    .content-header-actions i:hover {
        color: var(--text-color);
    }
    
    .sidebar-actions i:active,
    .content-header-actions i:active {
        color: var(--primary-color);
    }
    
    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    .btn-secondary:active {
        background: rgba(255, 255, 255, 0.7);
    }
    
    .btn-primary:hover {
        background: var(--primary-color);
        transform: none;
    }
    
    .btn-primary:active {
        background: var(--secondary-color);
        transform: translateY(-2px);
    }
}

/* Prevent zoom on input focus for mobile */
@media (max-width: 768px) {
    input, select, textarea {
        font-size: 16px !important;
    }
}
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <div class="mobile-menu-btn" id="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">SN</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading School Notes</div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Main Container -->
    <div class="container" id="main-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <img id="user-avatar" src="" alt="User" class="user-avatar">
                    <div>
                        <div class="user-name" id="user-name">Loading...</div>
                        <div class="user-badge" id="user-badge">...</div>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <i class="fas fa-plus" id="new-note-btn" title="New Note"></i>
                    <i class="fas fa-ellipsis-v" id="menu-btn" title="Menu"></i>
                </div>
            </div>
            
            <div class="search-bar">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search notes" id="search-input">
                </div>
            </div>
            
            <div class="tab-bar">
                <div class="tab active" data-tab="my-notes">My Notes</div>
                <div class="tab" data-tab="shared">Shared With Me</div>
                <div class="tab" data-tab="class-notes">Class Notes</div>
            </div>
            
            <div class="notes-list" id="notes-list">
                <!-- Notes will be loaded here -->
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="content-header">
                <div class="content-header-back" id="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="content-header-info">
                    <div class="content-header-title" id="content-header-title">Select a note</div>
                    <div class="content-header-subtitle" id="content-header-subtitle">Or create a new one</div>
                </div>
                <div class="content-header-actions">
                    <i class="fas fa-share-alt" id="share-btn" title="Share Note"></i>
                    <i class="fas fa-trash-alt" id="delete-btn" title="Delete Note"></i>
                </div>
            </div>
            
            <div class="note-editor" id="note-editor-container">
                <!-- Enhanced Week Selector -->
                <div class="week-selector-container">
                    <div class="week-selector-header">
                        <div class="current-week-display" id="current-week-display">Week 1</div>
                        <div class="week-navigation">
                            <button class="week-nav-btn" id="prev-week-btn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="week-nav-btn" id="next-week-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="week-grid" id="week-grid">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                    <select id="note-week" class="week-selector-dropdown">
                        <option value="">Select Week</option>
                        <option value="1">Week 1</option>
                        <option value="2">Week 2</option>
                        <option value="3">Week 3</option>
                        <option value="4">Week 4</option>
                        <option value="5">Week 5</option>
                        <option value="6">Week 6</option>
                        <option value="7">Week 7</option>
                        <option value="8">Week 8</option>
                        <option value="9">Week 9</option>
                        <option value="10">Week 10</option>
                        <option value="11">Week 11</option>
                        <option value="12">Week 12</option>
                    </select>
                </div>
                
                <div class="note-meta">
                    <div class="form-group">
                        <label class="form-label" for="note-subject">Subject</label>
                        <select id="note-subject" class="form-select">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="note-class">Class</label>
                        <select id="note-class" class="form-select">
                            <option value="">Select Class</option>
                        </select>
                    </div>
                </div>
                
                <div class="note-content">
                    <input type="text" id="note-title" placeholder="Note Title">
                    <textarea id="note-content" placeholder="Write your note here..."></textarea>
                </div>
                
                <div class="note-actions">
                    <button class="btn btn-secondary" id="cancel-btn">Cancel</button>
                    <button class="btn btn-primary" id="save-btn">Save Note</button>
                </div>
            </div>
            
            <!-- Empty State -->
            <div class="empty-state" id="empty-state">
                <i class="fas fa-sticky-note"></i>
                <h3>No Note Selected</h3>
                <p>Select a note from the sidebar or create a new one</p>
                <button class="btn" id="new-note-sidebar-btn">New Note</button>
            </div>
        </div>
    </div>

    <!-- Share Note Modal -->
    <div class="modal" id="share-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Share Note</div>
                <button class="modal-close" id="close-share-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Share with:</label>
                    <div id="share-members-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px;">
                        <!-- Members will be listed here -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Or share with subject group:</label>
                    <select id="share-group" class="form-select">
                        <option value="">Select Group</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" id="cancel-share-btn">Cancel</button>
                <button class="modal-btn modal-btn-primary" id="confirm-share-btn">Share</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, push, update, onValue, onChildAdded, onChildChanged, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Firebase configuration (same as connect.html)
        const firebaseConfig = {
            apiKey: "AIzaSyAkrHsyfCTijqKP7UJv0eSx0iNvl8S06U8",
            authDomain: "sms-single.firebaseapp.com",
            projectId: "sms-single",
            storageBucket: "sms-single.appspot.com",
            messagingSenderId: "140188895278",
            appId: "1:140188895278:web:1b56660a13e5b088ce77bf",
            measurementId: "G-7ER348P6VZ"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContainer = document.getElementById('main-container');
        const notificationContainer = document.getElementById('notification-container');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const emptyState = document.getElementById('empty-state');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userBadge = document.getElementById('user-badge');
        const searchInput = document.getElementById('search-input');
        const tabs = document.querySelectorAll('.tab');
        const notesList = document.getElementById('notes-list');
        const backBtn = document.getElementById('back-btn');
        const contentHeaderTitle = document.getElementById('content-header-title');
        const contentHeaderSubtitle = document.getElementById('content-header-subtitle');
        const shareBtn = document.getElementById('share-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const noteEditorContainer = document.getElementById('note-editor-container');
        const noteSubject = document.getElementById('note-subject');
        const noteClass = document.getElementById('note-class');
        const noteWeekDropdown = document.getElementById('note-week');
        const noteTitle = document.getElementById('note-title');
        const noteContent = document.getElementById('note-content');
        const cancelBtn = document.getElementById('cancel-btn');
        const saveBtn = document.getElementById('save-btn');
        const newNoteBtn = document.getElementById('new-note-btn');
        const newNoteSidebarBtn = document.getElementById('new-note-sidebar-btn');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        
        // Week selector elements
        const currentWeekDisplay = document.getElementById('current-week-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const weekGrid = document.getElementById('week-grid');
        
        // Modal elements
        const shareModal = document.getElementById('share-modal');
        const closeShareModal = document.getElementById('close-share-modal');
        const cancelShareBtn = document.getElementById('cancel-share-btn');
        const confirmShareBtn = document.getElementById('confirm-share-btn');
        const shareMembersList = document.getElementById('share-members-list');
        const shareGroup = document.getElementById('share-group');
        
        // Firebase references
        const authUsersRef = ref(db, 'authUsers');
        const teachersRef = ref(db, 'teachers');
        const studentsRef = ref(db, 'students');
        const alumniRef = ref(db, 'alumni');
        const credentialsRef = ref(db, 'credentials');
        const classesRef = ref(db, 'classes');
        const subjectsRef = ref(db, 'subjects');
        const notesRef = ref(db, 'notes');
        const sharedNotesRef = ref(db, 'sharedNotes');
        const activeSessionsRef = ref(db, 'activeSessions');
        
        // Global variables
        let currentUserId = null;
        let currentUserData = null;
        let userType = null; // 'student', 'teacher', or 'alumni'
        let allTeachers = {};
        let allStudents = {};
        let allAlumni = {};
        let allClasses = {};
        let allSubjects = {};
        let currentNote = null;
        let userClasses = [];
        let userSubjects = [];
        let isNewNote = false;
        let currentWeek = 1;
        let notesByWeek = {};
        
        // Show notification function (same as connect.html)
        function showNotification({ title, message, type = 'info', duration = 5000 }) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas fa-${iconMap[type]} notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Trigger reflow to enable animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto-dismiss after duration
            let timeoutId;
            if (duration > 0) {
                timeoutId = setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.add('hide');
                    
                    // Remove after animation completes
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
            
            // Close button handler
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                clearTimeout(timeoutId);
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
            
            return notification;
        }
        
        // Identify the current user based on device info (same as connect.html)
        async function identifyCurrentUser() {
            try {
                // Get all auth users
                const authUsersSnapshot = await get(authUsersRef);
                if (!authUsersSnapshot.exists()) {
                    throw new Error('No auth users found');
                }
                
                const authUsers = authUsersSnapshot.val();
                const credentialsSnapshot = await get(credentialsRef);
                const credentials = credentialsSnapshot.exists() ? credentialsSnapshot.val() : {};
                
                // Get current device info from browser
                const userAgent = navigator.userAgent;
                const screenResolution = `${window.screen.width}x${window.screen.height}`;
                const language = navigator.language;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // Find matching user based on device info
                for (const [authId, authUser] of Object.entries(authUsers)) {
                    const userCredential = credentials[authUser.userId];
                    if (userCredential && userCredential.deviceInfo) {
                        const deviceInfo = userCredential.deviceInfo;
                        
                        // Check for matching device characteristics
                        if (deviceInfo.userAgent === userAgent && 
                            deviceInfo.screenResolution === screenResolution &&
                            deviceInfo.language === language && 
                            deviceInfo.timezone === timezone) {
                            
                            // This is likely the current user
                            currentUserId = authUser.userId;
                            userType = authUser.userType; // 'student', 'teacher', or 'alumni'
                            
                            // Get user details from appropriate collection
                            let userRef;
                            if (userType === 'teacher') {
                                userRef = ref(db, `teachers/${currentUserId}`);
                            } else if (userType === 'student') {
                                userRef = ref(db, `students/${currentUserId}`);
                            } else if (userType === 'alumni') {
                                userRef = ref(db, `alumni/${currentUserId}`);
                            } else {
                                throw new Error('Unknown user type');
                            }
                            
                            const userSnapshot = await get(userRef);
                            
                            if (userSnapshot.exists()) {
                                currentUserData = userSnapshot.val();
                                return currentUserData;
                            }
                        }
                    }
                }
                
                // If no match found, try to get from activeSessions as fallback
                const activeSessionSnapshot = await get(activeSessionsRef);
                if (activeSessionSnapshot.exists()) {
                    const activeSessions = activeSessionSnapshot.val();
                    
                    if (activeSessions.student) {
                        currentUserId = activeSessions.student;
                        userType = 'student';
                    } else if (activeSessions.teacher) {
                        currentUserId = activeSessions.teacher;
                        userType = 'teacher';
                    } else if (activeSessions.alumni) {
                        currentUserId = activeSessions.alumni;
                        userType = 'alumni';
                    }
                    
                    if (currentUserId) {
                        let userRef;
                        if (userType === 'teacher') {
                            userRef = ref(db, `teachers/${currentUserId}`);
                        } else if (userType === 'student') {
                            userRef = ref(db, `students/${currentUserId}`);
                        } else if (userType === 'alumni') {
                            userRef = ref(db, `alumni/${currentUserId}`);
                        }
                        
                        const userSnapshot = await get(userRef);
                        
                        if (userSnapshot.exists()) {
                            currentUserData = userSnapshot.val();
                            return currentUserData;
                        }
                    }
                }
                
                throw new Error('No matching user found');
            } catch (error) {
                console.error('Error identifying user:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to identify user: ' + error.message,
                    type: 'error'
                });
                return null;
            }
        }
        
        // Initialize the app
        async function initApp() {
            try {
                // First try to identify the user based on device info
                const user = await identifyCurrentUser();
                
                if (user) {
                    // Update UI with user info
                    userName.textContent = user.name || 'User';
                    
                    // Set user badge
                    if (userType === 'student') {
                        userBadge.textContent = 'Student';
                        userBadge.className = 'user-badge badge-student';
                    } else if (userType === 'teacher') {
                        userBadge.textContent = 'Teacher';
                        userBadge.className = 'user-badge badge-teacher';
                    } else if (userType === 'alumni') {
                        userBadge.textContent = 'Alumni';
                        userBadge.className = 'user-badge badge-alumni';
                    }
                    
                    // Set avatar - use profileImage if available, otherwise use dicebear
                    const avatarUrl = user.profileImage || user.avatar || 
                        `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUserId}`;
                    userAvatar.src = avatarUrl;
                    
                    // Load all teachers, students, and alumni
                    await loadAllUsers();
                    
                    // Load all classes and subjects
                    await loadAllClasses();
                    await loadAllSubjects();
                    
                    // Determine user's classes and subjects
                    await determineUserClassesAndSubjects();
                    
                    // Populate subject and class dropdowns
                    populateDropdowns();
                    
                    // Initialize week selector
                    initializeWeekSelector();
                    
                    // Set up event listeners
                    setupEventListeners();
                    
                    // Load notes
                    await loadNotes();
                    
                    // Hide loading screen and show main content
                    loadingScreen.style.display = 'none';
                    mainContainer.style.display = 'flex';
                    
                    showNotification({
                        title: 'Welcome Back',
                        message: `You're logged in as ${user.name || 'User'}`,
                        type: 'success',
                        duration: 3000
                    });
                    
                    return;
                }
                
                // If no user identified
                showNotification({
                    title: 'Session Expired',
                    message: 'Please sign in again',
                    type: 'error',
                    duration: 0
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to load user information',
                    type: 'error'
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        // Load all users (teachers, students, alumni)
        async function loadAllUsers() {
            // Load teachers
            const teachersSnapshot = await get(teachersRef);
            allTeachers = teachersSnapshot.exists() ? teachersSnapshot.val() : {};
            
            // Load students
            const studentsSnapshot = await get(studentsRef);
            allStudents = studentsSnapshot.exists() ? studentsSnapshot.val() : {};
            
            // Load alumni
            const alumniSnapshot = await get(alumniRef);
            allAlumni = alumniSnapshot.exists() ? alumniSnapshot.val() : {};
        }
        
        // Load all classes
        async function loadAllClasses() {
            const snapshot = await get(classesRef);
            allClasses = snapshot.exists() ? snapshot.val() : {};
        }
        
        // Load all subjects
        async function loadAllSubjects() {
            const snapshot = await get(subjectsRef);
            allSubjects = snapshot.exists() ? snapshot.val() : {};
        }
        
        // Determine which classes and subjects the user is associated with
        async function determineUserClassesAndSubjects() {
            userClasses = [];
            userSubjects = [];
            
            if (userType === 'student') {
                // For students, get their class from student data
                if (currentUserData.class) {
                    userClasses.push(currentUserData.class);
                    
                    // Find subjects taught in this class
                    for (const subjectId in allSubjects) {
                        const subject = allSubjects[subjectId];
                        if (subject.class === currentUserData.class) {
                            userSubjects.push({
                                id: subjectId,
                                ...subject
                            });
                        }
                    }
                }
            } else if (userType === 'teacher') {
                // For teachers, get classes and subjects they teach
                for (const subjectId in allSubjects) {
                    const subject = allSubjects[subjectId];
                    if (subject.teacher === currentUserId) {
                        userSubjects.push({
                            id: subjectId,
                            ...subject
                        });
                        
                        if (subject.class && !userClasses.includes(subject.class)) {
                            userClasses.push(subject.class);
                        }
                    }
                }
            } else if (userType === 'alumni') {
                // For alumni, we might want to show notes from their previous classes
                if (currentUserData.previousClass) {
                    userClasses.push(currentUserData.previousClass);
                    
                    // Find subjects from their previous class
                    for (const subjectId in allSubjects) {
                        const subject = allSubjects[subjectId];
                        if (subject.class === currentUserData.previousClass) {
                            userSubjects.push({
                                id: subjectId,
                                ...subject
                            });
                        }
                    }
                }
            }
        }
        
        // Populate subject and class dropdowns
        function populateDropdowns() {
            // Clear existing options
            noteSubject.innerHTML = '<option value="">Select Subject</option>';
            noteClass.innerHTML = '<option value="">Select Class</option>';
            
            // Add subjects based on user type
            if (userType === 'teacher') {
                // Teachers can select any subject they teach
                userSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    noteSubject.appendChild(option);
                });
            } else if (userType === 'student') {
                // Students can only see subjects from their class
                userSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    noteSubject.appendChild(option);
                });
            }
            
            // Add classes based on user type
            if (userType === 'teacher') {
                // Teachers can select any class they teach
                userClasses.forEach(classId => {
                    const classData = allClasses[classId];
                    if (classData) {
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = classData.name;
                        noteClass.appendChild(option);
                    }
                });
            } else if (userType === 'student') {
                // Students can only see their own class
                if (currentUserData.class) {
                    const classData = allClasses[currentUserData.class];
                    if (classData) {
                        const option = document.createElement('option');
                        option.value = currentUserData.class;
                        option.textContent = classData.name;
                        noteClass.appendChild(option);
                    }
                }
            }
        }
        
        // Initialize the week selector
        function initializeWeekSelector() {
            // Create day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            // Generate week grid
            weekGrid.innerHTML = '';
            days.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'week-day';
                dayElement.innerHTML = `
                    <div class="week-day-name">${day}</div>
                    <div class="week-day-number"></div>
                `;
                weekGrid.appendChild(dayElement);
            });
            
            // Set initial week
            setWeek(1);
            
            // Event listeners for week navigation
            prevWeekBtn.addEventListener('click', () => {
                if (currentWeek > 1) {
                    setWeek(currentWeek - 1);
                    noteWeekDropdown.value = currentWeek;
                }
            });
            
            nextWeekBtn.addEventListener('click', () => {
                if (currentWeek < 12) {
                    setWeek(currentWeek + 1);
                    noteWeekDropdown.value = currentWeek;
                }
            });
            
            // Event listener for dropdown
            noteWeekDropdown.addEventListener('change', (e) => {
                const week = parseInt(e.target.value);
                if (week >= 1 && week <= 12) {
                    setWeek(week);
                }
            });
            
            // Click handler for day cells
            weekGrid.addEventListener('click', (e) => {
                const dayElement = e.target.closest('.week-day');
                if (dayElement) {
                    // For now, just highlight the clicked day
                    document.querySelectorAll('.week-day').forEach(day => {
                        day.classList.remove('active');
                    });
                    dayElement.classList.add('active');
                    
                    // In a future enhancement, we could load notes for this specific day
                }
            });
        }
        
        // Set the current week and update the display
        function setWeek(week) {
            currentWeek = week;
            currentWeekDisplay.textContent = `Week ${week}`;
            
            // Calculate dates for this week (assuming a 12-week semester starting from current date)
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay() + (week - 1) * 7); // Start of week
            
            // Update day numbers
            const dayNumbers = weekGrid.querySelectorAll('.week-day-number');
            dayNumbers.forEach((dayNumber, index) => {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + index);
                dayNumber.textContent = dayDate.getDate();
                
                // Check if this day has notes (for indicator dots)
                const dayKey = `${dayDate.getFullYear()}-${dayDate.getMonth() + 1}-${dayDate.getDate()}`;
                const dayElement = dayNumber.closest('.week-day');
                
                if (notesByWeek[week] && notesByWeek[week][dayKey]) {
                    dayElement.classList.add('has-notes');
                } else {
                    dayElement.classList.remove('has-notes');
                }
                
                // Highlight today if it's in this week
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('active');
                } else {
                    dayElement.classList.remove('active');
                }
            });
            
            // Update dropdown to match
            noteWeekDropdown.value = week;
            
            // If we're editing a note and it's for this week, highlight it
            if (currentNote && currentNote.week == week) {
                highlightActiveNote();
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Mobile menu button
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Reload notes based on selected tab
                    loadNotes();
                    
                    // On mobile, close sidebar after selecting a tab
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            // Back button (for mobile)
            backBtn.addEventListener('click', () => {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('active');
                emptyState.style.display = 'flex';
                noteEditorContainer.style.display = 'none';
                currentNote = null;
                
                // On mobile, show sidebar when going back
                if (window.innerWidth < 768) {
                    sidebar.classList.add('active');
                }
            });
            
            // New note buttons
            newNoteBtn.addEventListener('click', createNewNote);
            newNoteSidebarBtn.addEventListener('click', createNewNote);
            
            // Save note button
            saveBtn.addEventListener('click', saveNote);
            
            // Cancel button
            cancelBtn.addEventListener('click', () => {
                if (isNewNote) {
                    // If it's a new note, go back to empty state
                    emptyState.style.display = 'flex';
                    noteEditorContainer.style.display = 'none';
                    currentNote = null;
                    isNewNote = false;
                    
                    // On mobile, show sidebar when canceling new note
                    if (window.innerWidth < 768) {
                        sidebar.classList.add('active');
                    }
                } else if (currentNote) {
                    // If editing existing note, reload it to discard changes
                    loadNote(currentNote.id);
                }
            });
            
            // Share button
            shareBtn.addEventListener('click', showShareModal);
            
            // Delete button
            deleteBtn.addEventListener('click', deleteNote);
            
            // Search input
            searchInput.addEventListener('input', (e) => {
                filterNotes(e.target.value);
            });
            
            // Window resize handler
            window.addEventListener('resize', handleResize);
            
            // Modal event listeners
            closeShareModal.addEventListener('click', () => {
                shareModal.style.display = 'none';
            });
            
            cancelShareBtn.addEventListener('click', () => {
                shareModal.style.display = 'none';
            });
            
            confirmShareBtn.addEventListener('click', shareNote);
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    shareModal.style.display = 'none';
                }
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 768 && 
                    sidebar.classList.contains('active') && 
                    !sidebar.contains(e.target) && 
                    e.target !== mobileMenuBtn) {
                    sidebar.classList.remove('active');
                }
            });
        }
        
        // Handle window resize
        function handleResize() {
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('hidden');
                sidebar.classList.remove('active');
                mainContent.classList.add('active');
                mobileMenuBtn.style.display = 'none';
                
                if (currentNote) {
                    emptyState.style.display = 'none';
                } else {
                    emptyState.style.display = 'flex';
                }
            } else {
                mobileMenuBtn.style.display = 'flex';
                if (!currentNote) {
                    sidebar.classList.add('active');
                }
            }
        }
        
        // Load notes based on selected tab
        async function loadNotes() {
            notesList.innerHTML = '';
            notesByWeek = {}; // Reset notes by week cache
            
            const selectedTab = document.querySelector('.tab.active').getAttribute('data-tab');
            
            if (selectedTab === 'my-notes') {
                await loadMyNotes();
            } else if (selectedTab === 'shared') {
                await loadSharedNotes();
            } else if (selectedTab === 'class-notes') {
                await loadClassNotes();
            }
            
            // Update week indicators
            setWeek(currentWeek);
        }
        
        // Load user's own notes
        async function loadMyNotes() {
            const notesSnapshot = await get(ref(db, `notes/${currentUserId}`));
            const notes = notesSnapshot.exists() ? notesSnapshot.val() : {};
            
            const notesArray = [];
            
            for (const noteId in notes) {
                const note = {
                    id: noteId,
                    ...notes[noteId]
                };
                notesArray.push(note);
                
                // Organize notes by week for the calendar view
                const week = note.week || 1;
                if (!notesByWeek[week]) notesByWeek[week] = {};
                
                // For calendar indicators, we'll use the creation date
                const noteDate = new Date(note.createdAt || new Date().toISOString());
                const dateKey = `${noteDate.getFullYear()}-${noteDate.getMonth() + 1}-${noteDate.getDate()}`;
                
                if (!notesByWeek[week][dateKey]) {
                    notesByWeek[week][dateKey] = true;
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Notes Found</h3>
                    <p>You haven't created any notes yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Load notes shared with the user
        async function loadSharedNotes() {
            const sharedSnapshot = await get(ref(db, `sharedNotes/${currentUserId}`));
            const sharedNotes = sharedSnapshot.exists() ? sharedSnapshot.val() : {};
            
            const notesArray = [];
            
            for (const noteId in sharedNotes) {
                // Get the actual note
                const noteOwner = sharedNotes[noteId].ownerId;
                const noteSnapshot = await get(ref(db, `notes/${noteOwner}/${noteId}`));
                
                if (noteSnapshot.exists()) {
                    const note = {
                        id: noteId,
                        ownerId: noteOwner,
                        ...noteSnapshot.val()
                    };
                    notesArray.push(note);
                    
                    // Organize notes by week for the calendar view
                    const week = note.week || 1;
                    if (!notesByWeek[week]) notesByWeek[week] = {};
                    
                    const noteDate = new Date(note.createdAt || new Date().toISOString());
                    const dateKey = `${noteDate.getFullYear()}-${noteDate.getMonth() + 1}-${noteDate.getDate()}`;
                    
                    if (!notesByWeek[week][dateKey]) {
                        notesByWeek[week][dateKey] = true;
                    }
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note, true);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Shared Notes</h3>
                    <p>No one has shared any notes with you yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Load class notes (for students)
        async function loadClassNotes() {
            if (userType !== 'student') {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>Class Notes</h3>
                    <p>This section is only available to students.</p>
                `;
                notesList.appendChild(emptyItem);
                return;
            }
            
            // Get all notes from teachers of this student's subjects
            const notesArray = [];
            
            for (const subject of userSubjects) {
                if (subject.teacher) {
                    const teacherNotesSnapshot = await get(ref(db, `notes/${subject.teacher}`));
                    const teacherNotes = teacherNotesSnapshot.exists() ? teacherNotesSnapshot.val() : {};
                    
                    for (const noteId in teacherNotes) {
                        const note = teacherNotes[noteId];
                        
                        // Check if note is for this student's class and subject
                        if (note.classId === currentUserData.class && note.subjectId === subject.id) {
                            const fullNote = {
                                id: noteId,
                                ownerId: subject.teacher,
                                ...note
                            };
                            notesArray.push(fullNote);
                            
                            // Organize notes by week for the calendar view
                            const week = note.week || 1;
                            if (!notesByWeek[week]) notesByWeek[week] = {};
                            
                            const noteDate = new Date(note.createdAt || new Date().toISOString());
                            const dateKey = `${noteDate.getFullYear()}-${noteDate.getMonth() + 1}-${noteDate.getDate()}`;
                            
                            if (!notesByWeek[week][dateKey]) {
                                notesByWeek[week][dateKey] = true;
                            }
                        }
                    }
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note, true);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Class Notes</h3>
                    <p>Your teachers haven't shared any notes for your class yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Create a note list item
        function createNoteItem(note, isShared = false) {
            const noteItem = document.createElement('div');
            noteItem.className = 'note-item';
            noteItem.setAttribute('data-note-id', note.id);
            
            // Get subject and class names
            const subjectName = allSubjects[note.subjectId]?.name || 'Unknown Subject';
            const className = allClasses[note.classId]?.name || 'Unknown Class';
            
            noteItem.innerHTML = `
                <div class="note-item-header">
                    <div class="note-item-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-item-date">${formatDate(note.updatedAt || note.createdAt)}</div>
                </div>
                <div class="note-item-preview">
                    <div class="note-item-content">
                        ${subjectName}  ${className}  Week ${note.week || 'N/A'}
                    </div>
                    ${isShared ? '<div class="user-badge" style="background-color: var(--secondary-color); color: white;">Shared</div>' : ''}
                </div>
            `;
            
            // Add click handler to open note
            noteItem.addEventListener('click', () => openNote(note));
            
            return noteItem;
        }
        
        // Filter notes based on search input
        function filterNotes(searchTerm) {
            const term = searchTerm.toLowerCase();
            const items = notesList.querySelectorAll('.note-item');
            
            items.forEach(item => {
                const title = item.querySelector('.note-item-title').textContent.toLowerCase();
                const content = item.querySelector('.note-item-content').textContent.toLowerCase();
                
                if (title.includes(term) || content.includes(term)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Create a new note
        function createNewNote() {
            currentNote = null;
            isNewNote = true;
            
            // Reset form
            noteTitle.value = '';
            noteContent.value = '';
            noteSubject.value = '';
            noteClass.value = '';
            setWeek(1); // Default to week 1
            
            // Update UI
            contentHeaderTitle.textContent = 'New Note';
            contentHeaderSubtitle.textContent = 'Create a new lesson note';
            
            // For teachers, allow selecting subject and class
            if (userType === 'teacher') {
                noteSubject.disabled = false;
                noteClass.disabled = false;
            } else {
                // For students, set to their class and first subject (can be changed)
                if (currentUserData.class) {
                    noteClass.value = currentUserData.class;
                    noteClass.disabled = true;
                    
                    if (userSubjects.length > 0) {
                        noteSubject.value = userSubjects[0].id;
                    }
                }
            }
            
            // Show editor and hide empty state
            emptyState.style.display = 'none';
            noteEditorContainer.style.display = 'flex';
            
            // For mobile, hide sidebar and show main content
            if (window.innerWidth < 768) {
                sidebar.classList.remove('active');
                mainContent.classList.add('active');
            }
            
            // Focus on title
            noteTitle.focus();
        }
        
        // Open a note for viewing/editing
        async function openNote(note) {
            currentNote = note;
            isNewNote = false;
            
            // Load note details
            loadNote(note.id);
            
            // Update UI
            contentHeaderTitle.textContent = note.title || 'Untitled Note';
            contentHeaderSubtitle.textContent = `Last updated: ${formatDate(note.updatedAt || note.createdAt)}`;
            
            // Show editor and hide empty state
            emptyState.style.display = 'none';
            noteEditorContainer.style.display = 'flex';
            
            // For mobile, hide sidebar and show main content
            if (window.innerWidth < 768) {
                sidebar.classList.remove('active');
                mainContent.classList.add('active');
            }
            
            // Set the week for this note
            if (note.week) {
                setWeek(parseInt(note.week));
                noteWeekDropdown.value = note.week;
            }
            
            // Highlight active note in list
            highlightActiveNote();
        }
        
        // Load note details
        async function loadNote(noteId) {
            let note;
            
            if (currentNote.ownerId && currentNote.ownerId !== currentUserId) {
                // This is a shared note, get from owner's notes
                const noteSnapshot = await get(ref(db, `notes/${currentNote.ownerId}/${noteId}`));
                note = noteSnapshot.exists() ? noteSnapshot.val() : null;
            } else {
                // This is the user's own note
                const noteSnapshot = await get(ref(db, `notes/${currentUserId}/${noteId}`));
                note = noteSnapshot.exists() ? noteSnapshot.val() : null;
            }
            
            if (!note) {
                showNotification({
                    title: 'Error',
                    message: 'Note not found',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            // Update form fields
            noteTitle.value = note.title || '';
            noteContent.value = note.content || '';
            noteSubject.value = note.subjectId || '';
            noteClass.value = note.classId || '';
            setWeek(note.week || 1);
            noteWeekDropdown.value = note.week || '';
            
            // Disable editing if this is a shared note and user is not the owner
            if (currentNote.ownerId && currentNote.ownerId !== currentUserId) {
                noteTitle.readOnly = true;
                noteContent.readOnly = true;
                noteSubject.disabled = true;
                noteClass.disabled = true;
                noteWeekDropdown.disabled = true;
                saveBtn.style.display = 'none';
            } else {
                noteTitle.readOnly = false;
                noteContent.readOnly = false;
                noteSubject.disabled = false;
                noteClass.disabled = false;
                noteWeekDropdown.disabled = false;
                saveBtn.style.display = 'block';
            }
        }
        
        // Save note
        async function saveNote() {
            const title = noteTitle.value.trim();
            const content = noteContent.value.trim();
            const subjectId = noteSubject.value;
            const classId = noteClass.value;
            const week = currentWeek;
            
            if (!title) {
                showNotification({
                    title: 'Error',
                    message: 'Please enter a title for your note',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            if (!subjectId || !classId || !week) {
                showNotification({
                    title: 'Error',
                    message: 'Please select subject, class, and week',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            try {
                const now = new Date().toISOString();
                const noteData = {
                    title: title,
                    content: content,
                    subjectId: subjectId,
                    classId: classId,
                    week: week,
                    updatedAt: now,
                    ownerName: currentUserData.name
                };
                
                if (isNewNote) {
                    // Create new note
                    noteData.createdAt = now;
                    const newNoteRef = push(ref(db, `notes/${currentUserId}`));
                    await set(newNoteRef, noteData);
                    
                    currentNote = {
                        id: newNoteRef.key,
                        ...noteData
                    };
                    
                    showNotification({
                        title: 'Success',
                        message: 'Note created successfully',
                        type: 'success',
                        duration: 3000
                    });
                } else {
                    // Update existing note
                    noteData.createdAt = currentNote.createdAt;
                    await set(ref(db, `notes/${currentUserId}/${currentNote.id}`), noteData);
                    
                    currentNote = {
                        ...currentNote,
                        ...noteData
                    };
                    
                    showNotification({
                        title: 'Success',
                        message: 'Note updated successfully',
                        type: 'success',
                        duration: 3000
                    });
                }
                
                // Update UI
                contentHeaderTitle.textContent = title;
                contentHeaderSubtitle.textContent = `Last updated: ${formatDate(now)}`;
                
                // Reload notes list
                await loadNotes();
                
                // Highlight the updated/created note
                highlightActiveNote();
                
                isNewNote = false;
                
            } catch (error) {
                console.error('Error saving note:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to save note',
                    type: 'error',
                    duration: 3000
                });
            }
        }
        
        // Delete note
        async function deleteNote() {
            if (!currentNote || isNewNote) return;
            
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            try {
                // Delete the note
                await remove(ref(db, `notes/${currentUserId}/${currentNote.id}`));
                
                // Also delete any shared references
                const sharedSnapshot = await get(ref(db, 'sharedNotes'));
                if (sharedSnapshot.exists()) {
                    const sharedNotes = sharedSnapshot.val();
                    const updates = {};
                    
                    // Find all shared references to this note
                    for (const userId in sharedNotes) {
                        if (sharedNotes[userId][currentNote.id]) {
                            updates[`sharedNotes/${userId}/${currentNote.id}`] = null;
                        }
                    }
                    
                    if (Object.keys(updates).length > 0) {
                        await update(ref(db), updates);
                    }
                }
                
                showNotification({
                    title: 'Success',
                    message: 'Note deleted successfully',
                    type: 'success',
                    duration: 3000
                });
                
                // Reset UI
                currentNote = null;
                emptyState.style.display = 'flex';
                noteEditorContainer.style.display = 'none';
                
                // On mobile, show sidebar after deletion
                if (window.innerWidth < 768) {
                    sidebar.classList.add('active');
                }
                
                // Reload notes list
                await loadNotes();
                
            } catch (error) {
                console.error('Error deleting note:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to delete note',
                    type: 'error',
                    duration: 3000
                });
            }
        }
        
        // Show share modal
        async function showShareModal() {
            if (!currentNote || isNewNote) return;
            
            // Reset modal
            shareMembersList.innerHTML = '';
            shareGroup.innerHTML = '<option value="">Select Group</option>';
            
            // Add current user's name at the top (disabled)
            const ownerItem = document.createElement('div');
            ownerItem.className = 'member-item';
            ownerItem.innerHTML = `
                <div class="member-info">
                    <div class="member-name">${currentUserData.name} (You - Owner)</div>
                </div>
                <div class="member-status">
                    <input type="checkbox" checked disabled>
                </div>
            `;
            shareMembersList.appendChild(ownerItem);
            
            // Add potential members based on note's class and subject
            if (userType === 'teacher') {
                // For teachers, show students in the note's class
                const classData = allClasses[currentNote.classId];
                if (classData && classData.students) {
                    classData.students.forEach(studentId => {
                        if (studentId !== currentUserId) {
                            const student = allStudents[studentId];
                            if (student) {
                                addMemberToShareList(student);
                            }
                        }
                    });
                }
                
                // Also show other teachers teaching the same subject
                for (const subjectId in allSubjects) {
                    if (subjectId === currentNote.subjectId) {
                        const teacherId = allSubjects[subjectId].teacher;
                        if (teacherId && teacherId !== currentUserId) {
                            const teacher = allTeachers[teacherId];
                            if (teacher) {
                                addMemberToShareList(teacher);
                            }
                        }
                    }
                }
            } else if (userType === 'student') {
                // For students, show teacher of the note's subject
                const subject = allSubjects[currentNote.subjectId];
                if (subject && subject.teacher && subject.teacher !== currentUserId) {
                    const teacher = allTeachers[subject.teacher];
                    if (teacher) {
                        addMemberToShareList(teacher);
                    }
                }
                
                // Also show classmates
                const classData = allClasses[currentNote.classId];
                if (classData && classData.students) {
                    classData.students.forEach(studentId => {
                        if (studentId !== currentUserId) {
                            const student = allStudents[studentId];
                            if (student) {
                                addMemberToShareList(student);
                            }
                        }
                    });
                }
            }
            
            // Add subject group to share options
            if (currentNote.subjectId && currentNote.classId) {
                const subject = allSubjects[currentNote.subjectId];
                const classData = allClasses[currentNote.classId];
                
                if (subject && classData) {
                    const option = document.createElement('option');
                    option.value = `subject_${currentNote.subjectId}_class_${currentNote.classId}`;
                    option.textContent = `${subject.name} - ${classData.name} Group`;
                    shareGroup.appendChild(option);
                }
            }
            
            // Show modal
            shareModal.style.display = 'flex';
        }
        
        // Add member to share list
        function addMemberToShareList(user) {
            const memberItem = document.createElement('div');
            memberItem.className = 'member-item';
            
            const avatarUrl = user.profileImage || user.avatar || 
                `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;
            
            memberItem.innerHTML = `
                <img src="${avatarUrl}" alt="${user.name}" class="member-avatar">
                <div class="member-info">
                    <div class="member-name">${user.name}</div>
                    <div class="member-role">${getUserType(user.id)}</div>
                </div>
                <div class="member-status">
                    <input type="checkbox" data-user-id="${user.id}" class="member-checkbox">
                </div>
            `;
            
            shareMembersList.appendChild(memberItem);
        }
        
        // Share note with selected users or group
        async function shareNote() {
            if (!currentNote) return;
            
            try {
                // Get selected members
                const checkboxes = shareMembersList.querySelectorAll('.member-checkbox');
                const selectedMembers = [];
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked && checkbox.dataset.userId) {
                        selectedMembers.push(checkbox.dataset.userId);
                    }
                });
                
                // Get selected group
                const selectedGroup = shareGroup.value;
                
                if (selectedMembers.length === 0 && !selectedGroup) {
                    showNotification({
                        title: 'Error',
                        message: 'Please select at least one member or group to share with',
                        type: 'error',
                        duration: 3000
                    });
                    return;
                }
                
                // Share with individual members
                for (const userId of selectedMembers) {
                    await set(ref(db, `sharedNotes/${userId}/${currentNote.id}`), {
                        ownerId: currentUserId,
                        sharedAt: new Date().toISOString()
                    });
                }
                
                // Share with group if selected
                if (selectedGroup) {
                    // Get group members
                    const groupSnapshot = await get(ref(db, `groupChats/${selectedGroup}`));
                    if (groupSnapshot.exists()) {
                        const group = groupSnapshot.val();
                        
                        // Share with all group members except current user
                        for (const memberId of group.members) {
                            if (memberId !== currentUserId) {
                                await set(ref(db, `sharedNotes/${memberId}/${currentNote.id}`), {
                                    ownerId: currentUserId,
                                    sharedAt: new Date().toISOString(),
                                    sharedViaGroup: selectedGroup
                                });
                            }
                        }
                    }
                }
                
                // Close modal
                shareModal.style.display = 'none';
                
                showNotification({
                    title: 'Success',
                    message: 'Note shared successfully',
                    type: 'success',
                    duration: 3000
                });
                
            } catch (error) {
                console.error('Error sharing note:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to share note',
                    type: 'error',
                    duration: 3000
                });
            }
        }
        
        // Highlight active note in list
        function highlightActiveNote() {
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
                
                if (currentNote && item.getAttribute('data-note-id') === currentNote.id) {
                    item.classList.add('active');
                }
            });
        }
        
        // Get user type
        function getUserType(userId) {
            if (allTeachers[userId]) return 'Teacher';
            if (allStudents[userId]) return 'Student';
            if (allAlumni[userId]) return 'Alumni';
            return 'User';
        }
        
        // Format date for display
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            
            const date = new Date(timestamp);
            return date.toLocaleDateString([], { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Initialize the app
        loadingScreen.style.display = 'flex';
        mainContainer.style.display = 'none';
        
        // Start the app
        initApp();
    </script>
</body>
</html>
