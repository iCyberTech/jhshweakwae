<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>School Notes Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* School Notes Portal CSS */
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --success-color: #00b894;
            --danger-color: #d63031;
            --warning-color: #fdcb6e;
            --info-color: #0984e3;
            --text-color: #2d3436;
            --light-text: #636e72;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-logo {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--text-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main Container */
        .container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Sidebar - Now the main page */
        .sidebar {
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 100;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.7);
            z-index: 10;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: var(--card-shadow);
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-student {
            background-color: var(--info-color);
            color: white;
        }

        .badge-teacher {
            background-color: var(--success-color);
            color: white;
        }

        .badge-alumni {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .sidebar-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .sidebar-actions i {
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.2s ease;
            padding: 8px;
        }

        .sidebar-actions i:hover {
            color: var(--primary-color);
        }

        .search-bar {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 107px;
            background: rgba(255, 255, 255, 0.7);
            z-index: 10;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-container i {
            position: absolute;
            left: 12px;
            color: var(--light-text);
        }

        .search-container input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.3);
            font-size: 1rem;
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 163px;
            background: rgba(255, 255, 255, 极速加速器
            z-index: 10;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            font-size: 0.95rem;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .note-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .note-item:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .note-item.active {
            background: rgba(108, 92, 231, 0.1);
            border-color: var(--primary-color);
        }

        .note-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .note-item-title {
            font-weight: 600;
            font-size: 1rem;
            flex: 1;
            margin-right: 10px;
        }

        .note-item-date {
            font-size: 0.8rem;
            color: var(--light-text);
            white-space: nowrap;
        }

        .note-item-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-item-content {
            font-size: 0.85rem;
           极速加速器
        }

        /* Mobile New Note Modal */
        .mobile-note-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .mobile-note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .mobile-note-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .mobile-note-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
            padding: 5px;
        }

        .mobile-note-form {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .mobile-form-section {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--glass-border);
        }

        .mobile-form-section h4 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-form-section h4 i {
            font-size: 1.1rem;
        }

        .mobile-form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mobile-form-group {
            display: flex;
            flex-direction: column;
        }

        .mobile-form-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-color);
        }

        .mobile-form-select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.5);
            font-size: 1rem;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='极速加速器 fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        .mobile-form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .mobile-note-title-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            font-weight: 600;
            border: none;
            border-bottom: 1px solid var(--glass-border);
            background: transparent;
            margin-bottom: 15px;
        }

        .mobile-note-title-input:focus {
            outline: none;
            border-bottom-color: var(--primary-color);
        }

        .mobile-note-content-input {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.3);
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
        }

        .mobile-note-content-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.5);
        }

        .mobile-note-actions {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.8);
        }

        .mobile-btn {
            padding: 12px 24px;
            border-radius: 20px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .mobile-btn-secondary {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
        }

        .mobile-btn-secondary:active {
            background: rgba(255, 255, 255, 0.7);
        }

        .mobile-btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .mobile-btn-primary:active {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }

        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-width: 90%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            position: relative;
            padding: 16px 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4极速加速器 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transform: translateX(120%);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(120%);
            opacity: 0;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .notification.info {
            background极速加速器: var(--info-color);
        }

        .notification-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            opacity: 0.9;
        }

        .notification-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            margin-left: 15px;
            font-size: 18px;
            opacity: 0.8;
            padding: 5px;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
            
            .sidebar {
                width: 350px;
                border-right: 1px solid var(--glass-border);
            }
            
            .mobile-note-modal {
                width: 100%;
                max-width: 500px;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                height: auto;
                max-height: 90vh;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }
        }

        @media (max-width: 480px) {
            .sidebar-header {
                padding: 15px;
            }
            
            .search-bar {
                padding: 10px 15px;
            }
            
            .tab {
                padding: 12px 8px;
                font-size: 0.85rem;
            }
            
            .mobile-note-header {
                padding: 12px 15px;
            }
            
            .mobile-note-title {
                font-size: 1.1rem;
            }
            
            .mobile-note-form {
                padding: 15px;
            }
            
            .mobile-form-section {
                padding: 12px;
            }
            
            .mobile-note-title-input {
                font-size: 1.2rem;
                padding: 12px;
            }
            
            .mobile-note-content-input {
                min-height: 150px;
                padding: 12px;
            }
            
            .mobile-note-actions {
                padding: 12px;
            }
        }

        /* Touch device improvements */
        @media (hover: none) and (pointer: coarse) {
            .note-item:hover {
                transform: none;
            }
            
            .sidebar-actions i:hover {
                color: var(--text-color);
            }
            
            .sidebar-actions i:active {
                color: var(--primary-color);
            }
            
            .mobile-btn-secondary:active {
                background: rgba(255, 255, 255, 0.7);
            }
            
            .mobile-btn-primary:active {
                background: var(--secondary-color);
                transform: translateY(-2px);
            }
        }

        /* Prevent zoom on input focus for mobile */
        @media (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class极速加速器 loading-logo">SN</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading School Notes</div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Main Container -->
    <div class="container" id="main-container" style="display: none;">
        <!-- Sidebar (Now the main page) -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <img id="user-avatar" src="" alt="User" class="user-avatar">
                    <div>
                        <div class="user-name" id="user-name">Loading...</div>
                        <div class="user-badge" id极速加速器"user-badge">...</div>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <i class="fas fa-plus" id="new-note-btn" title="New Note"></i>
                    <i class="fas fa-ellipsis-v" id="menu-btn" title="Menu"></i>
                </div>
            </div>
            
            <div class="search-bar">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search notes" id="search-input">
                </div>
            </div>
            
            <div class="tab-bar">
                <div class="tab active" data-tab="my-notes">My Notes</div>
                <div class="tab" data-tab="shared">Shared With Me</div>
                <div class="tab" data-tab="class-notes">Class Notes</div>
            </div>
            
            <div class="notes-list" id="notes-list">
                <!-- Notes will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Mobile New Note Modal -->
    <div class="mobile-note-modal" id="mobile-note-modal">
        <div class="mobile-note-header">
            <div class="mobile-note-title" id="mobile-note-modal-title">New Note</div>
            <button class="mobile-note-close" id="mobile-note-close">&times;</button>
        </div>
        
        <div class="mobile-note-form">
            <div class="mobile-form-section">
                <h4><i class="fas fa-book"></i> Note Details</h4>
                <div class="mobile-form-row">
                    <div class="mobile-form-group">
                        <label class="mobile-form-label" for="mobile-note-subject">Subject</label>
                        <select id="mobile-note-subject" class="mobile-form-select">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    <div class="mobile-form-group">
                        <label class="mobile-form-label" for="mobile-note-class">Class</label>
                        <select id="mobile-note-class" class="mobile-form-select">
                            <option value="">Select Class</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mobile-form-section">
                <h4><i class="fas fa-calendar"></i> Week Selection</h4>
                <div class="mobile-form-group">
                    <label class="mobile-form-label" for="mobile-note-week">Week</label>
                    <select id="mobile-note-week" class="mobile-form-select">
                        <option value="">Select Week</option>
                        <option value="1">Week 1</option>
                        <option value="2">Week 2</option>
                        <option value="3">Week 3</option>
                        <option value="4">Week 4</option>
                        <option value="5">Week 5</option>
                        <option value="6">Week 6</option>
                        <option value="7">Week 7</option>
                        <option value="8">Week 8</option>
                        <option value="9">Week 9</option>
                        <option value="10">Week 10</option>
                        <option value="11">Week 11</option>
                        <option value极速加速器"12">Week 12</option>
                    </select>
                </div>
            </div>
            
            <div class="mobile-form-section">
                <h4><i class="fas fa-edit"></i> Note Content</h4>
                <input type="text" id="mobile-note-title-input" class="mobile-note-title-input" placeholder="Note Title">
                <textarea id="mobile-note-content-input" class="mobile-note-content-input" placeholder="Write your note here..."></textarea>
            </div>
        </div>
        
        <div class="mobile-note-actions">
            <button class="mobile-btn mobile-btn-secondary" id="mobile-note-cancel-btn">Cancel</button>
            <button class="mobile-btn mobile-btn-primary" id="mobile-note-save-btn">Save Note</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, push, update, onValue, onChildAdded, onChildChanged, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkrHsyfCTijqKP7UJv0eSx0iNvl8S06U8",
            authDomain: "sms-single.firebaseapp.com",
            projectId: "sms-single",
            storageBucket: "sms-single.appspot.com",
            messagingSenderId: "140188895278",
            appId: "1:140188895278:web:1b56660a13e5b088ce77bf",
            measurementId: "G-7ER348P6VZ"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContainer = document.getElementById('main-container');
        const notificationContainer = document.getElementById('notification-container');
        const sidebar = document.getElementById('sidebar');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userBadge = document.getElementById('user-badge');
        const searchInput = document.getElementById('search-input');
        const tabs = document.querySelectorAll('.tab');
        const notesList = document.getElementById('notes-list');
        const newNoteBtn = document.getElementById('new-note-btn');
        
        // Mobile note modal elements
        const mobileNoteModal = document.getElementById('mobile-note-modal');
        const mobileNoteModalTitle = document.getElementById('mobile-note-modal-title');
        const mobileNoteClose = document.getElementById('mobile-note-close');
        const mobileNoteSubject = document.getElementById('mobile-note-subject');
        const mobileNoteClass = document.getElementById('mobile-note-class');
        const mobileNoteWeek = document.getElementById('mobile-note-week');
        const mobileNoteTitleInput = document.getElementById('mobile-note-title-input');
        const mobileNoteContentInput = document.getElementById('mobile-note-content-input');
        const mobileNoteCancelBtn = document.getElementById('mobile-note-cancel-btn');
        const mobileNoteSaveBtn = document.getElementById('mobile-note-save-btn');
        
        // Firebase references
        const authUsersRef = ref(db, 'authUsers');
        const teachersRef = ref(db, 'teachers');
        const studentsRef = ref(db, 'students');
        const alumniRef = ref(db, 'alumni');
        const credentialsRef = ref(db, 'credentials');
        const classesRef = ref(db, 'classes');
        const subjectsRef = ref(db, 'subjects');
        const notesRef = ref(db, 'notes');
        const sharedNotesRef = ref(db, 'sharedNotes');
        const activeSessionsRef = ref(db, 'activeSessions');
        
        // Global variables
        let currentUserId = null;
        let currentUserData = null;
        let userType = null;
        let allTeachers = {};
        let allStudents = {};
        let allAlumni = {};
        let allClasses = {};
        let allSubjects = {};
        let currentNote = null;
        let userClasses = [];
        let userSubjects = [];
        let isNewNote = false;
        
        // Show notification function
        function showNotification({ title, message, type = 'info', duration = 5000 }) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas fa-${iconMap[type]} notification-icon"></i>
                <div class极速加速器"notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Trigger reflow to enable animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto-dismiss after duration
            let timeoutId;
            if (duration > 0) {
                timeoutId = setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.add('hide');
                    
                    // Remove after animation completes
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
            
            // Close button handler
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                clearTimeout(timeoutId);
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
            
            return notification;
        }
        
        // Identify the current user based on device info
        async function identifyCurrentUser() {
            try {
                // Get all auth users
                const authUsersSnapshot = await get(authUsersRef);
                if (!authUsersSnapshot.exists()) {
                    throw new Error('No auth users found');
                }
                
                const authUsers = authUsersSnapshot.val();
                const credentialsSnapshot = await get(credentialsRef);
                const credentials = credentialsSnapshot.exists() ? credentialsSnapshot.val() : {};
                
                // Get current device info from browser
                const userAgent = navigator.userAgent;
                const screenResolution = `${window.screen.width}x${window.screen.height}`;
                const language = navigator.language;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // Find matching user based on device info
                for (const [authId, authUser] of Object.entries(authUsers)) {
                    const user极速加速器 = credentials[authUser.userId];
                    if (userCredential && userCredential.deviceInfo) {
                        const deviceInfo = userCredential.deviceInfo;
                        
                        // Check for matching device characteristics
                        if (deviceInfo.userAgent === userAgent && 
                            deviceInfo.screenResolution === screenResolution &&
                            deviceInfo.language === language && 
                            deviceInfo.timezone === timezone) {
                            
                            // This is likely the current user
                            currentUserId = authUser.userId;
                            userType = authUser.userType;
                            
                            // Get user details from appropriate collection
                            let userRef;
                            if (userType === 'teacher') {
                                userRef = ref(db, `teachers/${currentUserId}`);
                            } else if (userType === 'student') {
                                userRef = ref(db, `students/${极速加速器UserId}`);
                            } else if (userType === 'alumni') {
                                userRef = ref(db, `alumni/${currentUserId}`);
                            } else {
                                throw new Error('Unknown user type');
                            }
                            
                            const userSnapshot = await get(userRef);
                            
                            if (userSnapshot.exists()) {
                                currentUserData = userSnapshot.val();
                                return currentUserData;
                            }
                        }
                    }
                }
                
                // If no match found, try to get from activeSessions as fallback
                const activeSessionSnapshot = await get(activeSessionsRef);
                if (activeSessionSnapshot.exists()) {
                    const activeSessions = activeSessionSnapshot.val();
                    
                    if (activeSessions.student) {
                        currentUserId = activeSessions.student;
                        userType = 'student';
                    } else if (activeSessions.teacher) {
                        currentUserId = activeSessions.teacher;
                        userType = 'teacher';
                    } else if (activeSessions.alumni) {
                        currentUserId = activeSessions.alumni;
                        userType = 'alumni';
                    }
                    
                    if (currentUserId) {
                        let userRef;
                        if (userType === 'teacher') {
                            userRef = ref(db, `teachers/${currentUserId}`);
                        } else if (userType === 'student') {
                            userRef = ref(db, `students/${currentUserId}`);
                        } else if (userType === 'alumni') {
                            userRef = ref(db, `alumni/${currentUserId}`);
                        }
                        
                        const userSnapshot = await get(userRef);
                        
                        if (userSnapshot.exists()) {
                            currentUserData = userSnapshot.val();
                            return currentUserData;
                        }
                    }
                }
                
                throw new Error('No matching user found');
            } catch (error) {
                console.error('Error identifying user:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to identify user: ' + error.message,
                    type: 'error'
                });
                return null;
            }
        }
        
        // Initialize the app
        async function initApp() {
            try {
                // First try to identify the user based on device info
                const user = await identifyCurrentUser();
                
                if (user) {
                    // Update UI with user info
                    userName.textContent = user.name || 'User';
                    
                    // Set user badge
                    if (userType === 'student') {
                        userBadge.textContent = 'Student';
                        userBadge.className = 'user-badge badge-student';
                    } else if (userType === 'teacher') {
                        user极速加速器.textContent = 'Teacher';
                        userBadge.className = 'user-badge badge-teacher';
                    } else if (userType === 'alumni') {
                        userBadge.text极速加速器 = 'Alumni';
                        userBadge.className = 'user-badge badge-alumni';
                    }
                    
                    // Set avatar
                    const avatarUrl = user.profileImage || user.avatar || 
                        `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUserId}`;
                    userAvatar.src = avatarUrl;
                    
                    // Load all teachers, students, and alumni
                    await loadAllUsers();
                    
                    // Load all classes and subjects
                    await loadAllClasses();
                    await loadAllSubjects();
                    
                    // Determine user's classes and subjects
                    await determineUserClassesAndSubjects();
                    
                    // Populate subject and class dropdowns
                    populateDropdowns();
                    
                    // Set up event listeners
                    setupEventListeners();
                    
                    // Load notes
                    await loadNotes();
                    
                    // Hide loading screen and show main content
                    loadingScreen.style.display = 'none';
                    mainContainer.style.display = 'flex';
                    
                    showNotification({
                        title: 'Welcome Back',
                        message: `You're logged in as ${user.name || 'User'}`,
                        type: 'success',
                        duration: 3000
                    });
                    
                    return;
                }
                
                // If no user identified
                showNotification({
                    title: 'Session Expired',
                    message: 'Please sign in again',
                    type: 'error',
                    duration: 0
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to load user information',
                    type: 'error'
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        // Load all users (teachers, students, alumni)
        async function loadAllUsers() {
            // Load teachers
            const teachersSnapshot = await get(teachersRef);
            allTeachers = teachersSnapshot.exists() ? teachersSnapshot.val() : {};
            
            // Load students
            const studentsSnapshot = await get(studentsRef);
            allStudents = studentsSnapshot.exists() ? studentsSnapshot.val() : {};
            
            // Load alumni
            const alumniSnapshot = await get(alumniRef);
            allAlumni = alumniSnapshot.exists() ? alumniSnapshot.val() : {};
        }
        
        // Load all classes
        async function loadAllClasses() {
            const snapshot = await get(classesRef);
            allClasses = snapshot.exists() ? snapshot.val() : {};
        }
        
        // Load all subjects
        async function loadAllSubjects() {
            const snapshot = await get(subjectsRef);
            allSubjects = snapshot.exists() ? snapshot.val() : {};
        }
        
        // Determine which classes and subjects the user is associated with
        async function determineUserClassesAndSubjects() {
            userClasses = [];
            userSubjects = [];
            
            if (userType === 'student') {
                // For students, get their class from student data
                if (currentUserData.class) {
                    userClasses.push(currentUserData.class);
                    
                    // Find subjects taught in this class
                    for (const subjectId in allSubjects) {
                        const subject = allSubjects[subjectId];
                        if (subject.class === currentUserData.class) {
                            userSubjects.push({
                                id: subjectId,
                                ...subject
                            });
                        }
                    }
                }
            } else if (userType === 'teacher') {
                // For teachers, get classes and subjects they teach
                for (const subject极速加速器 in allSubjects) {
                    const subject = allSubjects[subjectId];
                    if (subject.teacher === currentUserId) {
                        userSubjects.push({
                            id: subjectId,
                            ...subject
                        });
                        
                        if (subject.class && !userClasses.includes(subject.class)) {
                            userClasses.push(subject.class);
                        }
                    }
                }
            } else if (userType === 'alumni') {
                // For alumni, we might want to show notes from their previous classes
                if (currentUserData.previousClass) {
                    userClasses.push(currentUser极速加速器.previousClass);
                    
                    // Find subjects from their previous class
                    for (const subjectId in allSubjects) {
                        const subject = allSubjects[subjectId];
                        if (subject.class === currentUserData.previousClass) {
                            userSubjects.push({
                                id: subjectId,
                                ...subject
                            });
                        }
                    }
                }
            }
        }
        
        // Populate subject and class dropdowns
        function populateDropdowns() {
            // Clear existing options
            mobileNoteSubject.innerHTML = '<option value="">Select Subject</option>';
            mobileNoteClass.innerHTML = '<option value="">Select Class</option>';
            
            // Add subjects based on user type
            if (userType === 'teacher') {
                // Teachers can select any subject they teach
                userSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    mobileNoteSubject.appendChild(option);
                });
            } else if (userType === 'student') {
                // Students can only see subjects from their class
                userSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    mobileNoteSubject.appendChild(option);
                });
            }
            
            // Add classes based on user type
            if (userType === 'teacher') {
                // Teachers can select any class they teach
                userClasses.forEach(classId => {
                    const classData = allClasses[classId];
                    if (classData) {
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = classData.name;
                        mobileNoteClass.appendChild(option);
                    }
                });
            } else if (userType === 'student') {
                // Students can only see their own class
                if (currentUserData.class) {
                    const classData = allClasses[currentUserData.class];
                    if (classData) {
                        const option = document.createElement('option');
                        option.value = currentUserData.class;
                        option.textContent = classData.name;
                        mobileNoteClass.appendChild(option);
                    }
                }
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // New note button
            newNoteBtn.addEventListener('click', createNewNote);
            
            // Mobile note modal events
            mobileNoteClose.addEventListener('click', () => {
                mobileNoteModal.style.display = 'none';
            });
            
            mobileNoteCancelBtn.addEventListener('click', () => {
                mobileNoteModal.style.display = 'none';
            });
            
            mobileNoteSaveBtn.addEventListener('click', saveNote);
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Reload notes based on selected tab
                    loadNotes();
                });
            });
            
            // Search input
            searchInput.addEventListener('input', (e) => {
                filterNotes(e.target.value);
            });
        }
        
        // Load notes based on selected tab
        async function loadNotes() {
            notesList.innerHTML = '';
            
            const selectedTab = document.querySelector('.tab.active').getAttribute('data-tab');
            
            if (selectedTab === 'my-notes') {
                await loadMyNotes();
            } else if (selectedTab === 'shared') {
                await loadSharedNotes();
            } else if (selectedTab === 'class-notes') {
                await loadClassNotes();
            }
        }
        
        // Load user's own notes
        async function loadMyNotes() {
            const notesSnapshot = await get(ref(db, `notes/${currentUserId}`));
            const notes = notesSnapshot.exists() ? notesSnapshot.val() : {};
            
            const notesArray = [];
            
            for (const noteId in notes) {
                const note = {
                    id: noteId,
                    ...notes[noteId]
                };
                notesArray.push(note);
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Notes Found</h3>
                    <p>You haven't created any notes yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Load notes shared with the user
        async function loadSharedNotes() {
            const sharedSnapshot = await get(ref(db, `sharedNotes/${currentUserId}`));
            const shared极速加速器 = sharedSnapshot.exists() ? sharedSnapshot.val() : {};
            
            const notesArray = [];
            
            for (const noteId in sharedNotes) {
                // Get the actual note
                const noteOwner = sharedNotes[noteId].ownerId;
                const noteSnapshot = await get(ref(db, `notes/${noteOwner}/${noteId}`));
                
                if (noteSnapshot.exists()) {
                    const note = {
                        id: noteId,
                        ownerId: noteOwner,
                        ...noteSnapshot.val()
                    };
                    notesArray.push(note);
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.created极速加速器));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note, true);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky极速加速器"></i>
                    <h3>No Shared Notes</h3>
                    <p>No one has shared any notes with you yet.</p>
                `;
                notesList.appendChild(empty极速加速器);
            }
        }
        
        // Load class notes (for students)
        async function loadClassNotes() {
            if (userType !== 'student') {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>Class Notes</h3>
                    <p>This section is only available to students.</p>
                `;
                notesList.appendChild(emptyItem);
                return;
            }
            
            // Get all notes from teachers of this student's subjects
            const notesArray = [];
            
            for (const subject of userSubjects) {
                if (subject.teacher) {
                    const teacherNotesSnapshot = await get(ref(db, `notes/${subject.teacher}`));
                    const teacherNotes = teacherNotesSnapshot.exists() ? teacherNotesSnapshot.val() : {};
                    
                    for (const noteId in teacherNotes) {
                        const note = teacherNotes[noteId];
                        
                        // Check if note is for this student's class and subject
                        if (note.classId === currentUserData.class && note.subjectId === subject.id) {
                            const fullNote = {
                                id: noteId,
                                ownerId: subject.teacher,
                                ...note
                            };
                            notesArray.push(fullNote);
                        }
                    }
                }
            }
            
            // Sort notes by date (newest first)
            notesArray.sort((a, b极速加速器) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
            
            // Display notes
            if (notesArray.length > 0) {
                notesArray.forEach(note => {
                    const noteItem = createNoteItem(note, true);
                    notesList.appendChild(noteItem);
                });
            } else {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'empty-state';
                emptyItem.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>No Class Notes</h3>
                    <p>Your teachers haven't shared any notes for your class yet.</p>
                `;
                notesList.appendChild(emptyItem);
            }
        }
        
        // Create a note list item
        function createNoteItem(note, isShared = false) {
            const noteItem = document.createElement('div');
            noteItem.className = 'note-item';
            noteItem.setAttribute('data-note-id', note.id);
            
            // Get subject and class names
            const subjectName = allSubjects[note.subjectId]?.name || 'Unknown Subject';
            const className = allClasses[note.classId]?.name || 'Unknown Class';
            
            noteItem.innerHTML = `
                <div class="note-item-header">
                    <div class="note-item-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-item-date">${formatDate(note.updatedAt || note.createdAt)}</div>
                </div>
                <div class="note-item-preview">
                    <div class="note-item-content">
                        ${subjectName} • ${className} • Week ${note.week || 'N/A'}
                    </div>
                    ${isShared ? '<div class="user-badge" style="background-color: var(--secondary-color); color: white;">Shared</div>' : ''}
                </div>
            `;
            
            // Add click handler to open note
            noteItem.addEventListener('click', () => openNote(note));
            
            return noteItem;
        }
        
        // Filter notes based on search input
        function filterNotes(searchTerm) {
            const term = searchTerm.toLowerCase();
            const items = notesList.querySelectorAll('.note-item');
            
            items.forEach(item => {
                const title = item.querySelector('.note-item-title').textContent.toLowerCase();
                const content = item.querySelector('.note-item-content').textContent.toLowerCase();
                
                if (title.includes(term) || content.includes(term)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Create a new note
        function createNewNote() {
            currentNote = null;
            isNewNote = true;
            
            // Reset form
            mobileNoteTitleInput.value = '';
            mobileNoteContentInput.value = '';
            mobileNoteSubject.value = '';
            mobileNoteClass.value = '';
            mobileNoteWeek.value = '';
            
            // Update UI
            mobileNoteModalTitle.textContent = 'New Note';
            
            // For teachers, allow selecting subject and class
            if (userType === 'teacher') {
                mobileNoteSubject.disabled = false;
                mobileNoteClass.disabled = false;
            } else {
                // For students, set to their class and first subject (can be changed)
                if (currentUserData.class) {
                    mobileNoteClass.value = currentUserData.class;
                    mobileNoteClass.disabled = true;
                    
                    if (userSubjects.length > 0) {
                        mobileNoteSubject.value = userSubjects[0].id;
                    }
                }
            }
            
            // Show modal
            mobileNoteModal.style.display = 'flex';
        }
        
        // Open a note for viewing/editing
        async function openNote(note) {
            currentNote = note;
            isNewNote = false;
            
            // Load note details
            await loadNote(note.id);
            
            // Update UI
            mobileNoteModalTitle.textContent = note.title || 'Untitled Note';
            
            // Show modal
            mobileNoteModal.style.display = 'flex';
        }
        
        // Load note details
        async function loadNote(noteId) {
            let note;
            
            if (currentNote.ownerId && currentNote.ownerId !== currentUserId) {
                // This is a shared note, get from owner's notes
                const noteSnapshot = await get(ref(db, `notes/${currentNote.ownerId}/${noteId}`));
                note = noteSnapshot.exists() ? noteSnapshot.val() : null;
            } else {
                // This is the user's own note
                const noteSnapshot = await get(ref(db, `notes/${currentUserId}/${noteId}`));
                note = noteSnapshot.exists() ? noteSnapshot.val() : null;
            }
            
            if (!note) {
                showNotification({
                    title: 'Error',
                    message: 'Note not found',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            // Update form fields
            mobileNoteTitleInput.value = note.title || '';
            mobileNoteContentInput.value = note.content || '';
            mobileNoteSubject.value = note.subjectId || '';
            mobileNoteClass.value = note.classId || '';
            mobileNoteWeek.value = note.week || '';
            
            // Disable editing if this is a shared note and user is not the owner
            if (currentNote.ownerId && currentNote.ownerId !== currentUserId) {
                mobileNoteTitleInput.readOnly = true;
                mobileNoteContentInput.readOnly = true;
                mobileNoteSubject.disabled = true;
                mobileNoteClass.disabled = true;
                mobileNoteWeek.disabled = true;
                mobileNoteSaveBtn.style.display = 'none';
            } else {
                mobileNoteTitleInput.readOnly = false;
                mobileNoteContentInput.readOnly = false;
                mobileNoteSubject.disabled = false;
                mobileNoteClass.disabled = false;
                mobileNoteWeek.disabled = false;
                mobileNoteSaveBtn.style.display = 'block';
            }
        }
        
        // Save note
        async function saveNote() {
            const title = mobileNoteTitleInput.value.trim();
            const content = mobileNoteContentInput.value.trim();
            const subjectId = mobileNoteSubject.value;
            const classId = mobileNoteClass.value;
            const week = mobileNoteWeek.value;
            
            if (!title) {
                showNotification({
                    title: 'Error',
                    message: 'Please enter a title for your note',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            if (!subjectId || !classId || !week) {
                showNotification({
                    title: 'Error',
                    message: 'Please select subject, class, and week',
                    type: 'error',
                    duration: 3000
                });
                return;
            }
            
            try {
                const now = new Date().toISOString();
                const noteData = {
                    title: title,
                    content: content,
                    subjectId: subjectId,
                    classId: classId,
                    week: week,
                    updatedAt: now,
                    ownerName: currentUserData.name
                };
                
                if (isNewNote) {
                    // Create new note
                    noteData.createdAt = now;
                    const newNoteRef = push(ref(db, `notes/${currentUserId}`));
                    await set(newNoteRef, noteData);
                    
                    currentNote = {
                        id: newNoteRef.key,
                        ...noteData
                    };
                    
                    showNotification({
                        title: 'Success',
                        message: 'Note created successfully',
                        type: 'success',
                        duration: 3000
                    });
                } else {
                    // Update existing note
                    noteData.createdAt = currentNote.createdAt;
                    await set(ref(db, `notes/${currentUserId}/${currentNote.id}`), noteData);
                    
                    currentNote = {
                        ...currentNote,
                        ...极速加速器Data
                    };
                    
                    showNotification({
                        title: 'Success',
                        message: 'Note updated successfully',
                        type: 'success',
                        duration: 3000
                    });
                }
                
                // Close modal
                mobileNoteModal.style.display = 'none';
                
                // Reload notes list
                await loadNotes();
                
                isNewNote = false;
                
            } catch (error) {
                console.error('Error saving note:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to save note',
                    type: 'error',
                    duration: 3000
                });
            }
        }
        
        // Format date for display
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            
            const date = new Date(timestamp);
            return date.toLocaleDateString([], { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Initialize the app
        loadingScreen.style.display = 'flex';
        mainContainer.style.display = 'none';
        
        // Start the app
        initApp();
    </script>
</body>
</html>
