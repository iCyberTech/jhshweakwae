<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Communication Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary-color: #0088cc;
            --secondary-color: #00a2e8;
            --sidebar-bg: #f8f9fa;
            --chat-bg: #ffffff;
            --message-sent-bg: #e3f2fd;
            --message-received-bg: #f5f5f5;
            --text-color: #333333;
            --light-text: #707579;
            --border-color: #e6e6e6;
            --online-status: #00c853;
            --offline-status: #9e9e9e;
            --active-tab: #e6f7ff;
            --hover-color: #f0f0f0;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-color);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            display: flex;
            max-width: 1400px;
            height: 100vh;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 15px 20px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
        }

        .user-status {
            font-size: 12px;
            color: var(--light-text);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 20px;
        }

        .search-container {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 20px;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
        }

        .search-box input {
            flex: 1;
            border: none;
            outline: none;
            padding: 5px;
            background: transparent;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }

        .tab.active {
            background: var(--active-tab);
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
        }

        .contact-item:hover {
            background: var(--hover-color);
        }

        .contact-item.active {
            background: var(--active-tab);
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
        }

        .online-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--online-status);
            border-radius: 50%;
            bottom: 0;
            right: 0;
            border: 2px solid white;
        }

        .contact-info {
            flex: 1;
            margin-left: 12px;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .contact-preview {
            font-size: 13px;
            color: var(--light-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-meta {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .contact-time {
            font-size: 11px;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .unread-count {
            background: var(--primary-color);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Chat Area Styles */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            background: var(--sidebar-bg);
        }

        .back-button {
            margin-right: 15px;
            cursor: pointer;
            display: none;
        }

        .current-chat-info {
            flex: 1;
        }

        .current-chat-name {
            font-weight: 600;
            font-size: 16px;
        }

        .current-chat-status {
            font-size: 13px;
            color: var(--light-text);
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--chat-bg);
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 10px;
            position: relative;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: var(--message-sent-bg);
            border-bottom-right-radius: 2px;
        }

        .message.received {
            align-self: flex-start;
            background: var(--message-received-bg);
            border-bottom-left-radius: 2px;
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--primary-color);
        }

        .message-text {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            color: var(--light-text);
            text-align: right;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: var(--sidebar-bg);
            border-top: 1px solid var(--border-color);
            align-items: center;
        }

        .attachment-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 20px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Group List Styles */
        .group-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .group-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .group-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .group-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .group-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .group-members {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        /* Loading and Notification Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--text-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-container {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 90%;
            max-width: 350px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            color: white;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: linear-gradient(135deg, #00b894 0%, #00d4a4 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #d63031 0%, #e84141 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #0984e3 0%, #2aa1f5 100%);
        }

        .notification-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            opacity: 0.9;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
            }
            
            .sidebar {
                width: 100%;
                height: 100%;
                display: none;
            }
            
            .sidebar.active {
                display: flex;
            }
            
            .chat-area {
                display: none;
            }
            
            .chat-area.active {
                display: flex;
            }
            
            .back-button {
                display: block;
            }
            
            .group-list {
                grid-template-columns: 1fr;
            }
            
            .message {
                max-width: 85%;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px;
            }
            
            .chat-header {
                padding: 12px 15px;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-input {
                padding: 12px;
            }
            
            .group-item {
                padding: 12px;
            }
        }

        /* Welcome screen when no chat is selected */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--chat-bg);
            text-align: center;
            padding: 20px;
        }

        .welcome-icon {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .welcome-text {
            font-size: 16px;
            color: var(--light-text);
            max-width: 400px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Communication Portal...</div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;">
        <div class="container">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="header">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">T</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name">Teacher Name</div>
                            <div class="user-status" id="user-status">Online</div>
                        </div>
                    </div>
                    <button class="logout-btn" id="logout-btn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>

                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search" style="color: var(--light-text); margin-right: 8px;"></i>
                        <input type="text" placeholder="Search..." id="search-input">
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="students">Students</div>
                    <div class="tab" data-tab="teachers">Teachers</div>
                    <div class="tab" data-tab="subject-groups">Groups</div>
                </div>

                <div class="contacts-list">
                    <!-- Students will be populated here -->
                    <div id="students-list"></div>
                    <div id="teachers-list" style="display: none;"></div>
                    <div id="subject-groups-list" style="display: none;"></div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chat-area">
                <div class="welcome-screen" id="welcome-screen">
                    <div class="welcome-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="welcome-title">Teacher Communication Portal</div>
                    <div class="welcome-text">Select a contact or group from the sidebar to start chatting</div>
                </div>

                <div class="chat-header" id="active-chat-header" style="display: none;">
                    <div class="back-button" id="back-button">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="current-chat-info">
                        <div class="current-chat-name" id="current-chat-name">Contact Name</div>
                        <div class="current-chat-status" id="current-chat-status">Online</div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" title="Call">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="chat-action-btn" title="Video Call">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="chat-action-btn" title="More options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages" style="display: none;"></div>

                <div class="chat-input" id="chat-input" style="display: none;">
                    <button class="attachment-btn" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="text" id="message-input" placeholder="Type a message...">
                    <button class="send-btn" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
         const firebaseConfig = {
    apiKey: "AIzaSyB5NcC2P3v0LFBVFMp9-mAHQKYuo1pKokA",
    authDomain: "hweakwaecram.firebaseapp.com",
    projectId: "hweakwaecram",
    storageBucket: "hweakwaecram.firebasestorage.app",
    messagingSenderId: "1012181976581",
    appId: "1:1012181976581:web:eee0ad07650b360bc8fe6c",
    measurementId: "G-4GMZJJRVG0"
  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const notificationContainer = document.getElementById('notification-container');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userStatus = document.getElementById('user-status');
        const tabs = document.querySelectorAll('.tab');
        const searchInput = document.getElementById('search-input');
        
        // Sidebar and chat elements
        const sidebar = document.getElementById('sidebar');
        const chatArea = document.getElementById('chat-area');
        const welcomeScreen = document.getElementById('welcome-screen');
        const activeChatHeader = document.getElementById('active-chat-header');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const backButton = document.getElementById('back-button');
        
        // Contact lists
        const studentsList = document.getElementById('students-list');
        const teachersList = document.getElementById('teachers-list');
        const subjectGroupsList = document.getElementById('subject-groups-list');
        
        // Chat elements
        const currentChatName = document.getElementById('current-chat-name');
        const currentChatStatus = document.getElementById('current-chat-status');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Global variables
        let currentTeacherId = null;
        let currentTeacherData = null;
        let currentChatStudent = null;
        let currentChatTeacher = null;
        let currentChatGroup = null;
        let studentsData = {};
        let teachersData = {};
        let subjectsData = {};
        let classesData = {};
        let activeTab = 'students';
        let messageListeners = {};
        
        // Show notification function
        function showNotification({ title, message, type = 'info', duration = 5000 }) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas fa-${iconMap[type]} notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Trigger reflow to enable animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto-dismiss after duration
            let timeoutId;
            if (duration > 0) {
                timeoutId = setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.add('hide');
                    
                    // Remove after animation completes
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
            
            // Close button handler
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                clearTimeout(timeoutId);
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
            
            return notification;
        }
        
        // Identify the current teacher based on Firebase Auth
        async function identifyCurrentTeacher() {
            return new Promise((resolve, reject) => {
                // Check if user is already signed in
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            // User is signed in, get their data from authUsers
                            const authUserSnapshot = await database.ref(`authUsers/${user.uid}`).once('value');
                            
                            if (authUserSnapshot.exists()) {
                                const authUser = authUserSnapshot.val();
                                
                                if (authUser.userType === 'teacher') {
                                    currentTeacherId = authUser.userId;
                                    
                                    // Get teacher details from teachers collection
                                    const teacherSnapshot = await database.ref(`teachers/${currentTeacherId}`).once('value');
                                    
                                    if (teacherSnapshot.exists()) {
                                        currentTeacherData = teacherSnapshot.val();
                                        unsubscribe();
                                        resolve(currentTeacherData);
                                        return;
                                    }
                                }
                            }
                            
                            // If we reach here, the auth user doesn't have proper teacher data
                            unsubscribe();
                            reject(new Error('Teacher data not found for authenticated user'));
                        } catch (error) {
                            unsubscribe();
                            reject(error);
                        }
                    } else {
                        // No user is signed in
                        unsubscribe();
                        reject(new Error('No user is currently signed in'));
                    }
                }, (error) => {
                    unsubscribe();
                    reject(error);
                });
            });
        }
        
        // Check for active teacher session
        async function checkActiveSession() {
            try {
                // First try to identify the teacher based on auth state
                const teacher = await identifyCurrentTeacher();
                
                if (teacher) {
                    // Update UI with teacher info
                    userAvatar.textContent = teacher.name ? teacher.name.charAt(0) : 'T';
                    userName.textContent = teacher.name || 'Teacher';
                    userStatus.textContent = 'Online';
                    
                    // Load teacher's data
                    loadTeacherData();
                    
                    // Hide loading screen and show main content
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    showNotification({
                        title: 'Welcome!',
                        message: 'Communication portal loaded successfully',
                        type: 'success',
                        duration: 3000
                    });
                    
                    return;
                }
                
                // If no teacher identified
                showNotification({
                    title: 'Session Expired',
                    message: 'Please sign in again',
                    type: 'error',
                    duration: 0
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'logins.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error checking active session:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to load teacher information',
                    type: 'error'
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'logins.html';
                }, 2000);
            }
        }
        
        // Load teacher's students, colleagues, and subject groups
        async function loadTeacherData() {
            try {
                // Load all necessary data
                const [studentsSnapshot, teachersSnapshot, subjectsSnapshot, classesSnapshot] = await Promise.all([
                    database.ref('students').once('value'),
                    database.ref('teachers').once('value'),
                    database.ref('subjects').once('value'),
                    database.ref('classes').once('value')
                ]);
                
                // Store data in global variables
                studentsData = studentsSnapshot.val() || {};
                teachersData = teachersSnapshot.val() || {};
                subjectsData = subjectsSnapshot.val() || {};
                classesData = classesSnapshot.val() || {};
                
                // Load teacher's students
                loadTeacherStudents();
                
                // Load other teachers
                loadOtherTeachers();
                
                // Load subject groups
                loadSubjectGroups();
                
            } catch (error) {
                console.error('Error loading teacher data:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to load communication data',
                    type: 'error'
                });
            }
        }
        
        // Load teacher's students
        function loadTeacherStudents() {
            studentsList.innerHTML = '';
            
            // Find students assigned to this teacher through subjects
            const teacherStudents = [];
            
            for (const subjectId in subjectsData) {
                const subject = subjectsData[subjectId];
                
                // Check if this teacher is assigned to this subject
                if (subject.assignments && subject.assignments[currentTeacherId]) {
                    // Get class IDs from assignments
                    let classIds = [];
                    
                    if (Array.isArray(subject.assignments[currentTeacherId])) {
                        classIds = subject.assignments[currentTeacherId].map(a => a.classId);
                    } else if (subject.assignments[currentTeacherId].classId) {
                        classIds = [subject.assignments[currentTeacherId].classId];
                    }
                    
                    // Find students in these classes
                    for (const studentId in studentsData) {
                        const student = studentsData[studentId];
                        
                        if (classIds.includes(student.classId)) {
                            // Avoid duplicates
                            if (!teacherStudents.find(s => s.id === studentId)) {
                                teacherStudents.push({
                                    id: studentId,
                                    ...student
                                });
                            }
                        }
                    }
                }
            }
            
            if (teacherStudents.length === 0) {
                studentsList.innerHTML = '<div class="contact-item">No students found</div>';
                return;
            }
            
            // Display students
            teacherStudents.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'contact-item';
                studentItem.dataset.id = student.id;
                studentItem.dataset.type = 'student';
                
                studentItem.innerHTML = `
                    <div class="contact-avatar">
                        ${student.name ? student.name.charAt(0) : 'S'}
                        <div class="online-dot"></div>
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${student.name || 'Student'}</div>
                        <div class="contact-preview">Tap to start chatting</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">Now</div>
                    </div>
                `;
                
                studentItem.addEventListener('click', () => {
                    // Remove active class from all contacts
                    document.querySelectorAll('.contact-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked contact
                    studentItem.classList.add('active');
                    
                    // Set active chat
                    currentChatStudent = student;
                    currentChatTeacher = null;
                    currentChatGroup = null;
                    
                    // Update UI for mobile
                    if (window.innerWidth <= 768) {
                        sidebar.style.display = 'none';
                        chatArea.style.display = 'flex';
                    }
                    
                    // Update chat header
                    currentChatName.textContent = student.name || 'Student';
                    currentChatStatus.textContent = 'Online';
                    
                    // Show chat elements, hide welcome screen
                    welcomeScreen.style.display = 'none';
                    activeChatHeader.style.display = 'flex';
                    chatMessages.style.display = 'flex';
                    chatInput.style.display = 'flex';
                    
                    // Load chat messages
                    loadChatMessages('student', student.id);
                });
                
                studentsList.appendChild(studentItem);
            });
        }
        
        // Load other teachers
        function loadOtherTeachers() {
            teachersList.innerHTML = '';
            
            // Filter out current teacher
            const otherTeachers = [];
            
            for (const teacherId in teachersData) {
                if (teacherId !== currentTeacherId) {
                    otherTeachers.push({
                        id: teacherId,
                        ...teachersData[teacherId]
                    });
                }
            }
            
            if (otherTeachers.length === 0) {
                teachersList.innerHTML = '<div class="contact-item">No other teachers found</div>';
                return;
            }
            
            // Display other teachers
            otherTeachers.forEach(teacher => {
                const teacherItem = document.createElement('div');
                teacherItem.className = 'contact-item';
                teacherItem.dataset.id = teacher.id;
                teacherItem.dataset.type = 'teacher';
                
                teacherItem.innerHTML = `
                    <div class="contact-avatar">
                        ${teacher.name ? teacher.name.charAt(0) : 'T'}
                        <div class="online-dot"></div>
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${teacher.name || 'Teacher'}</div>
                        <div class="contact-preview">Tap to start chatting</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">Now</div>
                    </div>
                `;
                
                teacherItem.addEventListener('click', () => {
                    // Remove active class from all contacts
                    document.querySelectorAll('.contact-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked contact
                    teacherItem.classList.add('active');
                    
                    // Set active chat
                    currentChatTeacher = teacher;
                    currentChatStudent = null;
                    currentChatGroup = null;
                    
                    // Update UI for mobile
                    if (window.innerWidth <= 768) {
                        sidebar.style.display = 'none';
                        chatArea.style.display = 'flex';
                    }
                    
                    // Update chat header
                    currentChatName.textContent = teacher.name || 'Teacher';
                    currentChatStatus.textContent = 'Online';
                    
                    // Show chat elements, hide welcome screen
                    welcomeScreen.style.display = 'none';
                    activeChatHeader.style.display = 'flex';
                    chatMessages.style.display = 'flex';
                    chatInput.style.display = 'flex';
                    
                    // Load chat messages
                    loadChatMessages('teacher', teacher.id);
                });
                
                teachersList.appendChild(teacherItem);
            });
        }
        
        // Load subject groups
        function loadSubjectGroups() {
            subjectGroupsList.innerHTML = '';
            
            // Find subjects assigned to this teacher
            const teacherSubjects = [];
            
            for (const subjectId in subjectsData) {
                const subject = subjectsData[subjectId];
                
                // Check if this teacher is assigned to this subject
                if (subject.assignments && subject.assignments[currentTeacherId]) {
                    teacherSubjects.push({
                        id: subjectId,
                        ...subject
                    });
                }
            }
            
            if (teacherSubjects.length === 0) {
                subjectGroupsList.innerHTML = '<div class="contact-item">No subject groups found</div>';
                return;
            }
            
            // Display subject groups as contact items
            teacherSubjects.forEach(subject => {
                const groupItem = document.createElement('div');
                groupItem.className = 'contact-item';
                groupItem.dataset.id = subject.id;
                groupItem.dataset.type = 'group';
                
                // Get class info
                let classInfo = 'Multiple classes';
                if (subject.assignments[currentTeacherId]) {
                    if (Array.isArray(subject.assignments[currentTeacherId])) {
                        classInfo = `${subject.assignments[currentTeacherId].length} classes`;
                    } else if (subject.assignments[currentTeacherId].classId) {
                        const classId = subject.assignments[currentTeacherId].classId;
                        classInfo = classesData[classId]?.name || `Class ${classId}`;
                    }
                }
                
                groupItem.innerHTML = `
                    <div class="contact-avatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${subject.name}</div>
                        <div class="contact-preview">${classInfo}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">Now</div>
                    </div>
                `;
                
                groupItem.addEventListener('click', () => {
                    // Remove active class from all contacts
                    document.querySelectorAll('.contact-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked contact
                    groupItem.classList.add('active');
                    
                    // Set active group chat
                    currentChatGroup = subject;
                    currentChatStudent = null;
                    currentChatTeacher = null;
                    
                    // Update UI for mobile
                    if (window.innerWidth <= 768) {
                        sidebar.style.display = 'none';
                        chatArea.style.display = 'flex';
                    }
                    
                    // Update chat header
                    currentChatName.textContent = subject.name;
                    currentChatStatus.textContent = 'Group';
                    
                    // Show chat elements, hide welcome screen
                    welcomeScreen.style.display = 'none';
                    activeChatHeader.style.display = 'flex';
                    chatMessages.style.display = 'flex';
                    chatInput.style.display = 'flex';
                    
                    // Load group messages
                    loadChatMessages('group', subject.id);
                });
                
                subjectGroupsList.appendChild(groupItem);
            });
        }
        
        // Load chat messages
        function loadChatMessages(type, id) {
            // Clear previous messages
            chatMessages.innerHTML = '';
            
            // Remove any existing message listeners
            for (const path in messageListeners) {
                database.ref(path).off('value', messageListeners[path]);
            }
            messageListeners = {};
            
            let path;
            
            if (type === 'student') {
                path = `chats/teachers/${currentTeacherId}/students/${id}`;
            } else if (type === 'teacher') {
                path = `chats/teachers/${currentTeacherId}/teachers/${id}`;
            } else if (type === 'group') {
                path = `chats/groups/${id}`;
            }
            
            // Listen for messages
            const messageListener = database.ref(path).on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                chatMessages.innerHTML = '';
                
                // Convert to array and sort by timestamp
                const messagesArray = Object.entries(messages).map(([key, value]) => ({
                    id: key,
                    ...value
                }));
                
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                // Display messages
                messagesArray.forEach(message => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${message.senderId === currentTeacherId ? 'sent' : 'received'}`;
                    
                    const senderName = message.senderId === currentTeacherId 
                        ? 'You' 
                        : (type === 'student' ? currentChatStudent.name 
                            : type === 'teacher' ? currentChatTeacher.name 
                            : message.senderName || 'Unknown');
                    
                    const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    messageEl.innerHTML = `
                        ${type !== 'student' && message.senderId !== currentTeacherId ? 
                            `<div class="message-sender">${senderName}</div>` : ''}
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${time}</div>
                    `;
                    
                    chatMessages.appendChild(messageEl);
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
            
            // Store the listener reference
            messageListeners[path] = messageListener;
        }
        
        // Send message
        function sendMessage() {
            if (!messageInput.value.trim()) return;
            
            let path, messageData;
            
            if (currentChatStudent) {
                path = `chats/teachers/${currentTeacherId}/students/${currentChatStudent.id}`;
                messageData = {
                    text: messageInput.value,
                    senderId: currentTeacherId,
                    senderName: currentTeacherData.name,
                    timestamp: Date.now()
                };
            } else if (currentChatTeacher) {
                path = `chats/teachers/${currentTeacherId}/teachers/${currentChatTeacher.id}`;
                messageData = {
                    text: messageInput.value,
                    senderId: currentTeacherId,
                    senderName: currentTeacherData.name,
                    timestamp: Date.now()
                };
            } else if (currentChatGroup) {
                path = `chats/groups/${currentChatGroup.id}`;
                messageData = {
                    text: messageInput.value,
                    senderId: currentTeacherId,
                    senderName: currentTeacherData.name,
                    timestamp: Date.now()
                };
            } else {
                return;
            }
            
            // Push message to database
            database.ref(path).push(messageData)
                .then(() => {
                    // Clear input
                    messageInput.value = '';
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    showNotification({
                        title: 'Error',
                        message: 'Failed to send message',
                        type: 'error'
                    });
                });
        }
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Update active tab
                activeTab = tab.dataset.tab;
                
                // Show corresponding content
                if (activeTab === 'students') {
                    studentsList.style.display = 'block';
                    teachersList.style.display = 'none';
                    subjectGroupsList.style.display = 'none';
                } else if (activeTab === 'teachers') {
                    studentsList.style.display = 'none';
                    teachersList.style.display = 'block';
                    subjectGroupsList.style.display = 'none';
                } else if (activeTab === 'subject-groups') {
                    studentsList.style.display = 'none';
                    teachersList.style.display = 'none';
                    subjectGroupsList.style.display = 'block';
                }
            });
        });
        
        // Back button for mobile view
        backButton.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                sidebar.style.display = 'flex';
                chatArea.style.display = 'none';
            }
        });
        
        // Event listeners
        logoutBtn.addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    window.location.href = 'logins.html';
                })
                .catch(error => {
                    console.error('Error signing out:', error);
                    showNotification({
                        title: 'Error',
                        message: 'Failed to sign out',
                        type: 'error'
                    });
                });
        });
        
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach(item => {
                const name = item.querySelector('.contact-name').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Initialize the app - check for active session
        loadingScreen.style.display = 'flex';
        mainContent.style.display = 'none';
        checkActiveSession();
    </script>
</body>
</html>
