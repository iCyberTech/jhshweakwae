<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Communication Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --text-color: #2d3436;
            --light-text: #636e72;
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            --success-color: #00b894;
            --danger-color: #d63031;
            --warning-color: #fdcb6e;
            --info-color: #0984e3;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-color);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px;
            border-radius: 12px;
            position: relative;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
        }

        .message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.8);
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.8;
            text-align: right;
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: rgba(255, 255, 255, 0.8);
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
        }

        .send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .contacts-list {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            max-height: 500px;
            overflow-y: auto;
        }

        .contact-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.3s ease;
        }

        .contact-item:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .contact-role {
            font-size: 0.8rem;
            color: var(--light-text);
        }

        .group-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .group-item {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .group-item:hover {
            transform: translateY(-5px);
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .group-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .group-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .group-members {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--text-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-container {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 90%;
            max-width: 350px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            padding: 18px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-left: 5px solid rgba(255, 255, 255, 0.3);
            align-items: flex-start;
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.9) 0%, rgba(0, 184, 148, 1) 100%);
            color: white;
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(214, 48, 49, 0.9) 0%, rgba(214, 48, 49, 1) 100%);
            color: white;
        }

        .notification.info {
            background: linear-gradient(135deg, rgba(9, 132, 227, 0.9) 0%, rgba(9, 132, 227, 1) 100%);
            color: white;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .chat-container {
                height: 400px;
            }
            
            .group-list {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 90%;
            }
            
            .chat-input {
                flex-direction: column;
            }
            
            .send-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Communication Portal...</div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 class="page-title">Teacher Communication Portal</h1>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">T</div>
                    <div>
                        <div id="user-name">Teacher Name</div>
                        <div id="user-email">teacher@school.com</div>
                    </div>
                    <button class="logout-btn" id="logout-btn">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="students">Students</div>
                <div class="tab" data-tab="teachers">Teachers</div>
                <div class="tab" data-tab="subject-groups">Subject Groups</div>
            </div>

            <div class="tab-content active" id="students-tab">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <h2 style="margin-bottom: 15px;">Your Students</h2>
                        <div class="contacts-list" id="students-list">
                            <!-- Students will be populated here -->
                        </div>
                    </div>
                    <div style="flex: 2; min-width: 300px;">
                        <div class="chat-container">
                            <div class="chat-header">
                                <div id="current-chat-name">Select a student to chat</div>
                            </div>
                            <div class="chat-messages" id="chat-messages">
                                <!-- Messages will appear here -->
                            </div>
                            <div class="chat-input">
                                <input type="text" id="message-input" placeholder="Type your message..." disabled>
                                <button class="send-btn" id="send-btn" disabled>Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="teachers-tab">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <h2 style="margin-bottom: 15px;">Other Teachers</h2>
                        <div class="contacts-list" id="teachers-list">
                            <!-- Teachers will be populated here -->
                        </div>
                    </div>
                    <div style="flex: 2; min-width: 300px;">
                        <div class="chat-container">
                            <div class="chat-header">
                                <div id="current-teacher-chat-name">Select a teacher to chat</div>
                            </div>
                            <div class="chat-messages" id="teacher-chat-messages">
                                <!-- Messages will appear here -->
                            </div>
                            <div class="chat-input">
                                <input type="text" id="teacher-message-input" placeholder="Type your message..." disabled>
                                <button class="send-btn" id="teacher-send-btn" disabled>Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="subject-groups-tab">
                <h2 style="margin-bottom: 15px;">Your Subject Groups</h2>
                <div class="group-list" id="subject-groups-list">
                    <!-- Subject groups will be populated here -->
                </div>
                
                <div id="group-chat-container" style="display: none; margin-top: 20px;">
                    <div class="chat-container">
                        <div class="chat-header">
                            <div id="current-group-chat-name">Select a group to chat</div>
                        </div>
                        <div class="chat-messages" id="group-chat-messages">
                            <!-- Group messages will appear here -->
                        </div>
                        <div class="chat-input">
                            <input type="text" id="group-message-input" placeholder="Type your message..." disabled>
                            <button class="send-btn" id="group-send-btn" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
         const firebaseConfig = {
    apiKey: "AIzaSyB5NcC2P3v0LFBVFMp9-mAHQKYuo1pKokA",
    authDomain: "hweakwaecram.firebaseapp.com",
    projectId: "hweakwaecram",
    storageBucket: "hweakwaecram.firebasestorage.app",
    messagingSenderId: "1012181976581",
    appId: "1:1012181976581:web:eee0ad07650b360bc8fe6c",
    measurementId: "G-4GMZJJRVG0"
  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const notificationContainer = document.getElementById('notification-container');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Chat elements
        const studentsList = document.getElementById('students-list');
        const teachersList = document.getElementById('teachers-list');
        const subjectGroupsList = document.getElementById('subject-groups-list');
        const chatMessages = document.getElementById('chat-messages');
        const teacherChatMessages = document.getElementById('teacher-chat-messages');
        const groupChatMessages = document.getElementById('group-chat-messages');
        const messageInput = document.getElementById('message-input');
        const teacherMessageInput = document.getElementById('teacher-message-input');
        const groupMessageInput = document.getElementById('group-message-input');
        const sendBtn = document.getElementById('send-btn');
        const teacherSendBtn = document.getElementById('teacher-send-btn');
        const groupSendBtn = document.getElementById('group-send-btn');
        const currentChatName = document.getElementById('current-chat-name');
        const currentTeacherChatName = document.getElementById('current-teacher-chat-name');
        const currentGroupChatName = document.getElementById('current-group-chat-name');
        const groupChatContainer = document.getElementById('group-chat-container');
        
        // Global variables
        let currentTeacherId = null;
        let currentTeacherData = null;
        let currentChatStudent = null;
        let currentChatTeacher = null;
        let currentChatGroup = null;
        let studentsData = {};
        let teachersData = {};
        let subjectsData = {};
        let classesData = {};
        
        // Show notification function
        function showNotification({ title, message, type = 'info', duration = 5000 }) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas fa-${iconMap[type]} notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Trigger reflow to enable animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto-dismiss after duration
            let timeoutId;
            if (duration > 0) {
                timeoutId = setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.add('hide');
                    
                    // Remove after animation completes
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
            
            // Close button handler
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                clearTimeout(timeoutId);
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            });
            
            return notification;
        }
        
        // Identify the current teacher based on Firebase Auth
        async function identifyCurrentTeacher() {
            return new Promise((resolve, reject) => {
                // Check if user is already signed in
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            // User is signed in, get their data from authUsers
                            const authUserSnapshot = await database.ref(`authUsers/${user.uid}`).once('value');
                            
                            if (authUserSnapshot.exists()) {
                                const authUser = authUserSnapshot.val();
                                
                                if (authUser.userType === 'teacher') {
                                    currentTeacherId = authUser.userId;
                                    
                                    // Get teacher details from teachers collection
                                    const teacherSnapshot = await database.ref(`teachers/${currentTeacherId}`).once('value');
                                    
                                    if (teacherSnapshot.exists()) {
                                        currentTeacherData = teacherSnapshot.val();
                                        unsubscribe();
                                        resolve(currentTeacherData);
                                        return;
                                    }
                                }
                            }
                            
                            // If we reach here, the auth user doesn't have proper teacher data
                            unsubscribe();
                            reject(new Error('Teacher data not found for authenticated user'));
                        } catch (error) {
                            unsubscribe();
                            reject(error);
                        }
                    } else {
                        // No user is signed in
                        unsubscribe();
                        reject(new Error('No user is currently signed in'));
                    }
                }, (error) => {
                    unsubscribe();
                    reject(error);
                });
            });
        }
        
        // Check for active teacher session
        async function checkActiveSession() {
            try {
                // First try to identify the teacher based on auth state
                const teacher = await identifyCurrentTeacher();
                
                if (teacher) {
                    // Update UI with teacher info
                    userAvatar.textContent = teacher.name ? teacher.name.charAt(0) : 'T';
                    userName.textContent = teacher.name || 'Teacher';
                    userEmail.textContent = teacher.email || 'teacher@school.com';
                    
                    // Load teacher's data
                    loadTeacherData();
                    
                    // Hide loading screen and show main content
                    loadingScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    showNotification({
                        title: 'Welcome!',
                        message: 'Communication portal loaded successfully',
                        type: 'success',
                        duration: 3000
                    });
                    
                    return;
                }
                
                // If no teacher identified
                showNotification({
                    title: 'Session Expired',
                    message: 'Please sign in again',
                    type: 'error',
                    duration: 0
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'logins.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error checking active session:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to load teacher information',
                    type: 'error'
                });
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'logins.html';
                }, 2000);
            }
        }
        
        // Load teacher's students, colleagues, and subject groups
        async function loadTeacherData() {
            try {
                // Load all necessary data
                const [studentsSnapshot, teachersSnapshot, subjectsSnapshot, classesSnapshot] = await Promise.all([
                    database.ref('students').once('value'),
                    database.ref('teachers').once('value'),
                    database.ref('subjects').once('value'),
                    database.ref('classes').once('value')
                ]);
                
                // Store data in global variables
                studentsData = studentsSnapshot.val() || {};
                teachersData = teachersSnapshot.val() || {};
                subjectsData = subjectsSnapshot.val() || {};
                classesData = classesSnapshot.val() || {};
                
                // Load teacher's students
                loadTeacherStudents();
                
                // Load other teachers
                loadOtherTeachers();
                
                // Load subject groups
                loadSubjectGroups();
                
            } catch (error) {
                console.error('Error loading teacher data:', error);
                showNotification({
                    title: 'Error',
                    message: 'Failed to load communication data',
                    type: 'error'
                });
            }
        }
        
        // Load teacher's students
        function loadTeacherStudents() {
            studentsList.innerHTML = '';
            
            // Find students assigned to this teacher through subjects
            const teacherStudents = [];
            
            for (const subjectId in subjectsData) {
                const subject = subjectsData[subjectId];
                
                // Check if this teacher is assigned to this subject
                if (subject.assignments && subject.assignments[currentTeacherId]) {
                    // Get class IDs from assignments
                    let classIds = [];
                    
                    if (Array.isArray(subject.assignments[currentTeacherId])) {
                        classIds = subject.assignments[currentTeacherId].map(a => a.classId);
                    } else if (subject.assignments[currentTeacherId].classId) {
                        classIds = [subject.assignments[currentTeacherId].classId];
                    }
                    
                    // Find students in these classes
                    for (const studentId in studentsData) {
                        const student = studentsData[studentId];
                        
                        if (classIds.includes(student.classId)) {
                            // Avoid duplicates
                            if (!teacherStudents.find(s => s.id === studentId)) {
                                teacherStudents.push({
                                    id: studentId,
                                    ...student
                                });
                            }
                        }
                    }
                }
            }
            
            if (teacherStudents.length === 0) {
                studentsList.innerHTML = '<div class="contact-item">No students found</div>';
                return;
            }
            
            // Display students
            teacherStudents.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'contact-item';
                studentItem.dataset.id = student.id;
                
                studentItem.innerHTML = `
                    <div class="contact-avatar">${student.name ? student.name.charAt(0) : 'S'}</div>
                    <div class="contact-info">
                        <div class="contact-name">${student.name || 'Student'}</div>
                        <div class="contact-role">Student</div>
                    </div>
                `;
                
                studentItem.addEventListener('click', () => {
                    // Set active chat
                    currentChatStudent = student;
                    currentChatTeacher = null;
                    currentChatGroup = null;
                    
                    // Update UI
                    currentChatName.textContent = `Chat with ${student.name}`;
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    
                    // Load chat messages
                    loadChatMessages('student', student.id);
                });
                
                studentsList.appendChild(studentItem);
            });
        }
        
        // Load other teachers
        function loadOtherTeachers() {
            teachersList.innerHTML = '';
            
            // Filter out current teacher
            const otherTeachers = [];
            
            for (const teacherId in teachersData) {
                if (teacherId !== currentTeacherId) {
                    otherTeachers.push({
                        id: teacherId,
                        ...teachersData[teacherId]
                    });
                }
            }
            
            if (otherTeachers.length === 0) {
                teachersList.innerHTML = '<div class="contact-item">No other teachers found</div>';
                return;
            }
            
            // Display other teachers
            otherTeachers.forEach(teacher => {
                const teacherItem = document.createElement('div');
                teacherItem.className = 'contact-item';
                teacherItem.dataset.id = teacher.id;
                
                teacherItem.innerHTML = `
                    <div class="contact-avatar">${teacher.name ? teacher.name.charAt(0) : 'T'}</div>
                    <div class="contact-info">
                        <div class="contact-name">${teacher.name || 'Teacher'}</div>
                        <div class="contact-role">Teacher</div>
                    </div>
                `;
                
                teacherItem.addEventListener('click', () => {
                    // Set active chat
                    currentChatTeacher = teacher;
                    currentChatStudent = null;
                    currentChatGroup = null;
                    
                    // Update UI
                    currentTeacherChatName.textContent = `Chat with ${teacher.name}`;
                    teacherMessageInput.disabled = false;
                    teacherSendBtn.disabled = false;
                    
                    // Load chat messages
                    loadChatMessages('teacher', teacher.id);
                });
                
                teachersList.appendChild(teacherItem);
            });
        }
        
        // Load subject groups
        function loadSubjectGroups() {
            subjectGroupsList.innerHTML = '';
            
            // Find subjects assigned to this teacher
            const teacherSubjects = [];
            
            for (const subjectId in subjectsData) {
                const subject = subjectsData[subjectId];
                
                // Check if this teacher is assigned to this subject
                if (subject.assignments && subject.assignments[currentTeacherId]) {
                    teacherSubjects.push({
                        id: subjectId,
                        ...subject
                    });
                }
            }
            
            if (teacherSubjects.length === 0) {
                subjectGroupsList.innerHTML = '<div class="group-item">No subject groups found</div>';
                return;
            }
            
            // Display subject groups
            teacherSubjects.forEach(subject => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.dataset.id = subject.id;
                
                // Get class info
                let classInfo = 'Multiple classes';
                if (subject.assignments[currentTeacherId]) {
                    if (Array.isArray(subject.assignments[currentTeacherId])) {
                        classInfo = `${subject.assignments[currentTeacherId].length} classes`;
                    } else if (subject.assignments[currentTeacherId].classId) {
                        const classId = subject.assignments[currentTeacherId].classId;
                        classInfo = classesData[classId]?.name || `Class ${classId}`;
                    }
                }
                
                groupItem.innerHTML = `
                    <div class="group-header">
                        <div class="group-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div>
                            <div class="group-name">${subject.name}</div>
                            <div class="group-members">${classInfo}</div>
                        </div>
                    </div>
                `;
                
                groupItem.addEventListener('click', () => {
                    // Set active group chat
                    currentChatGroup = subject;
                    currentChatStudent = null;
                    currentChatTeacher = null;
                    
                    // Show group chat container
                    groupChatContainer.style.display = 'block';
                    
                    // Update UI
                    currentGroupChatName.textContent = `Group: ${subject.name}`;
                    groupMessageInput.disabled = false;
                    groupSendBtn.disabled = false;
                    
                    // Load group messages
                    loadChatMessages('group', subject.id);
                });
                
                subjectGroupsList.appendChild(groupItem);
            });
        }
        
        // Load chat messages
        function loadChatMessages(type, id) {
            let messagesContainer;
            let path;
            
            if (type === 'student') {
                messagesContainer = chatMessages;
                path = `chats/teachers/${currentTeacherId}/students/${id}`;
            } else if (type === 'teacher') {
                messagesContainer = teacherChatMessages;
                path = `chats/teachers/${currentTeacherId}/teachers/${id}`;
            } else if (type === 'group') {
                messagesContainer = groupChatMessages;
                path = `chats/groups/${id}`;
            }
            
            // Clear previous messages
            messagesContainer.innerHTML = '';
            
            // Listen for messages
            database.ref(path).on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                messagesContainer.innerHTML = '';
                
                // Convert to array and sort by timestamp
                const messagesArray = Object.entries(messages).map(([key, value]) => ({
                    id: key,
                    ...value
                }));
                
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                // Display messages
                messagesArray.forEach(message => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${message.senderId === currentTeacherId ? 'sent' : 'received'}`;
                    
                    const senderName = message.senderId === currentTeacherId 
                        ? 'You' 
                        : (type === 'student' ? currentChatStudent.name 
                            : type === 'teacher' ? currentChatTeacher.name 
                            : message.senderName || 'Unknown');
                    
                    const time = new Date(message.timestamp).toLocaleTimeString();
                    
                    messageEl.innerHTML = `
                        <div class="message-sender">${senderName}</div>
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${time}</div>
                    `;
                    
                    messagesContainer.appendChild(messageEl);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }
        
        // Send message
        function sendMessage(type) {
            let input, path, messageData;
            
            if (type === 'student') {
                if (!currentChatStudent) return;
                
                input = messageInput;
                path = `chats/teachers/${currentTeacherId}/students/${currentChatStudent.id}`;
                messageData = {
                    text: input.value,
                    senderId: currentTeacherId,
                    senderName: currentTeacherData.name,
                    timestamp: Date.now()
                };
            } else if (type === 'teacher') {
                if (!currentChatTeacher) return;
                
                input = teacherMessageInput;
                path = `chats/teachers/${currentTeacherId}/teachers/${currentChatTeacher.id}`;
                messageData = {
                    text: input.value,
                    senderId: currentTeacherId,
                    senderName: currentTeacherData.name,
                    timestamp: Date.now()
                };
            } else if (type === 'group') {
                if (!currentChatGroup) return;
                
                input = groupMessageInput;
                path = `chats/groups/${currentChatGroup.id}`;
                messageData = {
                    text: input.value,
                    senderId: currentTeacherId,
                    senderName: currentTeacherData.name,
                    timestamp: Date.now()
                };
            }
            
            // Push message to database
            database.ref(path).push(messageData)
                .then(() => {
                    // Clear input
                    input.value = '';
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    showNotification({
                        title: 'Error',
                        message: 'Failed to send message',
                        type: 'error'
                    });
                });
        }
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const tabId = `${tab.dataset.tab}-tab`;
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Event listeners
        logoutBtn.addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    window.location.href = 'logins.html';
                })
                .catch(error => {
                    console.error('Error signing out:', error);
                    showNotification({
                        title: 'Error',
                        message: 'Failed to sign out',
                        type: 'error'
                    });
                });
        });
        
        sendBtn.addEventListener('click', () => sendMessage('student'));
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage('student');
        });
        
        teacherSendBtn.addEventListener('click', () => sendMessage('teacher'));
        teacherMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage('teacher');
        });
        
        groupSendBtn.addEventListener('click', () => sendMessage('group'));
        groupMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage('group');
        });
        
        // Initialize the app - check for active session
        loadingScreen.style.display = 'flex';
        mainContent.style.display = 'none';
        checkActiveSession();
    </script>
</body>
</html>
